#  plot a sparse matrix data set generated by Biodiverse as a correlogram

plot_correlogram = function (data, fld='Value', modifier = 1, max_dist=0, lag=1, xlab) {
    if (max_dist) {
        data2 = subset (data, distance < max_dist)
    } else {
        data2 = data
    }
    lag_vector = floor (data2$distance / lag) / modifier * lag + lag / 2
    boxplot(data2[[fld]] ~ lag_vector, xlab='distance')
}

plot_correlogram_dir = function (data,
                                 start=0,
                                 end=pi,
                                 incr=pi/18,
                                 wedge_width=pi/18,
                                 modifier = 1,
                                 max_dist=0,
                                 lag=1,
                                 fld='Value',
                                 ...) {
    data = data
    modifier = modifier
    max_dist = max_dist
    lag = lag
    for (i in seq(start, end, incr)) {
        data2 = subset_by_dir (data, wedge_angle=i, wedge_width=wedge_width)
        plot_correlogram (data2, fld=fld, modifier=modifier, max_dist=max_dist, lag=lag)
        deg   = formatC(radians2degrees (i))
        deg_r = formatC(radians2degrees (i+pi))  #  rotated 180
        title = paste (deg, '/', deg_r, sep=' ')
        title (title)
    }
}

subset_by_dir = function (data, dirfld='direction', wedge_angle=0, wedge_width=pi/18) {
    w = wedge_width / 2
    min_angle1 = wedge_angle - w  
    max_angle1 = wedge_angle + w
    min_angle2 = min_angle1 + pi   #  Allow for round-the-circle in either direction.
    max_angle2 = max_angle1 + pi   #  Surely this can be done better?
    min_angle3 = min_angle1 - pi
    max_angle3 = max_angle1 - pi
    
    return (
        subset (data,
               (min_angle1 <= data[[dirfld]] & data[[dirfld]] <= max_angle1)
             | (min_angle2 <= data[[dirfld]] & data[[dirfld]] <= max_angle2)
             | (min_angle3 <= data[[dirfld]] & data[[dirfld]] <= max_angle3)
             )
    )
}

radians2degrees = function (angle) {
    a = angle %% (2 * pi)              #  snap to interval [0,2PI]
    a = 1.25 - (a / (2 * pi))      #  invert and rotate
    a = a %% 1                     #  snap to unit interval
    a = 360 * a
    return (a)
}
