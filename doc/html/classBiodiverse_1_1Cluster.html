<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Biodiverse: Biodiverse::Cluster Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Biodiverse
   &#160;<span id="projectnumber">0.19</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('classBiodiverse_1_1Cluster.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="classBiodiverse_1_1Cluster-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">Biodiverse::Cluster Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Collaboration diagram for Biodiverse::Cluster:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="classBiodiverse_1_1Cluster__coll__graph.png" border="0" usemap="#Biodiverse_1_1Cluster_coll__map" alt="Collaboration graph"/></div>
<map name="Biodiverse_1_1Cluster_coll__map" id="Biodiverse_1_1Cluster_coll__map">
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:a1d5cb527e438014117cbda757a0149dd"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1d5cb527e438014117cbda757a0149dd"></a>
hash&#160;</td><td class="memItemRight" valign="bottom"><b>PARAMS</b></td></tr>
<tr class="separator:a1d5cb527e438014117cbda757a0149dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab552b739cf00dad2a9aad03168bf6933"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab552b739cf00dad2a9aad03168bf6933"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>EMPTY_STRING</b></td></tr>
<tr class="separator:ab552b739cf00dad2a9aad03168bf6933"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a14c87cef228772e781fdc204ac95ecae"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a14c87cef228772e781fdc204ac95ecae"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>mx_class_default</b></td></tr>
<tr class="separator:a14c87cef228772e781fdc204ac95ecae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a03be6b297e5076ee7113461197274f6e"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a03be6b297e5076ee7113461197274f6e"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>mx_class_lowmem</b></td></tr>
<tr class="separator:a03be6b297e5076ee7113461197274f6e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62410f0e0575a8b065a1af28c837cc75"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a62410f0e0575a8b065a1af28c837cc75"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>spatial_params_array</b></td></tr>
<tr class="separator:a62410f0e0575a8b065a1af28c837cc75"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3087babb6a120f8d3d85f9e6d66df80b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a3087babb6a120f8d3d85f9e6d66df80b"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>i</b></td></tr>
<tr class="separator:a3087babb6a120f8d3d85f9e6d66df80b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae3bb206e631b93bea16f5264f70409d4"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae3bb206e631b93bea16f5264f70409d4"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>definition_query</b></td></tr>
<tr class="separator:ae3bb206e631b93bea16f5264f70409d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a395f45a549daaeafa0b691f6e5e4bad2"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a395f45a549daaeafa0b691f6e5e4bad2"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>element_check</b></td></tr>
<tr class="separator:a395f45a549daaeafa0b691f6e5e4bad2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a36ad37bbabaf88f7a5075153cd7c3fcc"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a36ad37bbabaf88f7a5075153cd7c3fcc"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>analysis_args</b></td></tr>
<tr class="separator:a36ad37bbabaf88f7a5075153cd7c3fcc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab043ce7b52f47d673197fe2f6e304103"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab043ce7b52f47d673197fe2f6e304103"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>linkage_function</b></td></tr>
<tr class="separator:ab043ce7b52f47d673197fe2f6e304103"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a90fa6185cfde744f63438b81eab823de"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a90fa6185cfde744f63438b81eab823de"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>time_taken</b></td></tr>
<tr class="separator:a90fa6185cfde744f63438b81eab823de"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a810add309f78c605d223662f35755f69"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a810add309f78c605d223662f35755f69"></a>
hash&#160;</td><td class="memItemRight" valign="bottom"><b>root_nodes</b></td></tr>
<tr class="separator:a810add309f78c605d223662f35755f69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a42434ca7fe40a869e970eb5319ae4965"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a42434ca7fe40a869e970eb5319ae4965"></a>
list&#160;</td><td class="memItemRight" valign="bottom"><b>now_empty</b></td></tr>
<tr class="separator:a42434ca7fe40a869e970eb5319ae4965"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a259e67047dfeaab43074dcdb1920b37a"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a259e67047dfeaab43074dcdb1920b37a"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>root_node_name</b></td></tr>
<tr class="separator:a259e67047dfeaab43074dcdb1920b37a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abcba7754be3ea17ba0cd58ecbd8dba1f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="abcba7754be3ea17ba0cd58ecbd8dba1f"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>root_node</b></td></tr>
<tr class="separator:abcba7754be3ea17ba0cd58ecbd8dba1f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1f69679fc75f84bd4c7f228b99fac2a8"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1f69679fc75f84bd4c7f228b99fac2a8"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>tot_length</b></td></tr>
<tr class="separator:a1f69679fc75f84bd4c7f228b99fac2a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="member-group"></a>
Avaliable Methods</h2></td></tr>
<tr class="memitem:a5bd9d3662c707446506e311528ff12a8"><td class="memItemLeft" align="right" valign="top">private method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a5bd9d3662c707446506e311528ff12a8">_link_centroid</a> ()</td></tr>
<tr class="separator:a5bd9d3662c707446506e311528ff12a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a06a62561a0955625346773c5fa75e559"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a06a62561a0955625346773c5fa75e559">run_indices_object_cleanup</a> ()</td></tr>
<tr class="separator:a06a62561a0955625346773c5fa75e559"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a28d1d5d102d2b94e7046a200be46b2f7"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a28d1d5d102d2b94e7046a200be46b2f7">delete_shadow_matrix</a> ()</td></tr>
<tr class="separator:a28d1d5d102d2b94e7046a200be46b2f7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1377cbf109ffd5682c5a5e1c10639856"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a1377cbf109ffd5682c5a5e1c10639856">max</a> ()</td></tr>
<tr class="separator:a1377cbf109ffd5682c5a5e1c10639856"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acbda77c1adfa4b15fcd85dfc7415f76c"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#acbda77c1adfa4b15fcd85dfc7415f76c">get_prng_seed_argument</a> ()</td></tr>
<tr class="separator:acbda77c1adfa4b15fcd85dfc7415f76c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae48edaa30a7e286b2161b2bdfbdadbde"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#ae48edaa30a7e286b2161b2bdfbdadbde">link_maximum</a> ()</td></tr>
<tr class="separator:ae48edaa30a7e286b2161b2bdfbdadbde"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2bb52212452068d95e51430714ba1d91"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a2bb52212452068d95e51430714ba1d91">run_tiebreaker_indices_object_cleanup</a> ()</td></tr>
<tr class="separator:a2bb52212452068d95e51430714ba1d91"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a09ff674367d54f8de070975ed0275743"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a09ff674367d54f8de070975ed0275743">join_root_nodes</a> ()</td></tr>
<tr class="separator:a09ff674367d54f8de070975ed0275743"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a42b2b696be4028c9f19cbda36b438287"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a42b2b696be4028c9f19cbda36b438287">get_default_cluster_index</a> ()</td></tr>
<tr class="separator:a42b2b696be4028c9f19cbda36b438287"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2b83d5b727007b538fe40695d67d5570"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a2b83d5b727007b538fe40695d67d5570">infer_if_already_calculated</a> ()</td></tr>
<tr class="separator:a2b83d5b727007b538fe40695d67d5570"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a616c1ec461fc3bc3bce0b70d72638e47"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a616c1ec461fc3bc3bce0b70d72638e47">run_spatial_calculations</a> ()</td></tr>
<tr class="separator:a616c1ec461fc3bc3bce0b70d72638e47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a21eb2e3f7932148b6b879025a9738dd1"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a21eb2e3f7932148b6b879025a9738dd1">link_recalculate</a> ()</td></tr>
<tr class="separator:a21eb2e3f7932148b6b879025a9738dd1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd828218b23c48a42af330d692ed0bb8"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#acd828218b23c48a42af330d692ed0bb8">get_embedded_tree</a> ()</td></tr>
<tr class="separator:acd828218b23c48a42af330d692ed0bb8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac6b8dfd5a17467740e4235e8adc44e39"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#ac6b8dfd5a17467740e4235e8adc44e39">set_matrix_ref</a> ()</td></tr>
<tr class="separator:ac6b8dfd5a17467740e4235e8adc44e39"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9be78017f59d327ca21e496c96aa57df"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a9be78017f59d327ca21e496c96aa57df">override_cached_spatial_calculations_arg</a> ()</td></tr>
<tr class="separator:a9be78017f59d327ca21e496c96aa57df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afead06ea4e49acda27117473fc989b84"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#afead06ea4e49acda27117473fc989b84">get_indices_object_for_matrix_and_clustering</a> ()</td></tr>
<tr class="separator:afead06ea4e49acda27117473fc989b84"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad3d1d664c30ec4452cdb9878975cb017"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#ad3d1d664c30ec4452cdb9878975cb017">add_matrices_to_basedata</a> ()</td></tr>
<tr class="separator:ad3d1d664c30ec4452cdb9878975cb017"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4b112a16a0defc03eac9723a83ea5807"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a4b112a16a0defc03eac9723a83ea5807">link_minimum</a> ()</td></tr>
<tr class="separator:a4b112a16a0defc03eac9723a83ea5807"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8cc2ddea793a40b47559f3eda78870a3"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a8cc2ddea793a40b47559f3eda78870a3">export_matrices</a> ()</td></tr>
<tr class="separator:a8cc2ddea793a40b47559f3eda78870a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3a7f5944a6b7ed3fe5ddf84a779877d2"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a3a7f5944a6b7ed3fe5ddf84a779877d2">get_type</a> ()</td></tr>
<tr class="separator:a3a7f5944a6b7ed3fe5ddf84a779877d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a39ed1a135de5dc9eac67061ad5f7c00b"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a39ed1a135de5dc9eac67061ad5f7c00b">run_tie_breaker</a> ()</td></tr>
<tr class="separator:a39ed1a135de5dc9eac67061ad5f7c00b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afb8961cfe9a3d60a8fb117573d653d5e"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#afb8961cfe9a3d60a8fb117573d653d5e">get_valid_indices</a> ()</td></tr>
<tr class="separator:afb8961cfe9a3d60a8fb117573d653d5e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a40d80b75d9515222d121b0295d834912"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a40d80b75d9515222d121b0295d834912">delete_links_from_matrix</a> ()</td></tr>
<tr class="separator:a40d80b75d9515222d121b0295d834912"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50b2036193677f4195ff66d609a58c77"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a50b2036193677f4195ff66d609a58c77">process_spatial_conditions_and_def_query</a> ()</td></tr>
<tr class="separator:a50b2036193677f4195ff66d609a58c77"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2482ed2c2f6d62e7937948a3abe84718"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a2482ed2c2f6d62e7937948a3abe84718">clone_matrices</a> ()</td></tr>
<tr class="separator:a2482ed2c2f6d62e7937948a3abe84718"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a81603fdc652b8373bf7eb489b48e90c4"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a81603fdc652b8373bf7eb489b48e90c4">build_matrix_elements</a> ()</td></tr>
<tr class="separator:a81603fdc652b8373bf7eb489b48e90c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a46c74898604160bd330340c034621e"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a6a46c74898604160bd330340c034621e">get_most_similar_pair</a> ()</td></tr>
<tr class="separator:a6a46c74898604160bd330340c034621e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abbc68b7fc4614303ca9fb94e41a5637e"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#abbc68b7fc4614303ca9fb94e41a5637e">get_default_linkage</a> ()</td></tr>
<tr class="separator:abbc68b7fc4614303ca9fb94e41a5637e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae00243f27346cdd3deb9a3bf9b26ee9f"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#ae00243f27346cdd3deb9a3bf9b26ee9f">set_shadow_matrix</a> ()</td></tr>
<tr class="separator:ae00243f27346cdd3deb9a3bf9b26ee9f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab5f4172227cffb6a643451589979927a"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#ab5f4172227cffb6a643451589979927a">get_matrix_count</a> ()</td></tr>
<tr class="separator:ab5f4172227cffb6a643451589979927a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaeb1d63efedb49c686686273e759f72d"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#aaeb1d63efedb49c686686273e759f72d">run_analysis</a> ()</td></tr>
<tr class="separator:aaeb1d63efedb49c686686273e759f72d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8967577c01508ffa42ab54af1410972b"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a8967577c01508ffa42ab54af1410972b">get_embedded_matrix</a> ()</td></tr>
<tr class="separator:a8967577c01508ffa42ab54af1410972b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a80d525855b3584c343029c4adafcaecf"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a80d525855b3584c343029c4adafcaecf">get_valid_indices_sub</a> ()</td></tr>
<tr class="separator:a80d525855b3584c343029c4adafcaecf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d983f1423124bfa67e272cef5e45d09"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a2d983f1423124bfa67e272cef5e45d09">setup_tie_breaker</a> ()</td></tr>
<tr class="separator:a2d983f1423124bfa67e272cef5e45d09"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5f3009ce6dec903e2cf0001c6cb8a064"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a5f3009ce6dec903e2cf0001c6cb8a064">build_matrices</a> ()</td></tr>
<tr class="separator:a5f3009ce6dec903e2cf0001c6cb8a064"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac465377a689697755defd96ce4124468"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#ac465377a689697755defd96ce4124468">get_most_similar_matrix_value</a> ()</td></tr>
<tr class="separator:ac465377a689697755defd96ce4124468"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a90157d91bfb5e8434e48d77a72ea661a"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a90157d91bfb5e8434e48d77a72ea661a">cluster</a> ()</td></tr>
<tr class="separator:a90157d91bfb5e8434e48d77a72ea661a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a39b236f7ea3912c6ad9af773afac4769"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a39b236f7ea3912c6ad9af773afac4769">min</a> ()</td></tr>
<tr class="separator:a39b236f7ea3912c6ad9af773afac4769"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a74338c9cf14c723a897a31082441777f"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a74338c9cf14c723a897a31082441777f">run_linkage</a> ()</td></tr>
<tr class="separator:a74338c9cf14c723a897a31082441777f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf17785ad7df032a2817fc6fd8dcd125"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#abf17785ad7df032a2817fc6fd8dcd125">get_orig_matrices</a> ()</td></tr>
<tr class="separator:abf17785ad7df032a2817fc6fd8dcd125"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a679573ff666973ea33cdb830f60a1518"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a679573ff666973ea33cdb830f60a1518">get_values_for_linkage</a> ()</td></tr>
<tr class="separator:a679573ff666973ea33cdb830f60a1518"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a38c418555d28d4a85fb683daab992b94"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a38c418555d28d4a85fb683daab992b94">cluster_matrix_elements</a> ()</td></tr>
<tr class="separator:a38c418555d28d4a85fb683daab992b94"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a44b0d5be4e30375ed319d7b70ab1eede"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a44b0d5be4e30375ed319d7b70ab1eede">get_linkage_functions</a> ()</td></tr>
<tr class="separator:a44b0d5be4e30375ed319d7b70ab1eede"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad03beb2dac8e6c60016a736ce4d928c8"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#ad03beb2dac8e6c60016a736ce4d928c8">link_average_unweighted</a> ()</td></tr>
<tr class="separator:ad03beb2dac8e6c60016a736ce4d928c8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a713958a3c7437ebb434e1ba7239cf1df"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a713958a3c7437ebb434e1ba7239cf1df">get_matrix_ref</a> ()</td></tr>
<tr class="separator:a713958a3c7437ebb434e1ba7239cf1df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4dca886eb868ed31e0e2c2110d52e1c4"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a4dca886eb868ed31e0e2c2110d52e1c4">get_matrices_ref</a> ()</td></tr>
<tr class="separator:a4dca886eb868ed31e0e2c2110d52e1c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6f07f5233d353aaa2db9cc8270760c08"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a6f07f5233d353aaa2db9cc8270760c08">get_metadata_export_matrices</a> ()</td></tr>
<tr class="separator:a6f07f5233d353aaa2db9cc8270760c08"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ae36dc8b71ac3429e11a2ae4201bfac"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a8ae36dc8b71ac3429e11a2ae4201bfac">sp_calc</a> ()</td></tr>
<tr class="separator:a8ae36dc8b71ac3429e11a2ae4201bfac"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a305ebeefe732109b67e0e64cac0fc8b3"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a305ebeefe732109b67e0e64cac0fc8b3">link_average</a> ()</td></tr>
<tr class="separator:a305ebeefe732109b67e0e64cac0fc8b3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a384a25fe57b55b014d87c4c30e323adf"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Cluster.html#a384a25fe57b55b014d87c4c30e323adf">get_shadow_matrix</a> ()</td></tr>
<tr class="separator:a384a25fe57b55b014d87c4c30e323adf"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><h1><a class="anchor" id="NAME"></a>
NAME</h1>
<p><a class="el" href="classBiodiverse_1_1Cluster.html">Biodiverse::Cluster</a></p>
<h1><a class="anchor" id="SYNOPSIS"></a>
SYNOPSIS</h1>
<pre>  use <a class="el" href="classBiodiverse_1_1Cluster.html">Biodiverse::Cluster</a>;
  $object = <a class="el" href="classBiodiverse_1_1Cluster.html">Biodiverse::Cluster</a>-&gt;new();</pre><h1><a class="anchor" id="DESCRIPTION"></a>
DESCRIPTION</h1>
<p>TO BE FILLED IN</p>
<h1><a class="anchor" id="METHODS"></a>
METHODS</h1>
<ul>
<li>
<a class="anchor" id="item_INSERT_METHODS"></a><b>INSERT METHODS</b>  </li>
</ul>
<h1><a class="anchor" id="REPORTING_ERRORS"></a>
REPORTING ERRORS</h1>
<p>Use the issue tracker at <a href="http://www.purl.org/biodiverse">http://www.purl.org/biodiverse</a></p>
<h1><a class="anchor" id="COPYRIGHT"></a>
COPYRIGHT</h1>
<p>Copyright (c) 2010 Shawn Laffan. All rights reserved.</p>
<h1><a class="anchor" id="LICENSE"></a>
LICENSE</h1>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p>For a full copy of the license see &lt;<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</p>

<p>Definition at line <a class="el" href="Cluster_8pm_source.html#l00060">60</a> of file <a class="el" href="Cluster_8pm_source.html">Cluster.pm</a>.</p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="a5bd9d3662c707446506e311528ff12a8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">private method Biodiverse::Cluster::_link_centroid </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-_link_centroid' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-_link_centroid-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-_link_centroid-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-_link_centroid-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in _link_centroid: 6</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a5bd9d3662c707446506e311528ff12a8">_link_centroid</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"><span class="preprocessor">    #  calculate the centroid of the similarities below this</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  requires that we traverse the tree - or at least cache the values</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ad3d1d664c30ec4452cdb9878975cb017"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::add_matrices_to_basedata </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-add_matrices_to_basedata' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-add_matrices_to_basedata-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-add_matrices_to_basedata-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-add_matrices_to_basedata-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in add_matrices_to_basedata: 20</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#ad3d1d664c30ec4452cdb9878975cb017">add_matrices_to_basedata</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  Don&#39;t add for randomisations or when we cluster a matrix directly</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;get_param (<span class="stringliteral">&#39;NO_ADD_MATRICES_TO_BASEDATA&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_basedata_ref;</div>
<div class="line"></div>
<div class="line">    my %existing_outputs = $bd-&gt;get_matrix_outputs;</div>
<div class="line"></div>
<div class="line">    my $orig_matrices = $args{matrices} || $self-&gt;get_param (<span class="stringliteral">&#39;ORIGINAL_MATRICES&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $mx (@$orig_matrices) {</div>
<div class="line">        next <span class="keywordflow">if</span> exists $existing_outputs{$mx-&gt;get_name} || any { $mx eq $_ } values %existing_outputs;</div>
<div class="line">        $bd-&gt;add_output(<span class="keywordtype">object</span> =&gt; $mx);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a5f3009ce6dec903e2cf0001c6cb8a064"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::build_matrices </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-build_matrices' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-build_matrices-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-build_matrices-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-build_matrices-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in build_matrices: 193</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a5f3009ce6dec903e2cf0001c6cb8a064">build_matrices</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  any file handles to output</span></div>
<div class="line"><span class="preprocessor"></span>    my $file_handles = $args{file_handles} ? $args{file_handles} : [];</div>
<div class="line">    <span class="keyword">delete</span> $args{file_handles};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  override any args if we are a re-run</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (defined $self-&gt;get_param(<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>)) {  </div>
<div class="line">        %args = %{$self-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>)};</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {  #  store them <span class="keywordflow">for</span> future use</div>
<div class="line">        my %args_sub = %args;</div>
<div class="line">        $self-&gt;set_param (ANALYSIS_ARGS =&gt; \%args_sub);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    my $output_gdm_format = $args{output_gdm_format};  #  need to make all the file stuff a hashref</div>
<div class="line"></div>
<div class="line">    my $start_time = time;</div>
<div class="line"></div>
<div class="line">    my $indices_object = $self-&gt;get_indices_object_for_matrix_and_clustering (%args);</div>
<div class="line"></div>
<div class="line">    my $index          = $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX&#39;</span>);</div>
<div class="line">    my $index_function = $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX_SUB&#39;</span>);</div>
<div class="line">    my $cache_abc      = $self-&gt;get_param (<span class="stringliteral">&#39;CACHE_ABC&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $name = $args{name} || $self-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>) || <span class="stringliteral">&quot;CLUSTERMATRIX_$index&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my @spatial_conditions = @{$self-&gt;get_param (<span class="stringliteral">&#39;SPATIAL_PARAMS&#39;</span>)};</div>
<div class="line">    my $definition_query = $self-&gt;get_param (<span class="stringliteral">&#39;DEFINITION_QUERY&#39;</span>);</div>
<div class="line">    </div>
<div class="line">    my $bd = $self-&gt;get_basedata_ref;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  now we loop over the conditions and initialise the matrices</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  kept separate from previous loop for cleaner default matrix generation</span></div>
<div class="line"><span class="preprocessor"></span>    my $mx_class = $self-&gt;get_param(<span class="stringliteral">&#39;MATRIX_CLASS&#39;</span>) <span class="comment">// $mx_class_default;</span></div>
<div class="line">    my %mx_common_args = (BASEDATA_REF =&gt; $bd,);</div>
<div class="line">    <span class="keywordflow">if</span> ($self-&gt;exists_param (<span class="stringliteral">&#39;MATRIX_INDEX_PRECISION&#39;</span>)) {  #  undef is OK, but must be explicitly <span class="keyword">set</span></div>
<div class="line">        my $mx_index_precision = $self-&gt;get_param(<span class="stringliteral">&#39;MATRIX_INDEX_PRECISION&#39;</span>);</div>
<div class="line">        $mx_common_args{VAL_INDEX_PRECISION} = $mx_index_precision;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my @matrices;</div>
<div class="line">    my $i = 0;</div>
<div class="line">    <span class="keywordflow">foreach</span> my $condition (@spatial_conditions) {</div>
<div class="line">        my $mx_name = $name . <span class="stringliteral">&quot; Matrix_$i&quot;</span>;</div>
<div class="line"></div>
<div class="line">        my $already_there = $bd-&gt;get_matrix_outputs;</div>
<div class="line">        <span class="keywordflow">if</span> (exists $already_there-&gt;{$mx_name}) {</div>
<div class="line">            Biodiverse::Cluster::MatrixExists-&gt;throw(</div>
<div class="line">                message =&gt; <span class="stringliteral">&quot;Matrix $name already exists\n&quot;</span>,</div>
<div class="line">                name    =&gt; $mx_name,</div>
<div class="line">                <span class="keywordtype">object</span>  =&gt; $already_there-&gt;{$mx_name},</div>
<div class="line">            );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        $matrices[$i] = $mx_class-&gt;new(</div>
<div class="line">            JOIN_CHAR    =&gt; $bd-&gt;get_param(<span class="stringliteral">&#39;JOIN_CHAR&#39;</span>),</div>
<div class="line">            NAME         =&gt; $mx_name,</div>
<div class="line">            %mx_common_args,</div>
<div class="line">        );</div>
<div class="line">        $i ++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $shadow_matrix;</div>
<div class="line">    <span class="keywordflow">if</span> (scalar @matrices &gt; 1) {</div>
<div class="line">        $shadow_matrix = $mx_class-&gt;new (</div>
<div class="line">            name         =&gt; $name . <span class="stringliteral">&#39;_SHADOW_MATRIX&#39;</span>,</div>
<div class="line">            %mx_common_args,</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line">    $self-&gt;set_shadow_matrix (matrix =&gt; $shadow_matrix);</div>
<div class="line"></div>
<div class="line">    print <span class="stringliteral">&quot;[CLUSTER] BUILDING &quot;</span>, scalar @matrices, <span class="stringliteral">&quot; MATRICES FOR $index CLUSTERING\n&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  print headers to file handles (if such are present)</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $fh (@$file_handles) {</div>
<div class="line">        print {$fh} $output_gdm_format</div>
<div class="line">        ? <span class="stringliteral">&quot;x1,y1,x2,y2,$index\n&quot;</span></div>
<div class="line">        : <span class="stringliteral">&quot;Element1,Element2,$index\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  we use a spatial object as it handles all the spatial checks.</span></div>
<div class="line"><span class="preprocessor"></span>    print <span class="stringliteral">&quot;[CLUSTER] Generating neighbour lists\n&quot;</span>;</div>
<div class="line">    my $sp = $bd-&gt;add_spatial_output (name =&gt; $name . <span class="stringliteral">&quot;_clus_nbrs_&quot;</span> . time());</div>
<div class="line">    my $sp_success = eval {</div>
<div class="line">        $sp-&gt;run_analysis (</div>
<div class="line">            %args,</div>
<div class="line">            calculations                  =&gt; [],</div>
<div class="line">            override_valid_analysis_check =&gt; 1,</div>
<div class="line">            spatial_conditions            =&gt; \@spatial_conditions,</div>
<div class="line">            definition_query              =&gt; $definition_query,</div>
<div class="line">            no_create_failed_def_query    =&gt; 1,  #  only want those that pass the def query</div>
<div class="line">            calc_only_elements_to_calc    =&gt; 1,</div>
<div class="line">            exclude_processed_elements    =&gt; 1,</div>
<div class="line">        );</div>
<div class="line">    };</div>
<div class="line">    croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;                #  Did we complete properly?</div>
<div class="line"><span class="preprocessor">    #croak $e if $e;                     #  Throw a hissy fit if we didn&#39;t complete properly</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">if</span> (not $args{keep_sp_nbrs_output}) {</div>
<div class="line"><span class="preprocessor">        #  remove it from the basedata so it isn&#39;t</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  added to a GUI project on next open</span></div>
<div class="line"><span class="preprocessor"></span>        $bd-&gt;delete_output (</div>
<div class="line">            output              =&gt; $sp,</div>
<div class="line">            delete_basedata_ref =&gt; 0,</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        $self-&gt;set_param (SP_NBRS_OUTPUT_NAME =&gt; $sp-&gt;get_param(<span class="stringliteral">&#39;NAME&#39;</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my %cache;  #  cache the label hashes</div>
<div class="line"><span class="preprocessor">                # - makes a small amount of difference</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">                # which will count for randomisations</span></div>
<div class="line"><span class="preprocessor"></span>    $self-&gt;set_param (MATRIX_ELEMENT_LABEL_CACHE =&gt; \%cache);</div>
<div class="line"></div>
<div class="line">    my %done;</div>
<div class="line">    my $valid_count = 0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # only those that passed the def query (if set) will be considered</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    # sort to ensure consistent order - easier for debug</span></div>
<div class="line"><span class="preprocessor"></span>    my @elements_to_calc = sort keys %{$sp-&gt;get_element_hash};</div>
<div class="line"></div>
<div class="line">    my $toDo = scalar @elements_to_calc;</div>
<div class="line"></div>
<div class="line">    croak <span class="stringliteral">&quot;No elements to cluster, check your spatial conditions and def query\n&quot;</span></div>
<div class="line">      <span class="keywordflow">if</span> not scalar $toDo;</div>
<div class="line"></div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line">    my $count = 0;</div>
<div class="line">    my $printedProgress = -1;</div>
<div class="line">    my $target_element_count = $toDo * ($toDo - 1) / 2; # n(n-1)/2</div>
<div class="line">    my $progress_pfx = <span class="stringliteral">&quot;Building matrix\n&quot;</span></div>
<div class="line">                        . <span class="stringliteral">&quot;$name\n&quot;</span></div>
<div class="line">                        . <span class="stringliteral">&quot;Target is $target_element_count matrix elements\n&quot;</span>;</div>
<div class="line"><span class="preprocessor">    #print &quot;[CLUSTER] Progress (% of $toDo elements):     &quot;;</span></div>
<div class="line"><span class="preprocessor"></span>    my @processed_elements;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  Use $sp for the groups so any def query will have an effect</span></div>
<div class="line"><span class="preprocessor"></span>    BY_ELEMENT:</div>
<div class="line">    <span class="keywordflow">foreach</span> my $element1 (sort @elements_to_calc) {</div>
<div class="line"></div>
<div class="line">        $count ++;</div>
<div class="line">        my $progress = $count / $toDo;</div>
<div class="line">        $progress_bar-&gt;update(</div>
<div class="line">            $progress_pfx . <span class="stringliteral">&quot;(row $count / $toDo)&quot;</span>,</div>
<div class="line">            $progress,</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        my @neighbours;  #  store the neighbours of <span class="keyword">this</span> element</div>
<div class="line">        <span class="keywordflow">foreach</span> my $i (0 .. $#matrices) {</div>
<div class="line">            my $nbr_list_name = <span class="stringliteral">&#39;_NBR_SET&#39;</span> . ($i+1);</div>
<div class="line">            my $neighours = $sp-&gt;get_list_values (</div>
<div class="line">                element =&gt; $element1,</div>
<div class="line">                list    =&gt; $nbr_list_name,</div>
<div class="line">            );</div>
<div class="line">            my %neighbour_hash;</div>
<div class="line">            @neighbour_hash{@$neighours} = (1) x scalar @$neighours;</div>
<div class="line">            <span class="keyword">delete</span> $neighbour_hash{$element1};  #  exclude ourselves</div>
<div class="line">            $neighbours[$i] = \%neighbour_hash;</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  loop over the neighbours and add them to the appropriate matrix</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $i (0 .. $#matrices) {</div>
<div class="line">            my $matrix = $matrices[$i];</div>
<div class="line"></div>
<div class="line">            my %nbrs = %{$neighbours[$i]};  #  save a few calcs</div>
<div class="line"></div>
<div class="line">            my $matrices_array = defined $shadow_matrix</div>
<div class="line">                                ? [$matrix, $shadow_matrix]</div>
<div class="line">                                : [$matrix];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  this actually takes most of the args from params,</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">            #  but setting explicitly might save micro-seconds of time</span></div>
<div class="line"><span class="preprocessor"></span>            my $x = $self-&gt;build_matrix_elements (</div>
<div class="line">                %args,  </div>
<div class="line">                matrices           =&gt; $matrices_array,</div>
<div class="line">                element            =&gt; $element1,</div>
<div class="line">                element_list       =&gt; [keys %nbrs],</div>
<div class="line">                index_function     =&gt; $index_function,</div>
<div class="line">                index              =&gt; $index,</div>
<div class="line">                cache_abc          =&gt; $cache_abc,</div>
<div class="line">                file_handle        =&gt; $file_handles-&gt;[$i],</div>
<div class="line">                spatial_object     =&gt; $sp,</div>
<div class="line">                indices_object     =&gt; $indices_object,</div>
<div class="line">                processed_elements =&gt; \@processed_elements,</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            $valid_count += $x;</div>
<div class="line">        }</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a81603fdc652b8373bf7eb489b48e90c4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::build_matrix_elements </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-build_matrix_elements' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-build_matrix_elements-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-build_matrix_elements-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-build_matrix_elements-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in build_matrix_elements: 197</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a81603fdc652b8373bf7eb489b48e90c4">build_matrix_elements</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $element1 = $args{element};</div>
<div class="line">    my $element_list2 = $args{element_list};</div>
<div class="line">    <span class="keywordflow">if</span> ((ref $element_list2) =~ /HASH/) {</div>
<div class="line">        $element_list2 = [keys %$element_list2];</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $cache = $args{element_label_cache} || $self-&gt;get_param (<span class="stringliteral">&#39;MATRIX_ELEMENT_LABEL_CACHE&#39;</span>);</div>
<div class="line">    my $matrices = $args{matrices};  #  two items, second is shadow matrix</div>
<div class="line"></div>
<div class="line">    my $index_function   = $args{index_function}</div>
<div class="line">                           || $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX_SUB&#39;</span>);</div>
<div class="line">    my $index            = $args{index}</div>
<div class="line">                           || $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX&#39;</span>);</div>
<div class="line">    my $cache_abc        = $args{cache_abc}</div>
<div class="line">                           || $self-&gt;get_param (<span class="stringliteral">&#39;CACHE_ABC&#39;</span>);</div>
<div class="line">    my $indices_object   = $args{indices_object}</div>
<div class="line">                           || $self-&gt;get_param (<span class="stringliteral">&#39;INDICES_OBJECT&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $processed_elements = $args{processed_elements};</div>
<div class="line"></div>
<div class="line">    my $ofh = $args{file_handle};</div>
<div class="line">    <span class="keyword">delete</span> $args{file_handle};</div>
<div class="line">    my $output_gdm_format = $args{output_gdm_format};</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_param (<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $sp = $args{spatial_object};</div>
<div class="line">    my $pass_def_query = $sp-&gt;get_param (<span class="stringliteral">&#39;PASS_DEF_QUERY&#39;</span>);</div>
<div class="line"><span class="preprocessor">    #my $pass_def_query = {};</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    my %already_calculated;</div>
<div class="line"></div>
<div class="line">    my $csv_out;</div>
<div class="line"><span class="preprocessor">    #  take care of closed file handles</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> ( defined $ofh ) {</div>
<div class="line">        <span class="keywordflow">if</span> ( not defined fileno $ofh ) {</div>
<div class="line">            warn <span class="stringliteral">&quot;[CLUSTER] Output file handle for matrix &quot;</span></div>
<div class="line">                . $matrices-&gt;[0]-&gt;get_param(<span class="stringliteral">&#39;NAME&#39;</span>)</div>
<div class="line">                . <span class="stringliteral">&quot; is unusable, setting it to undef&quot;</span>;</div>
<div class="line">            $ofh = undef;</div>
<div class="line">        }</div>
<div class="line">        $csv_out = $self-&gt;get_csv_object;</div>
<div class="line"></div>
<div class="line">        %already_calculated = $self-&gt;infer_if_already_calculated (</div>
<div class="line">            spatial_object =&gt; $sp,</div>
<div class="line">            element =&gt; $element1,</div>
<div class="line">            processed_elements =&gt; $processed_elements,</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $valid_count = 0;</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    #print &quot;Elements to calc: &quot;, (scalar @$element_list2), &quot;\n&quot;;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    ELEMENTS:</div>
<div class="line">    <span class="keywordflow">foreach</span> my $element2 (sort @$element_list2) {</div>
<div class="line">        next ELEMENTS <span class="keywordflow">if</span> $element1 eq $element2;</div>
<div class="line">        next ELEMENTS <span class="keywordflow">if</span> $already_calculated{$element2};</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ($pass_def_query) {  #  poss redundant check now</div>
<div class="line"><span class="preprocessor">            #my $null = undef;  #  debug</span></div>
<div class="line"><span class="preprocessor"></span>            next ELEMENTS</div>
<div class="line">              <span class="keywordflow">if</span> (not exists $pass_def_query-&gt;{$element2});</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  If we already have this value then get it and assign it.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  Some of these contortions appear to be due to an old approach</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  where all matrices were built in one loop.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  Could probably drop out sooner now. </span></div>
<div class="line"><span class="preprocessor"></span>        my $exists = 0;</div>
<div class="line">        my $iter = 0;</div>
<div class="line">        my %not_exists_iter;</div>
<div class="line">        my $value;</div>
<div class="line">        MX:</div>
<div class="line">        <span class="keywordflow">foreach</span> my $mx (@$matrices) {  #  second is shadow matrix, <span class="keywordflow">if</span> given</div>
<div class="line"><span class="preprocessor">            #last MX if $ofh;</span></div>
<div class="line"><span class="preprocessor"></span>            </div>
<div class="line">            my $x = $mx-&gt;element_pair_exists (</div>
<div class="line">                element1 =&gt; $element1,</div>
<div class="line">                element2 =&gt; $element2</div>
<div class="line">            );</div>
<div class="line">            <span class="keywordflow">if</span>  ($x) {  #  don<span class="stringliteral">&#39;t redo them...</span></div>
<div class="line"><span class="stringliteral">                $value = $mx-&gt;get_value (</span></div>
<div class="line"><span class="stringliteral">                    element1 =&gt; $element1,</span></div>
<div class="line"><span class="stringliteral">                    element2 =&gt; $element2,</span></div>
<div class="line"><span class="stringliteral">                );</span></div>
<div class="line"><span class="stringliteral">                $exists ++;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">            else {</span></div>
<div class="line"><span class="stringliteral">                $not_exists_iter{$iter} = 1;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">            $iter ++;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        next ELEMENTS if $exists == scalar @$matrices;  #  it is in all of them already</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        if ($exists) {  #  if it is in one then we use it</span></div>
<div class="line"><span class="stringliteral">            foreach my $iter (keys %not_exists_iter) {</span></div>
<div class="line"><span class="stringliteral">                $matrices-&gt;[$iter]-&gt;add_element (</span></div>
<div class="line"><span class="stringliteral">                    element1 =&gt; $element1,</span></div>
<div class="line"><span class="stringliteral">                    element2 =&gt; $element2,</span></div>
<div class="line"><span class="stringliteral">                    value    =&gt; $value,</span></div>
<div class="line"><span class="stringliteral">                )</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">            next ELEMENTS;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  use elements if no cached labels</span></div>
<div class="line"><span class="stringliteral">        #  set to undef if we have a cached label_hash</span></div>
<div class="line"><span class="stringliteral">        my ($el1_ref, $el2_ref, $label_hash1, $label_hash2);</span></div>
<div class="line"><span class="stringliteral">        if ($cache_abc) {</span></div>
<div class="line"><span class="stringliteral">            $el1_ref = defined $cache-&gt;{$element1} ? undef : [$element1];</span></div>
<div class="line"><span class="stringliteral">            $el2_ref = defined $cache-&gt;{$element2} ? undef : [$element2];</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            #  use cached labels if they exist (gets undef otherwise)</span></div>
<div class="line"><span class="stringliteral">            $label_hash1 = exists $cache-&gt;{$element1} ? $cache-&gt;{$element1} : undef;</span></div>
<div class="line"><span class="stringliteral">            $label_hash2 = exists $cache-&gt;{$element2} ? $cache-&gt;{$element2} : undef;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">        else {</span></div>
<div class="line"><span class="stringliteral">            $el1_ref = [$element1];</span></div>
<div class="line"><span class="stringliteral">            $el2_ref = [$element2];            </span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my %elements = (</span></div>
<div class="line"><span class="stringliteral">            element_list1   =&gt; $el1_ref,</span></div>
<div class="line"><span class="stringliteral">            element_list2   =&gt; $el2_ref,</span></div>
<div class="line"><span class="stringliteral">            label_hash1     =&gt; $label_hash1,</span></div>
<div class="line"><span class="stringliteral">            label_hash2     =&gt; $label_hash2,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my $values = $indices_object-&gt;run_calculations(%args, %elements);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        # useful for debugging  (comment out otherwise?)</span></div>
<div class="line"><span class="stringliteral">        if ($EVAL_ERROR &amp;&amp; ! defined $values-&gt;{$index}) {</span></div>
<div class="line"><span class="stringliteral">            croak &quot;PROBLEMS WITH $element1 $element2\n&quot;</span></div>
<div class="line"><span class="stringliteral">                  . $EVAL_ERROR;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  caching - a bit dodgy</span></div>
<div class="line"><span class="stringliteral">        #  what if we have calc_abc and calc_abc3 as deps?</span></div>
<div class="line"><span class="stringliteral">        if ($cache_abc) {</span></div>
<div class="line"><span class="stringliteral">            my $abc = {};</span></div>
<div class="line"><span class="stringliteral">            my $as_results_from = $indices_object-&gt;get_param(&#39;</span>AS_RESULTS_FROM<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral">            foreach my $calc_abc_type (qw /calc_abc3 calc_abc2 calc_abc/) {</span></div>
<div class="line"><span class="stringliteral">                if (exists $as_results_from-&gt;{$calc_abc_type}) {</span></div>
<div class="line"><span class="stringliteral">                    $abc = $as_results_from-&gt;{$calc_abc_type};</span></div>
<div class="line"><span class="stringliteral">                    last;</span></div>
<div class="line"><span class="stringliteral">                }</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            #  use cache unless told not to</span></div>
<div class="line"><span class="stringliteral">            if (defined $abc-&gt;{label_hash1} and ! defined $cache-&gt;{$element1}) {</span></div>
<div class="line"><span class="stringliteral">                $cache-&gt;{$element1} = $abc-&gt;{label_hash1};</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">            if (defined $abc-&gt;{label_hash2} and ! defined $cache-&gt;{$element2}) {</span></div>
<div class="line"><span class="stringliteral">                $cache-&gt;{$element2} = $abc-&gt;{label_hash2}</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        next if ! defined $values-&gt;{$index};  #  don&#39;</span>t add it <span class="keywordflow">if</span> it is undefined</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        # write results to file handles if supplied, otherwise store them</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (defined $ofh) {</div>
<div class="line">            my $res_list = $output_gdm_format</div>
<div class="line">                ? [</div>
<div class="line">                   @{[$bd-&gt;get_group_element_as_array(element =&gt; $element1)]}[0,1],  #  need to generalise these</div>
<div class="line">                   @{[$bd-&gt;get_group_element_as_array(element =&gt; $element2)]}[0,1],</div>
<div class="line">                   $values-&gt;{$index}</div>
<div class="line">                   ]</div>
<div class="line">                : [$element1, $element2, $values-&gt;{$index}];</div>
<div class="line">            my $text = $self-&gt;list2csv(</div>
<div class="line">                list       =&gt; $res_list,</div>
<div class="line">                csv_object =&gt; $csv_out,</div>
<div class="line">            );</div>
<div class="line">            print {$ofh} ($text . <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">foreach</span> my $mx (@$matrices) {</div>
<div class="line">                $mx-&gt;add_element (</div>
<div class="line">                    element1 =&gt; $element1,</div>
<div class="line">                    element2 =&gt; $element2,</div>
<div class="line">                    value    =&gt; $values-&gt;{$index}</div>
<div class="line">                );</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        $valid_count ++;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    my $cache_size = scalar keys %$cache;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $valid_count;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a2482ed2c2f6d62e7937948a3abe84718"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::clone_matrices </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-clone_matrices' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-clone_matrices-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-clone_matrices-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-clone_matrices-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in clone_matrices: 14</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a2482ed2c2f6d62e7937948a3abe84718">clone_matrices</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $matrices = $args{matrices} || $self-&gt;get_matrices_ref;</div>
<div class="line"></div>
<div class="line">    my @cloned_matrices;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">foreach</span> my $mx (@$matrices) {</div>
<div class="line">        push @cloned_matrices, $mx-&gt;clone;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? @cloned_matrices : \@cloned_matrices;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a90157d91bfb5e8434e48d77a72ea661a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::cluster </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-cluster' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-cluster-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-cluster-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-cluster-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in cluster: 180</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a90157d91bfb5e8434e48d77a72ea661a">cluster</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = (</div>
<div class="line">        clear_cached_values =&gt; 1,</div>
<div class="line">        flatten_tree        =&gt; 1,</div>
<div class="line">        @_,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $start_time = time;</div>
<div class="line"></div>
<div class="line">    my $file_handles = $args{file_handles};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  override most of the arguments if the system has values set</span></div>
<div class="line"><span class="preprocessor"></span>    my %passed_args = %args;</div>
<div class="line">    <span class="keywordflow">if</span> (defined $self-&gt;get_param(<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>)) {</div>
<div class="line">        %args = %{$self-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>)};</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {  #  store them <span class="keywordflow">for</span> future use</div>
<div class="line">        my %args_sub = %args;</div>
<div class="line">        <span class="keyword">delete</span> $args_sub{file_handles};  #  but don<span class="stringliteral">&#39;t store file handles</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;set_param (ANALYSIS_ARGS =&gt; \%args_sub);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  a little backwards compatibility</span></div>
<div class="line"><span class="stringliteral">    if (exists $args{spatial_analyses}</span></div>
<div class="line"><span class="stringliteral">        &amp;&amp; ! exists $args{spatial_calculations}) {</span></div>
<div class="line"><span class="stringliteral">        $args{spatial_calculations} = $args{spatial_analyses};</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral">    $self-&gt;set_param (CALCULATIONS_REQUESTED =&gt; $args{spatial_calculations});</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  just do/redo the spatial calcs if we have completed</span></div>
<div class="line"><span class="stringliteral">    if ($self-&gt;get_param(&#39;</span>COMPLETED<span class="stringliteral">&#39;) and $passed_args{spatial_calculations}) {</span></div>
<div class="line"><span class="stringliteral">        my %args_sub = %args;  #  override the stored args</span></div>
<div class="line"><span class="stringliteral">        $args_sub{spatial_calculations} = $passed_args{spatial_calculations};</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;set_param (ANALYSIS_ARGS =&gt; \%args_sub);</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;set_param (CALCULATIONS_REQUESTED =&gt; $args_sub{spatial_calculations});</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $self-&gt;run_spatial_calculations (%args_sub);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #$self-&gt;set_param (COMPLETED =&gt; 1);</span></div>
<div class="line"><span class="stringliteral">        return 1;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $self-&gt;set_param (COMPLETED =&gt; 0);</span></div>
<div class="line"><span class="stringliteral">    $self-&gt;set_param (JOIN_NUMBER =&gt; -1);  #  ensure they start counting from 0</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #$self-&gt;process_spatial_conditions_and_def_query (%args);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my @matrices;</span></div>
<div class="line"><span class="stringliteral">    #  if we were passed a matrix in the args  </span></div>
<div class="line"><span class="stringliteral">    if ($args{cluster_matrix}) {  #  THIS PROCESS NEEDS FIXING</span></div>
<div class="line"><span class="stringliteral">        my $clust_mx = $args{cluster_matrix}-&gt;clone;  #  make a copy so we don&#39;</span>t destroy the original</div>
<div class="line">        $self-&gt;set_matrix_ref (%args, cluster_matrix =&gt; $clust_mx);</div>
<div class="line"><span class="preprocessor">        #$self-&gt;set_shadow_matrix (matrix =&gt; $clust_mx);</span></div>
<div class="line"><span class="preprocessor"></span>        @matrices = ($clust_mx);</div>
<div class="line"><span class="preprocessor">        #  save the matrices for later export</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #$self-&gt;set_param (ORIGINAL_SHADOW_MATRIX =&gt; $args{matrix});</span></div>
<div class="line"><span class="preprocessor"></span>        $self-&gt;set_param (ORIGINAL_MATRICES =&gt; [$args{matrix}]);</div>
<div class="line">        $self-&gt;set_param (NO_ADD_MATRICES_TO_BASEDATA =&gt; 1);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">        #  try to build the matrices.</span></div>
<div class="line"><span class="preprocessor"></span>        my $index = $args{index} || $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX&#39;</span>) || $self-&gt;get_default_cluster_index;</div>
<div class="line">        croak <span class="stringliteral">&quot;[CLUSTER] $index not a valid clustering similarity index\n&quot;</span></div>
<div class="line">            <span class="keywordflow">if</span> ! exists ${$self-&gt;get_valid_indices}{$index};</div>
<div class="line">        $self-&gt;set_param (CLUSTER_INDEX =&gt; $index);</div>
<div class="line"></div>
<div class="line">        $self-&gt;process_spatial_conditions_and_def_query (%args);</div>
<div class="line"></div>
<div class="line">        my $matrices_recycled;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (not $self-&gt;get_matrix_count) {</div>
<div class="line"><span class="preprocessor">            #  can we get them from another output?</span></div>
<div class="line"><span class="preprocessor"></span>            my $bd = $self-&gt;get_basedata_ref;</div>
<div class="line">            <span class="keywordflow">if</span> (my $ref = $bd-&gt;get_outputs_with_same_conditions (compare_with =&gt; $self)) {</div>
<div class="line">                my $other_original_matrices = $ref-&gt;get_param(<span class="stringliteral">&#39;ORIGINAL_MATRICES&#39;</span>);</div>
<div class="line">                my $other_orig_shadow_mx    = $self-&gt;get_param(<span class="stringliteral">&#39;ORIGINAL_SHADOW_MATRIX&#39;</span>);</div>
<div class="line"><span class="preprocessor">                #  if the shadow matrix is empty then the matrices were consumed in clustering, so don&#39;t copy</span></div>
<div class="line"><span class="preprocessor"></span>                <span class="keywordflow">if</span> (   eval {$other_orig_shadow_mx-&gt;get_element_count}</div>
<div class="line">                    || eval {$other_original_matrices-&gt;[0]-&gt;get_element_count}) {</div>
<div class="line"></div>
<div class="line">                    print <span class="stringliteral">&quot;[CLUSTER] Recycling matrices from cluster output &quot;</span>, $ref-&gt;get_name, <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                    $self-&gt;set_param (ORIGINAL_MATRICES      =&gt; $other_original_matrices);</div>
<div class="line">                    $self-&gt;set_param (ORIGINAL_SHADOW_MATRIX =&gt; $other_orig_shadow_mx);</div>
<div class="line">                    $matrices_recycled = 1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  Do we already have some we can work on? </span></div>
<div class="line"><span class="preprocessor"></span>            my $original_matrices = $self-&gt;get_param(<span class="stringliteral">&#39;ORIGINAL_MATRICES&#39;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> ($original_matrices) {  #  need to handle no_clone_matrices</div>
<div class="line">                say <span class="stringliteral">&#39;[CLUSTER] Cloning matrices prior to destructive processing&#39;</span>;</div>
<div class="line">                <span class="keywordflow">foreach</span> my $mx (@$original_matrices) {</div>
<div class="line">                    push @matrices, $mx-&gt;clone;</div>
<div class="line">                }</div>
<div class="line">                my $orig_shadow_mx = $self-&gt;get_param(<span class="stringliteral">&#39;ORIGINAL_SHADOW_MATRIX&#39;</span>);</div>
<div class="line">                eval {</div>
<div class="line">                    $self-&gt;set_shadow_matrix (matrix =&gt; $orig_shadow_mx-&gt;clone);</div>
<div class="line">                };</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> {  #  build them</div>
<div class="line">                @matrices = eval {</div>
<div class="line">                    $self-&gt;build_matrices (file_handles =&gt; $file_handles);</div>
<div class="line">                };</div>
<div class="line">                croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line">            }</div>
<div class="line">            $self-&gt;set_matrix_ref(matrices =&gt; \@matrices);</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #  bail if first matrix could not be built (are we trapping this with prev croak now?)</span></div>
<div class="line"><span class="preprocessor"></span>        croak <span class="stringliteral">&quot;[CLUSTER] Matrix could not be built\n&quot;</span></div>
<div class="line">            <span class="keywordflow">if</span> not defined $self-&gt;get_matrix_ref;  </div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  should probably use matrix refs instead of cloning if this is set</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> ($args{file_handles}) {</div>
<div class="line">            $self-&gt;run_indices_object_cleanup;</div>
<div class="line">            $self-&gt;set_param(COMPLETED =&gt; 3);</div>
<div class="line">            <span class="keywordflow">return</span> 3;  #  don<span class="stringliteral">&#39;t try to cluster and don&#39;</span>t add anything to the basedata</div>
<div class="line">        }</div>
<div class="line">        elsif ($args{build_matrices_only}) {</div>
<div class="line">            $self-&gt;run_indices_object_cleanup;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  assign matrices to the orig slots, no need to clone</span></div>
<div class="line"><span class="preprocessor"></span>            $self-&gt;set_param (ORIGINAL_SHADOW_MATRIX =&gt; $self-&gt;get_shadow_matrix);</div>
<div class="line">            $self-&gt;set_param (ORIGINAL_MATRICES =&gt; \@matrices);</div>
<div class="line"></div>
<div class="line">            $self-&gt;add_matrices_to_basedata (matrices =&gt; \@matrices);</div>
<div class="line"><span class="preprocessor">            #  clear the other matrices</span></div>
<div class="line"><span class="preprocessor"></span>            $self-&gt;set_matrix_ref (matrices =&gt; []);</div>
<div class="line">            $self-&gt;set_shadow_matrix(matrix =&gt; undef);</div>
<div class="line">            $self-&gt;set_param(COMPLETED =&gt; 2);</div>
<div class="line">            <span class="keywordflow">return</span> 2;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> ($args{no_clone_matrices}) {  # reduce memory at the cost of later exports and visualisation</div>
<div class="line"><span class="preprocessor">                                             # How does this interact with the matrix recycling? </span></div>
<div class="line"><span class="preprocessor"></span>                print <span class="stringliteral">&quot;[CLUSTER] Storing matrices with no cloning - be warned that these will be destroyed in clustering\n&quot;</span>;</div>
<div class="line">                $self-&gt;set_param (ORIGINAL_SHADOW_MATRIX =&gt; $self-&gt;get_shadow_matrix);</div>
<div class="line">                $self-&gt;set_param (ORIGINAL_MATRICES =&gt; \@matrices);</div>
<div class="line">            }</div>
<div class="line">            elsif (!$matrices_recycled) {</div>
<div class="line"><span class="preprocessor">                #  save clones of the matrices for later export</span></div>
<div class="line"><span class="preprocessor"></span>                print <span class="stringliteral">&quot;[CLUSTER] Creating and storing matrix clones\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">                my $clone = eval {$self-&gt;get_shadow_matrix-&gt;clone};</div>
<div class="line">                $self-&gt;set_param (ORIGINAL_SHADOW_MATRIX =&gt; $clone);</div>
<div class="line"><span class="preprocessor">                #my $original_matrices = $self-&gt;clone (data =&gt; \@matrices);</span></div>
<div class="line"><span class="preprocessor"></span>                my $original_matrices = $self-&gt;clone_matrices (matrices =&gt; \@matrices);</div>
<div class="line">                $self-&gt;set_param (ORIGINAL_MATRICES =&gt; $original_matrices);</div>
<div class="line">        </div>
<div class="line">                print <span class="stringliteral">&quot;[CLUSTER] Done\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  no shadow matrix if only one matrix</span></div>
<div class="line"><span class="preprocessor"></span>    my $matrix_for_nodes = $self-&gt;get_shadow_matrix || $matrices[0];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  loop over the shadow matrix and create nodes for each matrix element</span></div>
<div class="line"><span class="preprocessor"></span>    print <span class="stringliteral">&quot;[CLUSTER] Creating terminal nodes\n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">foreach</span> my $element (sort $matrix_for_nodes-&gt;get_elements_as_array) {</div>
<div class="line">        next <span class="keywordflow">if</span> not defined $element;</div>
<div class="line">        $self-&gt;add_node (name =&gt; $element);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    $self-&gt;setup_tie_breaker;</div>
<div class="line"></div>
<div class="line">    MATRIX:</div>
<div class="line">    <span class="keywordflow">foreach</span> my $i (0 .. $#matrices) {  #  or maybe we should destructively sample <span class="keyword">this</span> as well?</div>
<div class="line">        print <span class="stringliteral">&quot;[CLUSTER] Using matrix $i\n&quot;</span>;</div>
<div class="line">        $self-&gt;set_param (CURRENT_MATRIX_ITER =&gt; $i);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  no elements left, so we&#39;ve used this one up.  Move to the next</span></div>
<div class="line"><span class="preprocessor"></span>        next MATRIX <span class="keywordflow">if</span> $matrices[$i]-&gt;get_element_count == 0;  </div>
<div class="line"></div>
<div class="line">        eval {</div>
<div class="line">            $self-&gt;cluster_matrix_elements (%args);</div>
<div class="line">        };</div>
<div class="line">        croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line">    }</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a38c418555d28d4a85fb683daab992b94"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::cluster_matrix_elements </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-cluster_matrix_elements' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-cluster_matrix_elements-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-cluster_matrix_elements-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-cluster_matrix_elements-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in cluster_matrix_elements: 142</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a38c418555d28d4a85fb683daab992b94">cluster_matrix_elements</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (defined $self-&gt;get_param(<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>)) {</div>
<div class="line">        %args = %{$self-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>)};</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {  #  store them <span class="keywordflow">for</span> future use</div>
<div class="line">        my %args_sub = %args;</div>
<div class="line">        <span class="keyword">delete</span> $args_sub{file_handles};  #  don<span class="stringliteral">&#39;t store these as Storable no like them</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;set_param (ANALYSIS_ARGS =&gt; \%args_sub);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  set the option for the linkage rule - default is specified in the object params</span></div>
<div class="line"><span class="stringliteral">    my $linkage_function = $self-&gt;get_param (&#39;</span>LINKAGE_FUNCTION<span class="stringliteral">&#39;)</span></div>
<div class="line"><span class="stringliteral">                            || $args{linkage_function}</span></div>
<div class="line"><span class="stringliteral">                            || $self-&gt;get_default_linkage;</span></div>
<div class="line"><span class="stringliteral">    $self-&gt;set_param (LINKAGE_FUNCTION =&gt; $linkage_function);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $rand = $self-&gt;initialise_rand (</span></div>
<div class="line"><span class="stringliteral">        seed  =&gt; $args{prng_seed} || undef,</span></div>
<div class="line"><span class="stringliteral">        state =&gt; $args{prng_state},</span></div>
<div class="line"><span class="stringliteral">    );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $mx_iter = $self-&gt;get_param (&#39;</span>CURRENT_MATRIX_ITER<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral">    my $sim_matrix = $self-&gt;get_matrix_ref (iter =&gt; $mx_iter);</span></div>
<div class="line"><span class="stringliteral">    croak &quot;No matrix reference available\n&quot; if not defined $sim_matrix;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $matrix_count = $self-&gt;get_matrix_count;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    print &quot;[CLUSTER] CLUSTERING USING $linkage_function, matrix iter $mx_iter of &quot;,</span></div>
<div class="line"><span class="stringliteral">            ($self-&gt;get_matrix_count - 1),</span></div>
<div class="line"><span class="stringliteral">            &quot;\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $new_node;</span></div>
<div class="line"><span class="stringliteral">    my $min_value;</span></div>
<div class="line"><span class="stringliteral">    #  track the number of joins - use as element name for merged nodes</span></div>
<div class="line"><span class="stringliteral">    my $join_number = $self-&gt;get_param (&#39;</span>JOIN_NUMBER<span class="stringliteral">&#39;) || -1;  </span></div>
<div class="line"><span class="stringliteral">    my $total = $sim_matrix-&gt;get_element_count;</span></div>
<div class="line"><span class="stringliteral">    croak &quot;Matrix has no elements\n&quot; if not $total;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $remaining;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    local $| = 1;  #  write to screen as we go</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $count = 0;</span></div>
<div class="line"><span class="stringliteral">    my $printedProgress = -1;</span></div>
<div class="line"><span class="stringliteral">    </span></div>
<div class="line"><span class="stringliteral">    my $name = $self-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;) || &#39;</span>no_name<span class="stringliteral">&#39;;</span></div>
<div class="line"><span class="stringliteral">    my $progress_text = &quot;Matrix iter $mx_iter of &quot; . ($matrix_count - 1) . &quot;\n&quot;;</span></div>
<div class="line"><span class="stringliteral">    $progress_text .= $args{progress_text} || $name;</span></div>
<div class="line"><span class="stringliteral">    print &quot;[CLUSTER] Progress (% of $total elements):     &quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    while ( ($remaining = $sim_matrix-&gt;get_element_count) &gt; 0) {</span></div>
<div class="line"><span class="stringliteral">        #print &quot;Remaining $remaining\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  get the most similar two candidates</span></div>
<div class="line"><span class="stringliteral">        $min_value = $self-&gt;get_most_similar_matrix_value (matrix =&gt; $sim_matrix);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $join_number ++;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my $text = &quot;Clustering\n&quot;</span></div>
<div class="line"><span class="stringliteral">                 . &quot;$progress_text\n(&quot;</span></div>
<div class="line"><span class="stringliteral">                 . ($remaining - 1)</span></div>
<div class="line"><span class="stringliteral">                 . &quot; remaining)\nMost similar value is &quot;</span></div>
<div class="line"><span class="stringliteral">                 . sprintf (&quot;%.3f&quot;, $min_value);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $progress_bar-&gt;update ($text, 1 - $remaining / $total);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $count ++;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my ($node1, $node2) = $self-&gt;get_most_similar_pair (</span></div>
<div class="line"><span class="stringliteral">            sim_matrix  =&gt; $sim_matrix,</span></div>
<div class="line"><span class="stringliteral">            value       =&gt; $min_value,</span></div>
<div class="line"><span class="stringliteral">            rand_object =&gt; $rand,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  use node refs for children that are nodes</span></div>
<div class="line"><span class="stringliteral">        #  use original name if not a node</span></div>
<div class="line"><span class="stringliteral">        #  - this is where the name for $el1 comes from (a historical leftover)</span></div>
<div class="line"><span class="stringliteral">        my $lengthBelow = 0;</span></div>
<div class="line"><span class="stringliteral">        my $nodeNames = $self-&gt;get_node_hash;</span></div>
<div class="line"><span class="stringliteral">        my $el1 = defined $nodeNames-&gt;{$node1} ? $nodeNames-&gt;{$node1} : $node1;</span></div>
<div class="line"><span class="stringliteral">        my $el2 = defined $nodeNames-&gt;{$node2} ? $nodeNames-&gt;{$node2} : $node2;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my $new_node_name = $join_number . &quot;___&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  create a new node using the elements - creates children as TreeNodes if needed</span></div>
<div class="line"><span class="stringliteral">        $new_node = $self-&gt;add_node (</span></div>
<div class="line"><span class="stringliteral">            name =&gt; $new_node_name,</span></div>
<div class="line"><span class="stringliteral">            children =&gt; [$el1, $el2],</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $new_node-&gt;set_value (</span></div>
<div class="line"><span class="stringliteral">            MATRIX_ITER_USED =&gt; $mx_iter,</span></div>
<div class="line"><span class="stringliteral">            JOIN_NUMBER      =&gt; $join_number,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral">        $new_node-&gt;set_child_lengths (total_length =&gt; $min_value);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  add children to the node hash if they are terminals</span></div>
<div class="line"><span class="stringliteral">        foreach my $child ($new_node-&gt;get_children) {</span></div>
<div class="line"><span class="stringliteral">            if ($child-&gt;is_terminal_node) {</span></div>
<div class="line"><span class="stringliteral">                if (not $self-&gt;exists_node (node_ref =&gt; $child)) {</span></div>
<div class="line"><span class="stringliteral">                    $self-&gt;add_to_node_hash (node_ref =&gt; $child);</span></div>
<div class="line"><span class="stringliteral">                }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">                $child-&gt;set_value (</span></div>
<div class="line"><span class="stringliteral">                    MATRIX_ITER_USED =&gt; $mx_iter,</span></div>
<div class="line"><span class="stringliteral">                    JOIN_NUMBER      =&gt; $join_number,</span></div>
<div class="line"><span class="stringliteral">                );</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">        </span></div>
<div class="line"><span class="stringliteral">        #if ($new_node-&gt;get_length &lt; 0) {</span></div>
<div class="line"><span class="stringliteral">        #    printf &quot;[CLUSTER] Node %s has negative length of %f\n&quot;, $new_node-&gt;get_name, $new_node-&gt;get_length;</span></div>
<div class="line"><span class="stringliteral">        #}</span></div>
<div class="line"><span class="stringliteral">        #printf &quot;[CLUSTER] Node %s has length of %f\n&quot;, $new_node-&gt;get_name, $new_node-&gt;get_length;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        ###  now we rebuild the similarity matrix to include the new linkages and destroy the old ones</span></div>
<div class="line"><span class="stringliteral">        #  possibly we should return a list of other matrix elements where the length</span></div>
<div class="line"><span class="stringliteral">        #  difference is 0 and which therefore could be merged now rather than next iteration</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;run_linkage (</span></div>
<div class="line"><span class="stringliteral">            node1            =&gt; $node1,</span></div>
<div class="line"><span class="stringliteral">            node2            =&gt; $node2,</span></div>
<div class="line"><span class="stringliteral">            new_node_name    =&gt; $new_node_name,</span></div>
<div class="line"><span class="stringliteral">            linkage_function =&gt; $linkage_function,</span></div>
<div class="line"><span class="stringliteral">            #merge_track_matrix =&gt; $merged_mx,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  finish off the progress</span></div>
<div class="line"><span class="stringliteral">    $progress_bar-&gt;update (undef, 1);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $self-&gt;set_param(JOIN_NUMBER =&gt; $join_number);</span></div>
<div class="line"><span class="stringliteral">    $self-&gt;set_param(MIN_VALUE   =&gt; $min_value);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $self-&gt;store_rand_state (rand_object =&gt; $rand);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    return;</span></div>
<div class="line"><span class="stringliteral">}</span></div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a40d80b75d9515222d121b0295d834912"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::delete_links_from_matrix </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-delete_links_from_matrix' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-delete_links_from_matrix-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-delete_links_from_matrix-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-delete_links_from_matrix-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in delete_links_from_matrix: 31</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a40d80b75d9515222d121b0295d834912">delete_links_from_matrix</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $element1 = $args{node1};</div>
<div class="line">    my $element2 = $args{node2};</div>
<div class="line"></div>
<div class="line">    croak <span class="stringliteral">&quot;one of the elements not specified\n&quot;</span></div>
<div class="line">      <span class="keywordflow">if</span> ! (defined $element1 &amp;&amp; defined $element2);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  remove elements1&amp;2 entries from the matrix</span></div>
<div class="line"><span class="preprocessor"></span>    my $matrix = $args{matrix} || $self-&gt;get_matrix_ref;</div>
<div class="line"></div>
<div class="line">    my $compare_nodes = $args{compare_nodes} || $matrix-&gt;get_elements_as_array;</div>
<div class="line">    my $expected = 2 * scalar @$compare_nodes;  #  we expect two deletions per comparison</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  clean up links from compare_nodes to elements1&amp;2</span></div>
<div class="line"><span class="preprocessor"></span>    my $deletion_count = 0;</div>
<div class="line">    <span class="keywordflow">foreach</span> my $check_element (sort @$compare_nodes) {</div>
<div class="line">        $deletion_count += $matrix-&gt;delete_element (</div>
<div class="line">            element1 =&gt; $check_element,</div>
<div class="line">            element2 =&gt; $element1,</div>
<div class="line">        );</div>
<div class="line">        $deletion_count += $matrix-&gt;delete_element (</div>
<div class="line">            element1 =&gt; $check_element,</div>
<div class="line">            element2 =&gt; $element2,</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $expected - $deletion_count;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a28d1d5d102d2b94e7046a200be46b2f7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::delete_shadow_matrix </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-delete_shadow_matrix' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-delete_shadow_matrix-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-delete_shadow_matrix-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-delete_shadow_matrix-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in delete_shadow_matrix: 7</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a28d1d5d102d2b94e7046a200be46b2f7">delete_shadow_matrix</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> not exists $self-&gt;{SHADOW_MATRIX}; #  avoid autovivification</div>
<div class="line">    $self-&gt;{SHADOW_MATRIX} = undef;</div>
<div class="line">    <span class="keyword">delete</span> $self-&gt;{SHADOW_MATRIX};</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a8cc2ddea793a40b47559f3eda78870a3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::export_matrices </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-export_matrices' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-export_matrices-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-export_matrices-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-export_matrices-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in export_matrices: 51</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a8cc2ddea793a40b47559f3eda78870a3">export_matrices</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $matrices      = $self-&gt;get_param (<span class="stringliteral">&#39;ORIGINAL_MATRICES&#39;</span>);</div>
<div class="line">    my $shadow_matrix = $self-&gt;get_param (<span class="stringliteral">&#39;ORIGINAL_SHADOW_MATRIX&#39;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  rebuild if needed</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (scalar @$matrices == 0) {</div>
<div class="line">        $matrices = $self-&gt;build_matrices (@_);</div>
<div class="line">        $shadow_matrix = $self-&gt;get_shadow_matrix;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $file = $args{file};</div>
<div class="line"></div>
<div class="line">    my $i = 0;</div>
<div class="line"></div>
<div class="line">    use File::Basename;</div>
<div class="line"></div>
<div class="line">    my ($name, $path, $suffix) = File::Basename::fileparse($file);</div>
<div class="line">    <span class="keywordflow">if</span> ($suffix ne $EMPTY_STRING) {</div>
<div class="line">        $suffix = <span class="stringliteral">&quot;.$suffix&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    $file = Path::Class::file($path, $name)-&gt;absolute;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $matrix (@$matrices) {</div>
<div class="line">        next <span class="keywordflow">if</span> ! defined $matrix;  #  allow <span class="keywordflow">for</span> absent shadow matrix</div>
<div class="line">        my $filename = $file;</div>
<div class="line">        <span class="keywordflow">if</span> (scalar @$matrices &gt; 1) {</div>
<div class="line"><span class="preprocessor">            #  insert the matrix number before the suffix</span></div>
<div class="line"><span class="preprocessor"></span>            $filename .= <span class="stringliteral">&quot;_$i$suffix&quot;</span>;</div>
<div class="line">        }</div>
<div class="line">        $matrix-&gt;export (</div>
<div class="line">            @_,</div>
<div class="line">            file =&gt; $filename,</div>
<div class="line">        );</div>
<div class="line">        $i ++;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (scalar @$matrices &gt; 1) {  #  only need the shadow (combined) matrix if more than one was used</div>
<div class="line">        my $filename = $file;</div>
<div class="line">        <span class="preprocessor">#$filename =~ s/(\.\S+$)/_shadowmatrix$1/;</span></div>
<div class="line"><span class="preprocessor"></span>        $filename .= <span class="stringliteral">&quot;_shadowmatrix$suffix&quot;</span>;</div>
<div class="line">        $shadow_matrix-&gt;export (</div>
<div class="line">            @_,</div>
<div class="line">            file =&gt; $filename</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a42b2b696be4028c9f19cbda36b438287"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_default_cluster_index </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_default_cluster_index' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_default_cluster_index-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_default_cluster_index-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_default_cluster_index-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_default_cluster_index: 3</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a42b2b696be4028c9f19cbda36b438287">get_default_cluster_index</a> {</div>
<div class="line">    <span class="keywordflow">return</span> $PARAMS{DEFAULT_CLUSTER_INDEX};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="abbc68b7fc4614303ca9fb94e41a5637e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_default_linkage </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_default_linkage' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_default_linkage-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_default_linkage-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_default_linkage-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_default_linkage: 5</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#abbc68b7fc4614303ca9fb94e41a5637e">get_default_linkage</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $PARAMS{DEFAULT_LINKAGE};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a8967577c01508ffa42ab54af1410972b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_embedded_matrix </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_embedded_matrix' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_embedded_matrix-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_embedded_matrix-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_embedded_matrix-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_embedded_matrix: 9</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a8967577c01508ffa42ab54af1410972b">get_embedded_matrix</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $args = $self-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $args-&gt;{matrix_ref} <span class="keywordflow">if</span> exists $args-&gt;{matrix_ref};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="acd828218b23c48a42af330d692ed0bb8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_embedded_tree </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_embedded_tree' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_embedded_tree-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_embedded_tree-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_embedded_tree-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_embedded_tree: 9</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#acd828218b23c48a42af330d692ed0bb8">get_embedded_tree</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $args = $self-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $args-&gt;{tree_ref} <span class="keywordflow">if</span> exists $args-&gt;{tree_ref};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="afead06ea4e49acda27117473fc989b84"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_indices_object_for_matrix_and_clustering </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_indices_object_for_matrix_and_clustering' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_indices_object_for_matrix_and_clustering-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_indices_object_for_matrix_and_clustering-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_indices_object_for_matrix_and_clustering-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_indices_object_for_matrix_and_clustering: 74</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#afead06ea4e49acda27117473fc989b84">get_indices_object_for_matrix_and_clustering</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $indices_object;</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    #  return cached version if we have one</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> $indices_object</div>
<div class="line">      <span class="keywordflow">if</span> $indices_object = $self-&gt;get_param (<span class="stringliteral">&#39;INDICES_OBJECT&#39;</span>);</div>
<div class="line">    </div>
<div class="line">    my $bd = $self-&gt;get_param (<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>);</div>
<div class="line"></div>
<div class="line">    $indices_object = <a class="code" href="classBiodiverse_1_1Indices.html">Biodiverse::Indices</a>-&gt;<a class="code" href="classBiodiverse_1_1Indices.html#a9b653e2cf5ae1ebc02b930dabae47779">new</a>(</div>
<div class="line">        BASEDATA_REF    =&gt; $bd,</div>
<div class="line">        NAME            =&gt; <span class="stringliteral">&#39;Indices for &#39;</span> . $self-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>),</div>
<div class="line">    );</div>
<div class="line">    $indices_object-&gt;set_pairwise_mode (1);</div>
<div class="line">    $self-&gt;set_param (INDICES_OBJECT =&gt; $indices_object);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  not sure why we are setting this here  - OK now?  was in build_matrices</span></div>
<div class="line"><span class="preprocessor"></span>    my $index = $args{index} || $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX&#39;</span>) || $self-&gt;get_default_cluster_index;</div>
<div class="line">    $self-&gt;set_param (CLUSTER_INDEX =&gt; $index);</div>
<div class="line">    <span class="keyword">delete</span> $args{index};  # saves passing it on in the index <span class="keyword">function</span> args</div>
<div class="line">    croak <span class="stringliteral">&quot;[CLUSTER] $index not a valid clustering similarity index\n&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> ! exists ${$self-&gt;get_valid_indices}{$index};</div>
<div class="line"></div>
<div class="line">    my $index_function = $indices_object-&gt;get_index_source (index =&gt; $index);</div>
<div class="line">    croak <span class="stringliteral">&quot;[CLUSTER] INDEX function not valid\n&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> ! exists ${$indices_object-&gt;get_calculations_as_flat_hash}{$index_function};</div>
<div class="line"><span class="preprocessor">    #  needed for recalculation linkages</span></div>
<div class="line"><span class="preprocessor"></span>    $self-&gt;set_param (CLUSTER_INDEX_SUB =&gt; $index_function);  </div>
<div class="line"></div>
<div class="line">    my $index_params = $indices_object-&gt;get_args (sub =&gt; $index_function);</div>
<div class="line">    my $index_order  = $index_params-&gt;{indices}{$index}{<a class="code" href="classBiodiverse_1_1Cluster.html#a90157d91bfb5e8434e48d77a72ea661a">cluster</a>};</div>
<div class="line"><span class="preprocessor">    # cache unless told otherwise</span></div>
<div class="line"><span class="preprocessor"></span>    my $cache_abc = $self-&gt;get_param (<span class="stringliteral">&#39;CACHE_ABC&#39;</span>) <span class="comment">// 1;</span></div>
<div class="line">    <span class="keywordflow">if</span> (defined $args{no_cache_abc} and length $args{no_cache_abc}) {</div>
<div class="line">        $cache_abc = not $args{no_cache_abc};</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ($index_order eq <span class="stringliteral">&#39;NO_CACHE_ABC&#39;</span>) {  #  index can <span class="keyword">override</span> user</div>
<div class="line">        $cache_abc = 0;</div>
<div class="line">    }</div>
<div class="line">    $self-&gt;set_param (CACHE_ABC =&gt; $cache_abc);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($args{objective_function}) {</div>
<div class="line">        $self-&gt;set_param (CLUSTER_MOST_SIMILAR_SUB =&gt; $args{objective_function});</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (ref ($index_order) =~ /ARRAY/) {  #  redundant now?</div>
<div class="line">        $self-&gt;set_param (CLUSTER_MOST_SIMILAR_SUB =&gt;</div>
<div class="line">            ($index_order-&gt;[1] &gt; $index_order-&gt;[0]</div>
<div class="line">             ? <span class="stringliteral">&#39;get_min_value&#39;</span></div>
<div class="line">             : <span class="stringliteral">&#39;get_max_value&#39;</span></div>
<div class="line">             )</div>
<div class="line">        );</div>
<div class="line">    }  # determines <span class="keywordflow">if</span> we <a class="code" href="classBiodiverse_1_1Cluster.html#a90157d91bfb5e8434e48d77a72ea661a">cluster</a> on higher or lower values</div>
<div class="line">    </div>
<div class="line">    my $analysis_args = $self-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line"></div>
<div class="line">    $indices_object-&gt;get_valid_calculations (</div>
<div class="line">        %$analysis_args,</div>
<div class="line">        calculations    =&gt; [$index_function],</div>
<div class="line">        nbr_list_count  =&gt; 2,</div>
<div class="line">        element_list1   =&gt; [], #  dummy values <span class="keywordflow">for</span> validity checks</div>
<div class="line">        element_list2   =&gt; [],</div>
<div class="line">    );</div>
<div class="line">    my $valid_calcs = $indices_object-&gt;get_valid_calculations_to_run;</div>
<div class="line">    croak <span class="stringliteral">&quot;Selected index $index_function cannot be calculated, check arguments like selected tree or matrix\n&quot;</span></div>
<div class="line">      <span class="keywordflow">if</span> not scalar keys %$valid_calcs;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  run the global pre_calcs</span></div>
<div class="line"><span class="preprocessor"></span>    $indices_object-&gt;run_precalc_globals(%$analysis_args);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> $indices_object;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a44b0d5be4e30375ed319d7b70ab1eede"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_linkage_functions </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_linkage_functions' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_linkage_functions-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_linkage_functions-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_linkage_functions-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_linkage_functions: 14</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a44b0d5be4e30375ed319d7b70ab1eede">get_linkage_functions</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $methods = Class::Inspector-&gt;methods (blessed ($self) || __PACKAGE__);</div>
<div class="line"></div>
<div class="line">    my @linkages;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $linkage (@$methods) {</div>
<div class="line">        next <span class="keywordflow">if</span> $linkage !~ /^link_/;</div>
<div class="line">        push @linkages, $linkage;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? @linkages : \@linkages;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a4dca886eb868ed31e0e2c2110d52e1c4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_matrices_ref </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_matrices_ref' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_matrices_ref-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_matrices_ref-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_matrices_ref-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_matrices_ref: 5</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a4dca886eb868ed31e0e2c2110d52e1c4">get_matrices_ref</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"><span class="preprocessor">    #my %args = @_;</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> $self-&gt;{MATRICES};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ab5f4172227cffb6a643451589979927a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_matrix_count </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_matrix_count' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_matrix_count-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_matrix_count-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_matrix_count-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_matrix_count: 6</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#ab5f4172227cffb6a643451589979927a">get_matrix_count</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> not exists $self-&gt;{MATRICES};  #  avoid autovivification</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> scalar @{$self-&gt;{MATRICES}};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a713958a3c7437ebb434e1ba7239cf1df"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_matrix_ref </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_matrix_ref' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_matrix_ref-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_matrix_ref-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_matrix_ref-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_matrix_ref: 9</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a713958a3c7437ebb434e1ba7239cf1df">get_matrix_ref</a> {  </div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> not exists $self-&gt;{MATRICES};  #  avoid autovivification</div>
<div class="line"></div>
<div class="line">    my $i = $args{iter} || 0;  #  need to implement an index of which to use </div>
<div class="line">    <span class="keywordflow">return</span> $self-&gt;{MATRICES}[$i];</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a6f07f5233d353aaa2db9cc8270760c08"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_metadata_export_matrices </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_metadata_export_matrices' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_metadata_export_matrices-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_metadata_export_matrices-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_metadata_export_matrices-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_metadata_export_matrices: 19</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a6f07f5233d353aaa2db9cc8270760c08">get_metadata_export_matrices</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my %args;</div>
<div class="line"></div>
<div class="line">    my $matrices = $self-&gt;get_param (<span class="stringliteral">&#39;ORIGINAL_MATRICES&#39;</span>);</div>
<div class="line">    eval {</div>
<div class="line">        %args = $matrices-&gt;[0]-&gt;get_args (sub =&gt; <span class="stringliteral">&#39;export&#39;</span>)</div>
<div class="line">    };</div>
<div class="line">    croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  override matrix setting</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  could casue grief if matrices allow more than delimited text</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (! defined $args{format} || $args{format} ne <span class="stringliteral">&#39;Matrices&#39;</span>) {</div>
<div class="line">        $args{format} = <span class="stringliteral">&#39;Matrices&#39;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ac465377a689697755defd96ce4124468"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_most_similar_matrix_value </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_most_similar_matrix_value' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_most_similar_matrix_value-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_most_similar_matrix_value-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_most_similar_matrix_value-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_most_similar_matrix_value: 7</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#ac465377a689697755defd96ce4124468">get_most_similar_matrix_value</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    my $matrix = $args{matrix} || croak <span class="stringliteral">&quot;matrix arg not specified\n&quot;</span>;</div>
<div class="line">    my $sub = $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_MOST_SIMILAR_SUB&#39;</span>) || <span class="stringliteral">&#39;get_min_value&#39;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> $matrix-&gt;$sub;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a6a46c74898604160bd330340c034621e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_most_similar_pair </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_most_similar_pair' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_most_similar_pair-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_most_similar_pair-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_most_similar_pair-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_most_similar_pair: 116</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a6a46c74898604160bd330340c034621e">get_most_similar_pair</a> {</div>
<div class="line">    my $self= shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    </div>
<div class="line">    my $rand        = $args{rand_object} <span class="comment">// croak &quot;rand_object argument not passed\n&quot;;</span></div>
<div class="line">    my $sim_matrix  = $args{sim_matrix}  <span class="comment">// croak &quot;sim_matrix argument not passed\n&quot;;</span></div>
<div class="line">    my $min_value   = $args{min_value}   <span class="comment">// $self-&gt;get_most_similar_matrix_value (matrix =&gt; $sim_matrix);</span></div>
<div class="line">    my $tie_breaker = $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_TIE_BREAKER&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $keys_ref = $sim_matrix-&gt;get_elements_with_value (value =&gt; $min_value);</div>
<div class="line">    my ($node1, $node2);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!$tie_breaker)  {  #  the old way</div>
<div class="line">        my $count1  = scalar keys %$keys_ref;</div>
<div class="line">        my $keys1   = $rand-&gt;shuffle ([sort keys %{$keys_ref}]);</div>
<div class="line">        $node1      = $keys1-&gt;[0];  # grab the first shuffled key</div>
<div class="line">        my $count2  = scalar keys %{$keys_ref};</div>
<div class="line">        my $keys2   = $rand-&gt;shuffle ([sort keys %{$keys_ref-&gt;{$node1}}]);</div>
<div class="line">        $node2      = $keys2-&gt;[0];  #  grab the first shuffled sub key</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        my $indices_object = $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_TIE_BREAKER_INDICES_OBJECT&#39;</span>);</div>
<div class="line">        my $analysis_args  = $self-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line">        my $tie_breaker_cache = $self-&gt;get_cached_value (<span class="stringliteral">&#39;TIEBREAKER_CACHES&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (!$tie_breaker_cache) {</div>
<div class="line">            $tie_breaker_cache = {};</div>
<div class="line">            $self-&gt;set_cached_value (TIEBREAKER_CACHES =&gt; $tie_breaker_cache);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  need to get all the pairs</span></div>
<div class="line"><span class="preprocessor"></span>        my @pairs;</div>
<div class="line">        <span class="keywordflow">foreach</span> my $name1 (keys %$keys_ref) {</div>
<div class="line">            my $ref = $keys_ref-&gt;{$name1};</div>
<div class="line">            <span class="keywordflow">foreach</span> my $name2 (keys %$ref) {</div>
<div class="line">                push @pairs, [$name1, $name2];  #  need to use terminal names - allows to <a class="code" href="classBiodiverse_1_1Cluster.html#a21eb2e3f7932148b6b879025a9738dd1">link_recalculate</a></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> (wantarray ? @{$pairs[0]} : $pairs[0])</div>
<div class="line">          <span class="keywordflow">if</span> scalar @pairs == 1;</div>
<div class="line"></div>
<div class="line">        my $current_pair;</div>
<div class="line">        my %tmp = @$tie_breaker;</div>
<div class="line">        my @tie_keys = keys %tmp;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  Sort ensures same order each time, thus stabilising random results</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $pair (sort {$a-&gt;[0] cmp $b-&gt;[0] || $a-&gt;[1] cmp $b-&gt;[1]} @pairs) { </div>
<div class="line">            no autovivification;</div>
<div class="line"></div>
<div class="line">            my $calc_results = $tie_breaker_cache-&gt;{$pair-&gt;[0]}{$pair-&gt;[1]}</div>
<div class="line">                            || $tie_breaker_cache-&gt;{$pair-&gt;[1]}{$pair-&gt;[0]};</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!defined $calc_results) {</div>
<div class="line">                my @el_lists;</div>
<div class="line">                <span class="keywordflow">foreach</span> my $j (0, 1) {</div>
<div class="line">                    my $node = $pair-&gt;[$j];</div>
<div class="line">                    my $node_ref = $self-&gt;get_node_ref (node =&gt; $node);</div>
<div class="line">                    my $el_list;</div>
<div class="line">                    <span class="keywordflow">if</span> ($node_ref-&gt;is_internal_node) {</div>
<div class="line">                        my $terminals = $node_ref-&gt;get_terminal_elements;</div>
<div class="line">                        $el_list = [keys %$terminals];</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> {</div>
<div class="line">                        $el_list = [$node];</div>
<div class="line">                    }</div>
<div class="line">                    push @el_lists, $el_list;</div>
<div class="line">                }</div>
<div class="line">                my %results = $indices_object-&gt;run_calculations(</div>
<div class="line">                    %$analysis_args,</div>
<div class="line">                    element_list1 =&gt; $el_lists[0],</div>
<div class="line">                    element_list2 =&gt; $el_lists[1],</div>
<div class="line">                );</div>
<div class="line">                $results{random} = $rand-&gt;rand;  #  add values <span class="keywordflow">for</span> non-index options, keep them consistet across all runs</div>
<div class="line">                $results{none}   = 0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">                #  remove any keys we won&#39;t use for tie breakers</span></div>
<div class="line"><span class="preprocessor"></span>                my %tmp = %results;</div>
<div class="line">                <span class="keyword">delete</span> @tmp{@tie_keys};</div>
<div class="line">                <span class="keyword">delete</span> @results{keys %tmp};</div>
<div class="line">                $calc_results = \%results;</div>
<div class="line">                $tie_breaker_cache-&gt;{$pair-&gt;[0]}{$pair-&gt;[1]} = $calc_results;</div>
<div class="line">            }</div>
<div class="line">            my %calc_res = %$calc_results;</div>
<div class="line"></div>
<div class="line">            my $itx = natatime 2, @$tie_breaker;</div>
<div class="line">            my $sub_res = [];</div>
<div class="line">            <span class="keywordflow">while</span> (my ($breaker, $optimisation) = $itx-&gt;()) {</div>
<div class="line">                push @$sub_res, $calc_res{$breaker};</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">            #print &quot;\n@$pair : @$sub_res&quot;;</span></div>
<div class="line"><span class="preprocessor"></span>            push @$sub_res, $pair;</div>
<div class="line"></div>
<div class="line">            $current_pair = $self-&gt;run_tie_breaker (</div>
<div class="line">                tie_breaker =&gt; $tie_breaker,</div>
<div class="line">                pair1       =&gt; $current_pair,</div>
<div class="line">                pair2       =&gt; $sub_res,</div>
<div class="line">            );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        my $chosen_pair = $current_pair-&gt;[-1];  #  last item in array is the pair</div>
<div class="line">        ($node1, $node2) = @$chosen_pair;</div>
<div class="line"><span class="preprocessor">        #print &quot;\nChosen = $node1, $node2\n&quot;;</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> ($tie_breaker_cache) {  #  cleanup</div>
<div class="line">            no autovivification;</div>
<div class="line">            <span class="keywordflow">do</span> {      <span class="keyword">delete</span> $tie_breaker_cache-&gt;{$node1}{$node2}   #  <span class="keyword">delete</span> our chosen pair</div>
<div class="line">                      &amp;&amp; !$tie_breaker_cache-&gt;{$node1}              #  and, <span class="keywordflow">if</span> parent is empty</div>
<div class="line">                      &amp;&amp; <span class="keyword">delete</span> $tie_breaker_cache-&gt;{$node1}}       #  then <span class="keyword">delete</span> that too</div>
<div class="line">                <span class="comment">//</span></div>
<div class="line">                <span class="keywordflow">do</span> {  <span class="keyword">delete</span> $tie_breaker_cache-&gt;{$node2}{$node1}   #  also the reverse</div>
<div class="line">                      &amp;&amp; !$tie_breaker_cache-&gt;{$node2}</div>
<div class="line">                      &amp;&amp; <span class="keyword">delete</span> $tie_breaker_cache-&gt;{$node2}</div>
<div class="line">                };</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? ($node1, $node2) : [$node1, $node2];</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="abf17785ad7df032a2817fc6fd8dcd125"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_orig_matrices </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_orig_matrices' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_orig_matrices-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_orig_matrices-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_orig_matrices-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_orig_matrices: 11</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#abf17785ad7df032a2817fc6fd8dcd125">get_orig_matrices</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my $matrices = $self-&gt;get_param (<span class="stringliteral">&#39;ORIGINAL_MATRICES&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (! $matrices) {</div>
<div class="line">        my $array = [];</div>
<div class="line">        $self-&gt;set_param (ORIGINAL_MATRICES =&gt; $array);</div>
<div class="line">        $matrices = $array;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? @$matrices : $matrices;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="acbda77c1adfa4b15fcd85dfc7415f76c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_prng_seed_argument </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_prng_seed_argument' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_prng_seed_argument-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_prng_seed_argument-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_prng_seed_argument-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_prng_seed_argument: 12</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#acbda77c1adfa4b15fcd85dfc7415f76c">get_prng_seed_argument</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $arguments = $self-&gt;get_param(<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> !$arguments;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #no autovivification;</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> !exists $arguments-&gt;{prng_seed};</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> $arguments-&gt;{prng_seed};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a384a25fe57b55b014d87c4c30e323adf"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_shadow_matrix </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_shadow_matrix' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_shadow_matrix-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_shadow_matrix-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_shadow_matrix-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_shadow_matrix: 4</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a384a25fe57b55b014d87c4c30e323adf">get_shadow_matrix</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    <span class="keywordflow">return</span> $self-&gt;{SHADOW_MATRIX};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a3a7f5944a6b7ed3fe5ddf84a779877d2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_type </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_type' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_type-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_type-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_type-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_type: 3</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a3a7f5944a6b7ed3fe5ddf84a779877d2">get_type</a> {</div>
<div class="line">    <span class="keywordflow">return</span> $PARAMS{TYPE};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="afb8961cfe9a3d60a8fb117573d653d5e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_valid_indices </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_valid_indices' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_valid_indices-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_valid_indices-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_valid_indices-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_valid_indices: 10</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#afb8961cfe9a3d60a8fb117573d653d5e">get_valid_indices</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $bd = $args{BASEDATA_REF} || $self-&gt;get_param(<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>);</div>
<div class="line">    my $indices = <a class="code" href="classBiodiverse_1_1Indices.html">Biodiverse::Indices</a>-&gt;<a class="code" href="classBiodiverse_1_1Indices.html#a9b653e2cf5ae1ebc02b930dabae47779">new</a>(BASEDATA_REF =&gt; $bd);</div>
<div class="line"></div>
<div class="line">    my $method = $self-&gt;get_valid_indices_sub;</div>
<div class="line">    <span class="keywordflow">return</span> $indices-&gt;$method (@_);</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a80d525855b3584c343029c4adafcaecf"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_valid_indices_sub </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_valid_indices_sub' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_valid_indices_sub-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_valid_indices_sub-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_valid_indices_sub-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_valid_indices_sub: 3</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a80d525855b3584c343029c4adafcaecf">get_valid_indices_sub</a> {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&#39;get_valid_cluster_indices&#39;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a679573ff666973ea33cdb830f60a1518"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::get_values_for_linkage </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_values_for_linkage' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_values_for_linkage-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_values_for_linkage-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_values_for_linkage-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_values_for_linkage: 29</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a679573ff666973ea33cdb830f60a1518">get_values_for_linkage</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    croak <span class="stringliteral">&quot;one of the nodes not specified in linkage function call\n&quot;</span></div>
<div class="line">      <span class="keywordflow">if</span> ! defined $args{node1} || ! defined $args{node2};</div>
<div class="line"></div>
<div class="line">    my $node1 = $args{node1};</div>
<div class="line">    my $node2 = $args{node2};</div>
<div class="line">    my $check_node = $args{compare_node};</div>
<div class="line"></div>
<div class="line">    my $sim_matrix = $args{matrix}</div>
<div class="line">        || croak <span class="stringliteral">&quot;argument &#39;matrix&#39; not specified\n&quot;</span>;</div>
<div class="line">    my ($tmp1, $tmp2);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (defined $check_node) {</div>
<div class="line">        $tmp1 = $sim_matrix-&gt;get_value (element1 =&gt; $check_node, element2 =&gt; $node1);</div>
<div class="line">        $tmp2 = $sim_matrix-&gt;get_value (element1 =&gt; $check_node, element2 =&gt; $node2);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        warn <span class="stringliteral">&quot;two node linkage case\n&quot;</span>;</div>
<div class="line">        my $nodeRef1 = $self-&gt;get_node_ref (node =&gt; $node1);</div>
<div class="line">        my $nodeRef2 = $self-&gt;get_node_ref (node =&gt; $node2);</div>
<div class="line">        $tmp1 = $nodeRef1-&gt;get_length_below;</div>
<div class="line">        $tmp2 = $nodeRef2-&gt;get_length_below;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? ($tmp1, $tmp2) : [$tmp1, $tmp2];</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a2b83d5b727007b538fe40695d67d5570"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::infer_if_already_calculated </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-infer_if_already_calculated' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-infer_if_already_calculated-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-infer_if_already_calculated-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-infer_if_already_calculated-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in infer_if_already_calculated: 30</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a2b83d5b727007b538fe40695d67d5570">infer_if_already_calculated</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $sp = $args{spatial_object};</div>
<div class="line">    my $element = $args{element};</div>
<div class="line">    my $processed_elements = $args{processed_elements};</div>
<div class="line"></div>
<div class="line">    my %already_calculated;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %already_calculated : \%already_calculated</div>
<div class="line">      <span class="keywordflow">if</span> scalar @$processed_elements == 0;</div>
<div class="line">    </div>
<div class="line">    my $nbr_list_name = <span class="stringliteral">&#39;_NBR_SET1&#39;</span>;  #  need to generalise <span class="keyword">this</span>, or pass as an arg (and make a method)</div>
<div class="line">    my $nbrs</div>
<div class="line">          = $sp-&gt;get_list_values (</div>
<div class="line">              element =&gt; $element,</div>
<div class="line">              list    =&gt; $nbr_list_name,</div>
<div class="line">              autovivify =&gt; 0,</div>
<div class="line">          )</div>
<div class="line">          || [];</div>
<div class="line"></div>
<div class="line">    NBR:</div>
<div class="line">    <span class="keywordflow">foreach</span> my $nbr (sort @$nbrs) {</div>
<div class="line">        next NBR <span class="keywordflow">if</span> ! defined (first {$_ eq $nbr} @$processed_elements);</div>
<div class="line">        $already_calculated{$nbr} = 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %already_calculated : \%already_calculated;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a09ff674367d54f8de070975ed0275743"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::join_root_nodes </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-join_root_nodes' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-join_root_nodes-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-join_root_nodes-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-join_root_nodes-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in join_root_nodes: 49</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a09ff674367d54f8de070975ed0275743">join_root_nodes</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $nodes = $self-&gt;get_root_nodes;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  drop out if only 1 root node</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> scalar keys %$nodes == 0;</div>
<div class="line"></div>
<div class="line">    my $target_len;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  find the longest path</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $node (values %$nodes) {</div>
<div class="line">        my $len = $node-&gt;get_length_below;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  check allows for clusters with any min value</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (!defined $target_len) {</div>
<div class="line">            $target_len = $len;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ($len &gt; $target_len) {</div>
<div class="line">            $target_len = $len;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #print &quot;Target length is $target_len\n&quot;;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    my $root_node = $self-&gt;add_node(</div>
<div class="line">        length =&gt; 0,</div>
<div class="line">        name   =&gt; $self-&gt;get_free_internal_name,</div>
<div class="line">    );</div>
<div class="line">    $root_node-&gt;set_value(JOIN_NOT_METRIC =&gt; 1);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  need to add a flag to say these are artificial</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">    #  set the length of each former root node</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $node (values %$nodes) {</div>
<div class="line">        my $current_len = $node-&gt;get_length;</div>
<div class="line">        my $len = $target_len - $node-&gt;get_length_below;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #print &quot;$target_len, $current_len, $len\n&quot;;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        $node-&gt;set_length(length =&gt; $len);</div>
<div class="line">        $node-&gt;set_value(JOIN_NOT_METRIC =&gt; 1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    $root_node-&gt;add_children(children =&gt; [values %$nodes]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a305ebeefe732109b67e0e64cac0fc8b3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::link_average </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-link_average' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-link_average-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-link_average-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-link_average-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in link_average: 20</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a305ebeefe732109b67e0e64cac0fc8b3">link_average</a> {  </div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    croak <span class="stringliteral">&quot;one of the nodes not specified in linkage function call\n&quot;</span></div>
<div class="line">      <span class="keywordflow">if</span> ! defined $args{node1} || ! defined $args{node2};</div>
<div class="line"></div>
<div class="line">    my $node1 = $args{node1};</div>
<div class="line">    my $node2 = $args{node2};</div>
<div class="line"></div>
<div class="line">    my $el1_count = $self-&gt;get_terminal_element_count (node =&gt; $node1);</div>
<div class="line">    my $el2_count = $self-&gt;get_terminal_element_count (node =&gt; $node2);</div>
<div class="line"></div>
<div class="line">    my ($tmp1, $tmp2) = $self-&gt;get_values_for_linkage (%args);</div>
<div class="line"></div>
<div class="line">    my $value  =  ($el1_count * $tmp1 + $el2_count * $tmp2)</div>
<div class="line">                / ($el1_count + $el2_count);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? (value =&gt; $value) : {value =&gt; $value};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ad03beb2dac8e6c60016a736ce4d928c8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::link_average_unweighted </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-link_average_unweighted' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-link_average_unweighted-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-link_average_unweighted-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-link_average_unweighted-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in link_average_unweighted: 9</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#ad03beb2dac8e6c60016a736ce4d928c8">link_average_unweighted</a> {  </div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my ($tmp1, $tmp2) = $self-&gt;get_values_for_linkage(@_);</div>
<div class="line"></div>
<div class="line">    my $value = ($tmp1 + $tmp2) / 2;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? (value =&gt; $value) : {value =&gt; $value};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ae48edaa30a7e286b2161b2bdfbdadbde"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::link_maximum </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-link_maximum' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-link_maximum-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-link_maximum-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-link_maximum-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in link_maximum: 7</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#ae48edaa30a7e286b2161b2bdfbdadbde">link_maximum</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $value = <a class="code" href="classBiodiverse_1_1Cluster.html#a1377cbf109ffd5682c5a5e1c10639856">max</a> ($self-&gt;get_values_for_linkage (@_));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? (value =&gt; $value) : {value =&gt; $value};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a4b112a16a0defc03eac9723a83ea5807"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::link_minimum </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-link_minimum' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-link_minimum-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-link_minimum-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-link_minimum-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in link_minimum: 7</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a4b112a16a0defc03eac9723a83ea5807">link_minimum</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $value = <a class="code" href="classBiodiverse_1_1Cluster.html#a39b236f7ea3912c6ad9af773afac4769">min</a> ($self-&gt;get_values_for_linkage (@_));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? (value =&gt; $value) : {value =&gt; $value};</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a21eb2e3f7932148b6b879025a9738dd1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::link_recalculate </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-link_recalculate' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-link_recalculate-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-link_recalculate-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-link_recalculate-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in link_recalculate: 117</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a21eb2e3f7932148b6b879025a9738dd1">link_recalculate</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    croak <span class="stringliteral">&quot;one of the nodes not specified\n&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> ! defined $args{node1} || ! defined $args{node2};</div>
<div class="line"></div>
<div class="line">    my $node1 = $args{node1};</div>
<div class="line">    my $node2 = $args{node2};</div>
<div class="line">    my $check_node = $args{compare_node};</div>
<div class="line"></div>
<div class="line">    my $node1_ref = $self-&gt;get_node_ref (node =&gt; $node1);</div>
<div class="line">    my $node2_ref = $self-&gt;get_node_ref (node =&gt; $node2);</div>
<div class="line">    my $check_node_ref = $self-&gt;get_node_ref (node =&gt; $check_node);</div>
<div class="line"></div>
<div class="line">    my $sim_matrix = $args{matrix}</div>
<div class="line">                    || $self-&gt;get_shadow_matrix</div>
<div class="line">                    || $self-&gt;get_matrix_ref(iter =&gt; 0);</div>
<div class="line"></div>
<div class="line">    my $index_function</div>
<div class="line">        = $args{index_function}</div>
<div class="line">        || $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX_SUB&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $index</div>
<div class="line">        = $args{index}</div>
<div class="line">        || $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_INDEX&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $cache_abc</div>
<div class="line">        = $args{cache_abc}</div>
<div class="line">        <span class="comment">// $self-&gt;get_param (&#39;CACHE_ABC&#39;);</span></div>
<div class="line"></div>
<div class="line">    my $indices_object = $self-&gt;get_indices_object_for_matrix_and_clustering;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  for the dependency analyses,</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  we treat node1 and node2 as one element set,</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  and check_node as the other</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">    #  stage some of the cached lists</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  - these are filled in as needed and possible</span></div>
<div class="line"><span class="preprocessor"></span>    my ($el1_list, $el2_list, $label_hash1, $label_hash2);</div>
<div class="line"></div>
<div class="line">    my $node1_2_cache_name = <span class="stringliteral">&#39;LABEL_HASH_&#39;</span> . $node1 . <span class="stringliteral">&#39;__&#39;</span> . $node2;</div>
<div class="line">    my $node2_1_cache_name = <span class="stringliteral">&#39;LABEL_HASH_&#39;</span> . $node2 . <span class="stringliteral">&#39;__&#39;</span> . $node1;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  get the element or label lists as needed</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> ($node1_ref) {</div>
<div class="line">        $label_hash1 = $node1_ref-&gt;get_cached_value ($node1_2_cache_name) ;</div>
<div class="line">    }</div>
<div class="line">    elsif ($node2_ref) {</div>
<div class="line">        $label_hash1 = $node1_ref-&gt;get_cached_value ($node1_2_cache_name);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    #  if no cached value then merge the lists of terminal elements</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (not $label_hash1) {</div>
<div class="line">        $el1_list = [];</div>
<div class="line"><span class="preprocessor">        #  only need to do the check until all terminal nodes</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  are created before clustering</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  -- is that the case now? --</span></div>
<div class="line"><span class="preprocessor"></span>        push @$el1_list,</div>
<div class="line">            $node1_ref ? keys %{$node1_ref-&gt;get_terminal_elements} : $node1;  </div>
<div class="line">        push @$el1_list,</div>
<div class="line">            $node2_ref ? keys %{$node2_ref-&gt;get_terminal_elements} : $node2;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($check_node_ref) {</div>
<div class="line">        $label_hash2 = $check_node_ref-&gt;get_cached_value (<span class="stringliteral">&#39;LABEL_HASH&#39;</span>) ;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (not $label_hash2) {</div>
<div class="line">        $el2_list = [];</div>
<div class="line">        push @$el2_list,</div>
<div class="line">            $check_node_ref</div>
<div class="line">            ? keys %{$check_node_ref-&gt;get_terminal_elements}</div>
<div class="line">            : $check_node;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $analysis_args = $self-&gt;get_param(<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line">    my $results = $indices_object-&gt;run_calculations(</div>
<div class="line">        %args,</div>
<div class="line">        %$analysis_args,</div>
<div class="line">        element_list1   =&gt; $el1_list,</div>
<div class="line">        element_list2   =&gt; $el2_list,</div>
<div class="line">        label_hash1     =&gt; $label_hash1,</div>
<div class="line">        label_hash2     =&gt; $label_hash2,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($cache_abc) {</div>
<div class="line"><span class="preprocessor">        #  dodgy way of getting at them - what if we have calc_abc and calc_abc3 as deps?</span></div>
<div class="line"><span class="preprocessor"></span>        my $abc = {};</div>
<div class="line">        my $as_results_from = $indices_object-&gt;get_param(<span class="stringliteral">&#39;AS_RESULTS_FROM&#39;</span>);</div>
<div class="line">        <span class="keywordflow">foreach</span> my $calc_abc_type (qw /calc_abc3 calc_abc2 calc_abc/) {</div>
<div class="line">            <span class="keywordflow">if</span> (exists $as_results_from-&gt;{$calc_abc_type}) {</div>
<div class="line">                $abc = $as_results_from-&gt;{$calc_abc_type};</div>
<div class="line">                last;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  use cache unless told not to</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (not defined $label_hash2 and defined $check_node_ref) {</div>
<div class="line">            $check_node_ref-&gt;set_cached_value (</div>
<div class="line">                LABEL_HASH =&gt; $abc-&gt;{label_hash2}</div>
<div class="line">            );</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (not defined $label_hash1) {</div>
<div class="line">            <span class="keywordflow">if</span> (defined $node1_ref) {</div>
<div class="line">                $node1_ref-&gt;set_cached_value (</div>
<div class="line">                    $node1_2_cache_name =&gt; $abc-&gt;{label_hash1}</div>
<div class="line">                );</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (defined $node2_ref) {</div>
<div class="line">                $node2_ref-&gt;set_cached_value (</div>
<div class="line">                    $node2_1_cache_name =&gt; $abc-&gt;{label_hash1});</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my %r = (value =&gt; $results-&gt;{$index});</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %r : \%r;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a1377cbf109ffd5682c5a5e1c10639856"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::max </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-max' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-max-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-max-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-max-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in max: 3</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a1377cbf109ffd5682c5a5e1c10639856">max</a> {</div>
<div class="line">    <span class="keywordflow">return</span> $_[0] &gt; $_[1] ? $_[0] : $_[1];</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a39b236f7ea3912c6ad9af773afac4769"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::min </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-min' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-min-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-min-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-min-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in min: 3</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a39b236f7ea3912c6ad9af773afac4769">min</a> {</div>
<div class="line">    <span class="keywordflow">return</span> $_[0] &lt; $_[1] ? $_[0] : $_[1];</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a9be78017f59d327ca21e496c96aa57df"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::override_cached_spatial_calculations_arg </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-override_cached_spatial_calculations_arg' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-override_cached_spatial_calculations_arg-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-override_cached_spatial_calculations_arg-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-override_cached_spatial_calculations_arg-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in override_cached_spatial_calculations_arg: 16</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a9be78017f59d327ca21e496c96aa57df">override_cached_spatial_calculations_arg</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    my $spatial_calculations = $args{spatial_calculations};</div>
<div class="line"></div>
<div class="line">    my $analysis_args = $self-&gt;get_param(<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> ! defined $analysis_args;  #  should we croak instead?</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  make sure we work on a copy, as these can be shallow copies from another object</span></div>
<div class="line"><span class="preprocessor"></span>    my %new_analysis_args = %$analysis_args;</div>
<div class="line">    $new_analysis_args{spatial_calculations} = $spatial_calculations;</div>
<div class="line">    $self-&gt;set_param (ANALYSIS_ARGS =&gt; \%new_analysis_args);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $spatial_calculations;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a50b2036193677f4195ff66d609a58c77"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::process_spatial_conditions_and_def_query </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-process_spatial_conditions_and_def_query' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-process_spatial_conditions_and_def_query-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-process_spatial_conditions_and_def_query-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-process_spatial_conditions_and_def_query-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in process_spatial_conditions_and_def_query: 22</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a50b2036193677f4195ff66d609a58c77">process_spatial_conditions_and_def_query</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    #  we work with any number of spatial conditions, but default to consider everything</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (! defined $args{spatial_conditions}) {</div>
<div class="line">        $args{spatial_conditions} = [<span class="stringliteral">&#39;sp_select_all ()&#39;</span>];</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my @spatial_conditions = @{$args{spatial_conditions}};</div>
<div class="line"><span class="preprocessor">    #  and we remove any undefined or empty conditions</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">for</span> my $i (reverse 0 .. $#spatial_conditions) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (    defined $spatial_conditions[$i]</div>
<div class="line">            and length $spatial_conditions[$i] == 0) {</div>
<div class="line">            $spatial_conditions[$i] = undef;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (not defined $spatial_conditions[$i]) {</div>
<div class="line">            splice (@spatial_conditions, $i);</div>
<div class="line">            next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="aaeb1d63efedb49c686686273e759f72d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::run_analysis </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_analysis' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_analysis-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_analysis-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_analysis-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_analysis: 4</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#aaeb1d63efedb49c686686273e759f72d">run_analysis</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    <span class="keywordflow">return</span> $self-&gt;cluster(@_);</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a06a62561a0955625346773c5fa75e559"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::run_indices_object_cleanup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_indices_object_cleanup' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_indices_object_cleanup-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_indices_object_cleanup-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_indices_object_cleanup-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_indices_object_cleanup: 15</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a06a62561a0955625346773c5fa75e559">run_indices_object_cleanup</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    #  run some cleanup on the indices object</span></div>
<div class="line"><span class="preprocessor"></span>    my $indices_object = $self-&gt;get_param(<span class="stringliteral">&#39;INDICES_OBJECT&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> ($indices_object) {</div>
<div class="line">        eval {</div>
<div class="line">            $indices_object-&gt;run_postcalc_globals;</div>
<div class="line">            $indices_object-&gt;reset_results(global =&gt; 1);</div>
<div class="line">        };</div>
<div class="line">    }</div>
<div class="line">    $self-&gt;set_param(INDICES_OBJECT =&gt; undef);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a74338c9cf14c723a897a31082441777f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::run_linkage </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_linkage' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_linkage-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_linkage-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_linkage-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_linkage: 82</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a74338c9cf14c723a897a31082441777f">run_linkage</a> {  #  rebuild the similarity matrices <span class="keyword">using</span> the linkage <span class="keyword">function</span></div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $node1 = $args{node1};</div>
<div class="line">    my $node2 = $args{node2};</div>
<div class="line">    my $new_node = $args{new_node_name};  #  don<span class="stringliteral">&#39;t calculate linkages to new node</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    croak &quot;one of the nodes not specified\n&quot;</span></div>
<div class="line"><span class="stringliteral">      if ! (defined $node1 and defined $node2 and defined $new_node);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $linkage_function = $args{linkage_function} || $PARAMS{DEFAULT_LINKAGE};</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $shadow_matrix   = $self-&gt;get_shadow_matrix;</span></div>
<div class="line"><span class="stringliteral">    my $matrix_array    = $self-&gt;get_matrices_ref;</span></div>
<div class="line"><span class="stringliteral">    my $current_mx_iter = $self-&gt;get_param (&#39;</span>CURRENT_MATRIX_ITER<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $matrix_with_elements = $shadow_matrix || $matrix_array-&gt;[0];</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  Now we need to loop over the respective nodes across</span></div>
<div class="line"><span class="stringliteral">    #  the matrices and merge as appropriate.</span></div>
<div class="line"><span class="stringliteral">    #  The sort guarantees same order each time.</span></div>
<div class="line"><span class="stringliteral">    CHECK_NODE:</span></div>
<div class="line"><span class="stringliteral">    foreach my $check_node (sort $matrix_with_elements-&gt;get_elements_as_array) {  </span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  skip the mergees</span></div>
<div class="line"><span class="stringliteral">        next CHECK_NODE if $check_node eq $node1 || $check_node eq $node2;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  skip if we don&#39;</span>t have both pairs check_node with node1 and with node2</div>
<div class="line">        next CHECK_NODE <span class="keywordflow">if</span> !(</div>
<div class="line">            $matrix_with_elements-&gt;element_pair_exists (</div>
<div class="line">                element1 =&gt; $check_node,</div>
<div class="line">                element2 =&gt; $node1,</div>
<div class="line">            )</div>
<div class="line">            &amp;&amp;</div>
<div class="line">            $matrix_with_elements-&gt;element_pair_exists (</div>
<div class="line">                element1 =&gt; $check_node,</div>
<div class="line">                element2 =&gt; $node2,</div>
<div class="line">            )</div>
<div class="line">        );  </div>
<div class="line"></div>
<div class="line">        my %values = $self-&gt;$linkage_function (</div>
<div class="line">            node1        =&gt; $node1,</div>
<div class="line">            node2        =&gt; $node2,</div>
<div class="line">            compare_node =&gt; $check_node,</div>
<div class="line">            matrix       =&gt; $matrix_with_elements,</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ($shadow_matrix) {</div>
<div class="line">            $shadow_matrix-&gt;add_element  (</div>
<div class="line">                element1 =&gt; $new_node,</div>
<div class="line">                element2 =&gt; $check_node,</div>
<div class="line">                value    =&gt; $values{value},</div>
<div class="line">            );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  work from the current mx forwards</span></div>
<div class="line"><span class="preprocessor"></span>        MX_ITER:</div>
<div class="line">        <span class="keywordflow">foreach</span> my $mx_iter ($current_mx_iter .. $#$matrix_array) {</div>
<div class="line">            my $mx = $matrix_array-&gt;[$mx_iter];</div>
<div class="line"></div>
<div class="line">            next MX_ITER</div>
<div class="line">              <span class="keywordflow">if</span> ! (</div>
<div class="line">                    $mx-&gt;element_pair_exists (</div>
<div class="line">                        element1 =&gt; $node1,</div>
<div class="line">                        element2 =&gt; $check_node,</div>
<div class="line">                    )</div>
<div class="line">                    &amp;&amp;</div>
<div class="line">                    $mx-&gt;element_pair_exists (</div>
<div class="line">                        element1 =&gt; $node2,</div>
<div class="line">                        element2 =&gt; $check_node,</div>
<div class="line">                    )</div>
<div class="line">                );</div>
<div class="line"></div>
<div class="line">            $mx-&gt;add_element (</div>
<div class="line">                element1 =&gt; $new_node,</div>
<div class="line">                element2 =&gt; $check_node,</div>
<div class="line">                value    =&gt; $values{value},</div>
<div class="line">            );</div>
<div class="line">            last MX_ITER;</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a616c1ec461fc3bc3bce0b70d72638e47"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::run_spatial_calculations </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_spatial_calculations' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_spatial_calculations-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_spatial_calculations-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_spatial_calculations-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_spatial_calculations: 14</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a616c1ec461fc3bc3bce0b70d72638e47">run_spatial_calculations</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $success = eval {</div>
<div class="line">        $self-&gt;sp_calc (</div>
<div class="line">            %args,</div>
<div class="line">            calculations =&gt; $args{spatial_calculations},</div>
<div class="line">        )</div>
<div class="line">    };</div>
<div class="line">    croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $success;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a39ed1a135de5dc9eac67061ad5f7c00b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::run_tie_breaker </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_tie_breaker' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_tie_breaker-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_tie_breaker-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_tie_breaker-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_tie_breaker: 28</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a39ed1a135de5dc9eac67061ad5f7c00b">run_tie_breaker</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    my $breaker = $args{tie_breaker};</div>
<div class="line">    my $pair1 = $args{pair1};</div>
<div class="line">    my $pair2 = $args{pair2};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $pair1 <span class="keywordflow">if</span> !$pair2;</div>
<div class="line">    <span class="keywordflow">return</span> $pair2 <span class="keywordflow">if</span> !$pair1;</div>
<div class="line"></div>
<div class="line">    my $it = natatime 2, @$breaker;</div>
<div class="line">    my $i = -1;</div>
<div class="line">    COMP:</div>
<div class="line">    <span class="keywordflow">while</span> (my ($breaker, $optimisation) = $it-&gt;()) {</div>
<div class="line">        $i ++;</div>
<div class="line">        my @comps = ($pair1-&gt;[$i], $pair2-&gt;[$i]);</div>
<div class="line">        <span class="keywordflow">if</span> ($optimisation =~ <span class="stringliteral">&#39;^max&#39;</span>) {</div>
<div class="line">            @comps = reverse @comps;</div>
<div class="line">        }</div>
<div class="line">        my $comp_result = $comps[0] &lt;=&gt; $comps[1];</div>
<div class="line"></div>
<div class="line">        next COMP <span class="keywordflow">if</span> !$comp_result;</div>
<div class="line">        <span class="keywordflow">return</span> $pair1 <span class="keywordflow">if</span> $comp_result &lt; 0;</div>
<div class="line">        <span class="keywordflow">return</span> $pair2;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $pair1;  #  we only had ties</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a2bb52212452068d95e51430714ba1d91"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::run_tiebreaker_indices_object_cleanup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_tiebreaker_indices_object_cleanup' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_tiebreaker_indices_object_cleanup-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_tiebreaker_indices_object_cleanup-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_tiebreaker_indices_object_cleanup-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_tiebreaker_indices_object_cleanup: 15</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a2bb52212452068d95e51430714ba1d91">run_tiebreaker_indices_object_cleanup</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    #  run some cleanup on the indices object</span></div>
<div class="line"><span class="preprocessor"></span>    my $indices_object = $self-&gt;get_param(<span class="stringliteral">&#39;CLUSTER_TIE_BREAKER_INDICES_OBJECT&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> ($indices_object) {</div>
<div class="line">        eval {</div>
<div class="line">            $indices_object-&gt;run_postcalc_globals;</div>
<div class="line">            $indices_object-&gt;reset_results(global =&gt; 1);</div>
<div class="line">        };</div>
<div class="line">    }</div>
<div class="line">    $self-&gt;set_param(CLUSTER_TIE_BREAKER_INDICES_OBJECT =&gt; undef);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ac6b8dfd5a17467740e4235e8adc44e39"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::set_matrix_ref </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-set_matrix_ref' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-set_matrix_ref-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-set_matrix_ref-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-set_matrix_ref-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in set_matrix_ref: 18</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#ac6b8dfd5a17467740e4235e8adc44e39">set_matrix_ref</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> ($args{cluster_matrix}) {</div>
<div class="line">        $self-&gt;{MATRICES} = [$args{cluster_matrix}];</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        croak <span class="stringliteral">&quot;Argument &#39;matrices&#39; not provided\n&quot;</span></div>
<div class="line">          <span class="keywordflow">if</span> ! exists $args{matrices};</div>
<div class="line">        croak <span class="stringliteral">&quot;Argument &#39;matrices&#39; is not an array\n&quot;</span></div>
<div class="line">          <span class="keywordflow">if</span> ! (ref $args{matrices}) =~ /ARRAY/;</div>
<div class="line"></div>
<div class="line">        $self-&gt;{MATRICES} = $args{matrices};</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ae00243f27346cdd3deb9a3bf9b26ee9f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::set_shadow_matrix </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-set_shadow_matrix' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-set_shadow_matrix-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-set_shadow_matrix-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-set_shadow_matrix-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in set_shadow_matrix: 6</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#ae00243f27346cdd3deb9a3bf9b26ee9f">set_shadow_matrix</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    $self-&gt;{SHADOW_MATRIX} = $args{matrix};  #  defaults to undef</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a2d983f1423124bfa67e272cef5e45d09"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::setup_tie_breaker </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-setup_tie_breaker' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-setup_tie_breaker-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-setup_tie_breaker-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-setup_tie_breaker-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in setup_tie_breaker: 36</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a2d983f1423124bfa67e272cef5e45d09">setup_tie_breaker</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    my $tie_breaker = $self-&gt;get_param (<span class="stringliteral">&#39;CLUSTER_TIE_BREAKER&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> !$tie_breaker;  #  old school clusters did not have one</div>
<div class="line"></div>
<div class="line">    my $indices_object = <a class="code" href="classBiodiverse_1_1Indices.html">Biodiverse::Indices</a>-&gt;<a class="code" href="classBiodiverse_1_1Indices.html#a9b653e2cf5ae1ebc02b930dabae47779">new</a> (BASEDATA_REF =&gt; $self-&gt;get_basedata_ref);</div>
<div class="line">    my $analysis_args = $self-&gt;get_param(<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $it = natatime 2, @$tie_breaker;</div>
<div class="line">    my @calc_subs;</div>
<div class="line">    <span class="keywordflow">while</span> (my ($breaker, $optimisation) = $it-&gt;()) {</div>
<div class="line">        next <span class="keywordflow">if</span> $breaker eq <span class="stringliteral">&#39;random&#39;</span>;  #  special handling <span class="keywordflow">for</span> <span class="keyword">this</span> - should change approach?</div>
<div class="line">        next <span class="keywordflow">if</span> $breaker eq <span class="stringliteral">&#39;none&#39;</span>;</div>
<div class="line">        next <span class="keywordflow">if</span> !defined $breaker;</div>
<div class="line">        croak <span class="stringliteral">&quot;$breaker is not a valid tie breaker\n&quot;</span></div>
<div class="line">            <span class="keywordflow">if</span>   !$indices_object-&gt;is_cluster_index (index =&gt; $breaker)</div>
<div class="line">              &amp;&amp; !$indices_object-&gt;is_region_grower_index (index =&gt; $breaker);</div>
<div class="line">        my $calc = $indices_object-&gt;get_index_source (index =&gt; $breaker);</div>
<div class="line">        croak <span class="stringliteral">&quot;no calc sub for $breaker\n&quot;</span> <span class="keywordflow">if</span> !defined $calc;</div>
<div class="line">        push @calc_subs, $calc;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    $indices_object-&gt;get_valid_calculations (</div>
<div class="line">        %args,</div>
<div class="line">        calculations   =&gt; \@calc_subs,</div>
<div class="line">        nbr_list_count =&gt; 2,</div>
<div class="line">        element_list1  =&gt; [],  #  <span class="keywordflow">for</span> validity checking only</div>
<div class="line">        element_list2  =&gt; [],</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    $indices_object-&gt;run_precalc_globals (%$analysis_args);</div>
<div class="line">    </div>
<div class="line">    $self-&gt;set_param (CLUSTER_TIE_BREAKER_INDICES_OBJECT =&gt; $indices_object);</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a8ae36dc8b71ac3429e11a2ae4201bfac"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Cluster::sp_calc </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-sp_calc' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-sp_calc-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-sp_calc-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-sp_calc-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in sp_calc: 78</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Cluster.html#a8ae36dc8b71ac3429e11a2ae4201bfac">sp_calc</a> {  </div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_param(<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>);</div>
<div class="line">    croak <span class="stringliteral">&quot;No BaseData ref\n&quot;</span> <span class="keywordflow">if</span> not defined $bd;</div>
<div class="line"></div>
<div class="line">    my $indices_object = <a class="code" href="classBiodiverse_1_1Indices.html">Biodiverse::Indices</a>-&gt;<a class="code" href="classBiodiverse_1_1Indices.html#a9b653e2cf5ae1ebc02b930dabae47779">new</a>(BASEDATA_REF =&gt; $bd);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (! exists $args{calculations}) {</div>
<div class="line">        <span class="keywordflow">if</span> (defined $args{analyses}) {</div>
<div class="line">            warn <span class="stringliteral">&quot;Use of argument &#39;analyses&#39; is deprecated from version 0.13\n&quot;</span></div>
<div class="line">                 . <span class="stringliteral">&quot;Use argument &#39;calculations&#39; instead.&quot;</span>;</div>
<div class="line">            $args{calculations} = $args{analyses};</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            $args{calculations} = $indices_object-&gt;get_calculations;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # run some checks and get the valid analyses</span></div>
<div class="line"><span class="preprocessor"></span>    my $nbr_list_count = 1;</div>
<div class="line">    $indices_object-&gt;get_valid_calculations (</div>
<div class="line">        %args,</div>
<div class="line">        nbr_list_count =&gt; $nbr_list_count,</div>
<div class="line">        element_list1  =&gt; [],</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  drop out if we have none to do</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $indices_object-&gt;get_valid_calculation_count == 0;  </div>
<div class="line"></div>
<div class="line">    <span class="keyword">delete</span> $args{calculations};  #  saves passing it onwards when we call the calculations</div>
<div class="line">    <span class="keyword">delete</span> $args{analyses};      #  <span class="keywordflow">for</span> backwards compat</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  NEED TO STORE A PARAMETER WITH ALL THE ARGS ETC for repeatability?</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    print <span class="stringliteral">&quot;[CLUSTER] sp_calc Running &quot;</span></div>
<div class="line">        . (join (q{ }, sort keys %{$indices_object-&gt;get_valid_calculations_to_run}))</div>
<div class="line">        . <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    $indices_object-&gt;run_precalc_globals(%args);</div>
<div class="line"></div>
<div class="line">    local $| = 1;  #  write to screen as we go</div>
<div class="line">    my $toDo = $self-&gt;get_node_count;</div>
<div class="line">    my ($count, $printedProgress) = (0, -1);</div>
<div class="line">    my $tree_name = $self-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>);</div>
<div class="line"></div>
<div class="line">    print <span class="stringliteral">&quot;[CLUSTER] Progress (% of $toDo nodes):     &quot;</span>;</div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  loop though the nodes and calculate the outputs</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">while</span> ((my $name, my $node) = each %{$self-&gt;get_node_hash}) {</div>
<div class="line">        $count ++;</div>
<div class="line"></div>
<div class="line">        $progress_bar-&gt;update (</div>
<div class="line">            <span class="stringliteral">&quot;Cluster spatial analysis\n&quot;</span></div>
<div class="line">            . <span class="stringliteral">&quot;$tree_name\n(node $count / $toDo)&quot;</span>,</div>
<div class="line">            $count / $toDo,</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        my %elements = (element_list1 =&gt; [keys %{$node-&gt;get_terminal_elements}]);</div>
<div class="line"></div>
<div class="line">        my %sp_calc_values = $indices_object-&gt;run_calculations(%args, %elements);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $key (keys %sp_calc_values) {</div>
<div class="line">            <span class="keywordflow">if</span> (ref($sp_calc_values{$key}) =~ /ARRAY|HASH/) {</div>
<div class="line">                $node-&gt;add_to_lists ($key =&gt; $sp_calc_values{$key});</div>
<div class="line">                <span class="keyword">delete</span> $sp_calc_values{$key};</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        $node-&gt;add_to_lists (SPATIAL_RESULTS =&gt; \%sp_calc_values);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  run any global post_calcs</span></div>
<div class="line"><span class="preprocessor"></span>    $indices_object-&gt;run_postcalc_globals (%args);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>lib/Biodiverse/<a class="el" href="Cluster_8pm_source.html">Cluster.pm</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>Biodiverse</b></li><li class="navelem"><a class="el" href="classBiodiverse_1_1Cluster.html">Cluster</a></li>
    <li class="footer">Generated on Tue Nov 5 2013 19:07:25 for Biodiverse by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
