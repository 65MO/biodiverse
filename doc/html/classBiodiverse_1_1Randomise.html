<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Biodiverse: Biodiverse::Randomise Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Biodiverse
   &#160;<span id="projectnumber">0.19</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('classBiodiverse_1_1Randomise.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="classBiodiverse_1_1Randomise-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">Biodiverse::Randomise Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Collaboration diagram for Biodiverse::Randomise:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="classBiodiverse_1_1Randomise__coll__graph.png" border="0" usemap="#Biodiverse_1_1Randomise_coll__map" alt="Collaboration graph"/></div>
<map name="Biodiverse_1_1Randomise_coll__map" id="Biodiverse_1_1Randomise_coll__map">
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:ac5cd09269ec852a92f5e54ee0f3f8ccf"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ac5cd09269ec852a92f5e54ee0f3f8ccf"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>EMPTY_STRING</b></td></tr>
<tr class="separator:ac5cd09269ec852a92f5e54ee0f3f8ccf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6c4c6f30d670380ea5eb2b47556d2ae3"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a6c4c6f30d670380ea5eb2b47556d2ae3"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>progress_update_interval</b></td></tr>
<tr class="separator:a6c4c6f30d670380ea5eb2b47556d2ae3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6eeb547cd3e1e749e7b90501188dd3a1"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a6eeb547cd3e1e749e7b90501188dd3a1"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>process_group_props_tooltip</b></td></tr>
<tr class="separator:a6eeb547cd3e1e749e7b90501188dd3a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8a55be3bfe4397f63bb46f2e4d9d3126"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8a55be3bfe4397f63bb46f2e4d9d3126"></a>
scalar&#160;</td><td class="memItemRight" valign="bottom"><b>randomise_trees_tooltip</b></td></tr>
<tr class="separator:a8a55be3bfe4397f63bb46f2e4d9d3126"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="member-group"></a>
Avaliable Methods</h2></td></tr>
<tr class="memitem:a55d2c50b166d0c9202a8414d92bdbad3"><td class="memItemLeft" align="right" valign="top">private method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a55d2c50b166d0c9202a8414d92bdbad3">_get_metadata_export</a> ()</td></tr>
<tr class="separator:a55d2c50b166d0c9202a8414d92bdbad3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02da1528612ca98e2cb06eaa0bfaf707"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a02da1528612ca98e2cb06eaa0bfaf707">get_randomisation_functions</a> ()</td></tr>
<tr class="separator:a02da1528612ca98e2cb06eaa0bfaf707"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7c8829e39557bc1fe04f7476d8644176"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a7c8829e39557bc1fe04f7476d8644176">check_rand_function_is_valid</a> ()</td></tr>
<tr class="separator:a7c8829e39557bc1fe04f7476d8644176"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a881cfa4541e1a447ac1a02d1802988be"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a881cfa4541e1a447ac1a02d1802988be">get_metadata_export_prng_current_state</a> ()</td></tr>
<tr class="separator:a881cfa4541e1a447ac1a02d1802988be"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a729602bd59c231b84f79072a3177051d"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a729602bd59c231b84f79072a3177051d">export_prng_current_state</a> ()</td></tr>
<tr class="separator:a729602bd59c231b84f79072a3177051d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a31fea1bba658013ac36b8fc3d3baa3e4"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a31fea1bba658013ac36b8fc3d3baa3e4">run_analysis</a> ()</td></tr>
<tr class="separator:a31fea1bba658013ac36b8fc3d3baa3e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2a6d50214d9a22800bdc62c8af14a38b"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a2a6d50214d9a22800bdc62c8af14a38b">rand_csr_by_group</a> ()</td></tr>
<tr class="separator:a2a6d50214d9a22800bdc62c8af14a38b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a9f5e148e3dbe23f4126cce416d13ad"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a5a9f5e148e3dbe23f4126cce416d13ad">compare_cluster_calcs_per_node</a> ()</td></tr>
<tr class="separator:a5a9f5e148e3dbe23f4126cce416d13ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af60b9997a005dd082432060b3e91651e"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#af60b9997a005dd082432060b3e91651e">get_metadata_export</a> ()</td></tr>
<tr class="separator:af60b9997a005dd082432060b3e91651e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:addf6e4b1f317dcf41baf8e26271a52be"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#addf6e4b1f317dcf41baf8e26271a52be">new</a> ()</td></tr>
<tr class="separator:addf6e4b1f317dcf41baf8e26271a52be"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd3c6644313aa3d9c9f3131c81608582"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#acd3c6644313aa3d9c9f3131c81608582">export</a> ()</td></tr>
<tr class="separator:acd3c6644313aa3d9c9f3131c81608582"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a73c76e4e45e27784da64871ee23cb12b"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a73c76e4e45e27784da64871ee23cb12b">get_metadata_rand_nochange</a> ()</td></tr>
<tr class="separator:a73c76e4e45e27784da64871ee23cb12b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac77428aa58057432d385086d95f5f80f"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#ac77428aa58057432d385086d95f5f80f">rand_structured</a> ()</td></tr>
<tr class="separator:ac77428aa58057432d385086d95f5f80f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a131ec1e86332fa6ba77cf921b39a09fa"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a131ec1e86332fa6ba77cf921b39a09fa">process_group_props_by_set</a> ()</td></tr>
<tr class="separator:a131ec1e86332fa6ba77cf921b39a09fa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a208ce0305c83d6cb8ec57b9e0fd3d456"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a208ce0305c83d6cb8ec57b9e0fd3d456">rand_nochange</a> ()</td></tr>
<tr class="separator:a208ce0305c83d6cb8ec57b9e0fd3d456"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaaa6b6880f801f1530097e5ebd62e674"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#aaaa6b6880f801f1530097e5ebd62e674">get_group_prop_metadata</a> ()</td></tr>
<tr class="separator:aaaa6b6880f801f1530097e5ebd62e674"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6770c3735a99a10b4aaf7ca1e6348e3e"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a6770c3735a99a10b4aaf7ca1e6348e3e">run_randomisation</a> ()</td></tr>
<tr class="separator:a6770c3735a99a10b4aaf7ca1e6348e3e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a010b59a4e46938d7d5a3ca081c7ea6d3"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a010b59a4e46938d7d5a3ca081c7ea6d3">export_prng_init_state</a> ()</td></tr>
<tr class="separator:a010b59a4e46938d7d5a3ca081c7ea6d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac958e027d870d5d22396a44b2c22b0cc"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#ac958e027d870d5d22396a44b2c22b0cc">get_analysis_args_from_object</a> ()</td></tr>
<tr class="separator:ac958e027d870d5d22396a44b2c22b0cc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abdda089ee61a5232e81c408872b0d479"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#abdda089ee61a5232e81c408872b0d479">get_metadata_rand_structured</a> ()</td></tr>
<tr class="separator:abdda089ee61a5232e81c408872b0d479"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a76a64be056c781a550df76914f81fbb6"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a76a64be056c781a550df76914f81fbb6">override_object_analysis_args</a> ()</td></tr>
<tr class="separator:a76a64be056c781a550df76914f81fbb6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a68da97c0e6983b484443cd9bd27987c5"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a68da97c0e6983b484443cd9bd27987c5">swap_to_reach_targets</a> ()</td></tr>
<tr class="separator:a68da97c0e6983b484443cd9bd27987c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aacb0920fdb0dad354975fe6115955dde"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#aacb0920fdb0dad354975fe6115955dde">get_metadata_rand_csr_by_group</a> ()</td></tr>
<tr class="separator:aacb0920fdb0dad354975fe6115955dde"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac2375f48dafb8550d729109b342ac6f0"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#ac2375f48dafb8550d729109b342ac6f0">get_metadata_export_prng_init_state</a> ()</td></tr>
<tr class="separator:ac2375f48dafb8550d729109b342ac6f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af6a142d75d11b296a1b749b8dcb92357"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#af6a142d75d11b296a1b749b8dcb92357">process_group_props_by_item</a> ()</td></tr>
<tr class="separator:af6a142d75d11b296a1b749b8dcb92357"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a57ead009f007ec7747e8bd4dadcf7384"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a57ead009f007ec7747e8bd4dadcf7384">process_group_props</a> ()</td></tr>
<tr class="separator:a57ead009f007ec7747e8bd4dadcf7384"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24b36bfb0d4bcb13ba1fe76292a882f6"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#a24b36bfb0d4bcb13ba1fe76292a882f6">get_tree_shuffle_metadata</a> ()</td></tr>
<tr class="separator:a24b36bfb0d4bcb13ba1fe76292a882f6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa5c1939856878467a487632a9d5de7a"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classBiodiverse_1_1Randomise.html#afa5c1939856878467a487632a9d5de7a">process_group_props_no_change</a> ()</td></tr>
<tr class="separator:afa5c1939856878467a487632a9d5de7a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><h1><a class="anchor" id="NAME"></a>
NAME</h1>
<p><a class="el" href="classBiodiverse_1_1Randomise.html">Biodiverse::Randomise</a></p>
<h1><a class="anchor" id="SYNOPSIS"></a>
SYNOPSIS</h1>
<pre>  use <a class="el" href="classBiodiverse_1_1Randomise.html">Biodiverse::Randomise</a>;
  $object = <a class="el" href="classBiodiverse_1_1Randomise.html">Biodiverse::Randomise</a>-&gt;<a class="el" href="classBiodiverse_1_1Randomise.html#addf6e4b1f317dcf41baf8e26271a52be">new()</a>;</pre><h1><a class="anchor" id="DESCRIPTION"></a>
DESCRIPTION</h1>
<p>TO BE FILLED IN</p>
<h1><a class="anchor" id="METHODS"></a>
METHODS</h1>
<ul>
<li>
<a class="anchor" id="item_INSERT_METHODS"></a><b>INSERT METHODS</b>  </li>
</ul>
<h1><a class="anchor" id="REPORTING_ERRORS"></a>
REPORTING ERRORS</h1>
<p>Use the issue tracker at <a href="http://www.purl.org/biodiverse">http://www.purl.org/biodiverse</a></p>
<h1><a class="anchor" id="COPYRIGHT"></a>
COPYRIGHT</h1>
<p>Copyright (c) 2010 Shawn Laffan. All rights reserved.</p>
<h1><a class="anchor" id="LICENSE"></a>
LICENSE</h1>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p>For a full copy of the license see &lt;<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</p>

<p>Definition at line <a class="el" href="Randomise_8pm_source.html#l00055">55</a> of file <a class="el" href="Randomise_8pm_source.html">Randomise.pm</a>.</p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="a55d2c50b166d0c9202a8414d92bdbad3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">private method Biodiverse::Randomise::_get_metadata_export </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-_get_metadata_export' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-_get_metadata_export-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-_get_metadata_export-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-_get_metadata_export-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in _get_metadata_export: 55</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a55d2c50b166d0c9202a8414d92bdbad3">_get_metadata_export</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  need a list of export subs</span></div>
<div class="line"><span class="preprocessor"></span>    my %subs = $self-&gt;get_subs_with_prefix (prefix =&gt; <span class="stringliteral">&#39;export_&#39;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  hunt through the other export subs and collate their metadata</span></div>
<div class="line"><span class="preprocessor"></span>    my @export_sub_params;</div>
<div class="line">    my @formats;</div>
<div class="line">    my %format_labels;  #  track sub names by format label</div>
<div class="line"><span class="preprocessor">    #  avoid double counting of options, and list is specified below</span></div>
<div class="line"><span class="preprocessor"></span>    my %done = (</div>
<div class="line">        list    =&gt; 1,</div>
<div class="line">        format  =&gt; 1,</div>
<div class="line">        file    =&gt; 1,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $sub (sort keys %subs) {</div>
<div class="line">        my %sub_args = $self-&gt;get_args (sub =&gt; $sub);</div>
<div class="line">        croak <span class="stringliteral">&quot;Metadata item &#39;format&#39; missing\n&quot;</span> <span class="keywordflow">if</span> not defined $sub_args{format};</div>
<div class="line"></div>
<div class="line">        my $params_array = $sub_args{parameters};</div>
<div class="line">        <span class="keywordflow">foreach</span> my $param_hash (@$params_array) {</div>
<div class="line">            my $name = $param_hash-&gt;{name};</div>
<div class="line">            <span class="keywordflow">if</span> (!exists $done{$name}) {  #  does not allow mixed options and defaults etc - first in, best dressed</div>
<div class="line">                push @export_sub_params, $param_hash;</div>
<div class="line">                $done{$name} ++;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        push @formats, $sub_args{format};</div>
<div class="line">        $format_labels{$sub_args{format}} = $sub; </div>
<div class="line">    }</div>
<div class="line">    @formats = sort @formats;</div>
<div class="line">    $self-&gt;move_to_front_of_list (list =&gt; \@formats, item =&gt; <span class="stringliteral">&#39;Delimited text&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my %args = (</div>
<div class="line">        parameters =&gt; [ {</div>
<div class="line">                name =&gt; <span class="stringliteral">&#39;file&#39;</span>,</div>
<div class="line">                type =&gt; <span class="stringliteral">&#39;file&#39;</span>,</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                name        =&gt; <span class="stringliteral">&#39;format&#39;</span>,</div>
<div class="line">                label_text  =&gt; <span class="stringliteral">&#39;What to export&#39;</span>,</div>
<div class="line">                type        =&gt; <span class="stringliteral">&#39;choice&#39;</span>,</div>
<div class="line">                choices     =&gt; \@formats,</div>
<div class="line">                <span class="keywordflow">default</span>     =&gt; 0,</div>
<div class="line">            },</div>
<div class="line">            @export_sub_params,</div>
<div class="line">        ],</div>
<div class="line">        format_labels =&gt; \%format_labels,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a7c8829e39557bc1fe04f7476d8644176"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::check_rand_function_is_valid </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-check_rand_function_is_valid' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-check_rand_function_is_valid-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-check_rand_function_is_valid-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-check_rand_function_is_valid-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in check_rand_function_is_valid: 17</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a7c8829e39557bc1fe04f7476d8644176">check_rand_function_is_valid</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    </div>
<div class="line">    my $function = $args{<span class="keyword">function</span>} <span class="comment">// &#39;&#39;;</span></div>
<div class="line"></div>
<div class="line">    my %rand_functions = $self-&gt;get_randomisation_functions;</div>
<div class="line"></div>
<div class="line">    my $valid = exists $rand_functions{$function};</div>
<div class="line"></div>
<div class="line">    croak <span class="stringliteral">&quot;Randomisation function $function is not one of &quot;</span></div>
<div class="line">          . join (<span class="stringliteral">&#39;, &#39;</span>, keys %rand_functions)</div>
<div class="line">          . <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">      <span class="keywordflow">if</span> !$valid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a5a9f5e148e3dbe23f4126cce416d13ad"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::compare_cluster_calcs_per_node </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-compare_cluster_calcs_per_node' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-compare_cluster_calcs_per_node-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-compare_cluster_calcs_per_node-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-compare_cluster_calcs_per_node-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in compare_cluster_calcs_per_node: 52</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a5a9f5e148e3dbe23f4126cce416d13ad">compare_cluster_calcs_per_node</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $orig_analysis = $args{orig_analysis};</div>
<div class="line">    my $analysis_args = $orig_analysis-&gt;get_param (<span class="stringliteral">&#39;ANALYSIS_ARGS&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> ! eval {$orig_analysis-&gt;is_tree_object};</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> !defined $analysis_args-&gt;{spatial_calculations};</div>
<div class="line"></div>
<div class="line">    my $bd      = $orig_analysis-&gt;get_basedata_ref;</div>
<div class="line">    my $rand_bd = $args{rand_bd};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  Get a clone of the cluster tree and attach it to the randomised basedata</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  Cloning via newick format clears all the params,</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  so avoids lingering basedata refs and the like</span></div>
<div class="line"><span class="preprocessor"></span>    require <a class="code" href="classBiodiverse_1_1ReadNexus.html">Biodiverse::ReadNexus</a>;</div>
<div class="line">    </div>
<div class="line">    my $read_nexus = Biodiverse::ReadNexus-&gt;<a class="code" href="classBiodiverse_1_1ReadNexus.html#a9bbeec85aa09937f72f5424d3ea799fa">new</a>;</div>
<div class="line">    $read_nexus-&gt;import_newick (data =&gt; $orig_analysis-&gt;to_newick);</div>
<div class="line">    my @tree_array = $read_nexus-&gt;get_tree_array;</div>
<div class="line">    my $clone = $tree_array[0];</div>
<div class="line">    bless $clone, blessed ($orig_analysis);</div>
<div class="line"></div>
<div class="line">    $clone-&gt;rename (new_name =&gt; $orig_analysis-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>) . <span class="stringliteral">&#39; rand sp_calc&#39;</span> . $args{rand_iter});</div>
<div class="line">    my %clone_analysis_args = %$analysis_args;</div>
<div class="line"><span class="preprocessor">    #$clone_analysis_args{spatial_calculations} = $args{spatial_calculations};</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (exists $clone_analysis_args{basedata_ref}) {</div>
<div class="line">        $clone_analysis_args{basedata_ref} = $rand_bd;  #  just in <span class="keywordflow">case</span></div>
<div class="line">    }</div>
<div class="line">    $clone-&gt;set_basedata_ref (BASEDATA_REF =&gt; $rand_bd);</div>
<div class="line">    $clone-&gt;set_param (ANALYSIS_ARGS =&gt; \%clone_analysis_args);</div>
<div class="line"></div>
<div class="line">    $clone-&gt;run_spatial_calculations (%clone_analysis_args);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($args{retain_outputs}) {</div>
<div class="line">        $rand_bd-&gt;add_output (<span class="keywordtype">object</span> =&gt; $clone);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  now we need to compare the orig and the rand</span></div>
<div class="line"><span class="preprocessor"></span>    my $result_list_name = $args{result_list_name};</div>
<div class="line">    eval {</div>
<div class="line">        $orig_analysis-&gt;compare (</div>
<div class="line">            comparison       =&gt; $clone,</div>
<div class="line">            result_list_name =&gt; $result_list_name,</div>
<div class="line">            no_track_node_stats =&gt; 1,</div>
<div class="line">        )</div>
<div class="line">    };</div>
<div class="line">    croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $clone;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="acd3c6644313aa3d9c9f3131c81608582"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::export </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-export' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-export-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-export-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-export-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in export: 14</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#acd3c6644313aa3d9c9f3131c81608582">export</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  get our own metadata...</span></div>
<div class="line"><span class="preprocessor"></span>    my %metadata = $self-&gt;get_args (sub =&gt; <span class="stringliteral">&#39;export&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $sub_to_use = $metadata{format_labels}{$args{format}} || croak <span class="stringliteral">&quot;Argument &#39;format&#39; not specified\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    eval {$self-&gt;$sub_to_use (%args)};</div>
<div class="line">    croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a729602bd59c231b84f79072a3177051d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::export_prng_current_state </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-export_prng_current_state' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-export_prng_current_state-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-export_prng_current_state-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-export_prng_current_state-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in export_prng_current_state: 16</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a729602bd59c231b84f79072a3177051d">export_prng_current_state</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $init_state = $self-&gt;get_param (<span class="stringliteral">&#39;RAND_LAST_STATE&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $filename = $args{file};</div>
<div class="line"></div>
<div class="line">    open (my $fh, <span class="charliteral">&#39;&gt;&#39;</span>, $filename) || croak <span class="stringliteral">&quot;Unable to open $filename\n&quot;</span>;</div>
<div class="line">    print {$fh} Data::Dumper::Dumper ($init_state);</div>
<div class="line">    $fh-&gt;close;</div>
<div class="line"></div>
<div class="line">    print <span class="stringliteral">&quot;[RANDOMISE] Dumped current PRNG state to $filename\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a010b59a4e46938d7d5a3ca081c7ea6d3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::export_prng_init_state </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-export_prng_init_state' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-export_prng_init_state-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-export_prng_init_state-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-export_prng_init_state-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in export_prng_init_state: 16</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a010b59a4e46938d7d5a3ca081c7ea6d3">export_prng_init_state</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $init_state = $self-&gt;get_param (<span class="stringliteral">&#39;RAND_INIT_STATE&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my $filename = $args{file};</div>
<div class="line"></div>
<div class="line">    open (my $fh, <span class="charliteral">&#39;&gt;&#39;</span>, $filename) || croak <span class="stringliteral">&quot;Unable to open $filename\n&quot;</span>;</div>
<div class="line">    print {$fh} Data::Dumper::Dumper ($init_state);</div>
<div class="line">    $fh-&gt;close;</div>
<div class="line"></div>
<div class="line">    print <span class="stringliteral">&quot;[RANDOMISE] Dumped initial PRNG state to $filename\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ac958e027d870d5d22396a44b2c22b0cc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_analysis_args_from_object </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_analysis_args_from_object' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_analysis_args_from_object-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_analysis_args_from_object-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_analysis_args_from_object-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_analysis_args_from_object: 26</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#ac958e027d870d5d22396a44b2c22b0cc">get_analysis_args_from_object</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line">    </div>
<div class="line">    my $object = $args{<span class="keywordtype">object</span>};</div>
<div class="line"></div>
<div class="line">    my $get_copy = $args{get_copy} <span class="comment">// 1;</span></div>
<div class="line"></div>
<div class="line">    my $analysis_args;</div>
<div class="line">    my $p_key;</div>
<div class="line">  ARGS_PARAM:</div>
<div class="line">    <span class="keywordflow">for</span> my $key (qw /ANALYSIS_ARGS SP_CALC_ARGS/) {</div>
<div class="line">        $analysis_args = $object-&gt;get_param ($key);</div>
<div class="line">        $p_key = $key;</div>
<div class="line">        last ARGS_PARAM <span class="keywordflow">if</span> defined $analysis_args;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $return_hash = $get_copy ? {%$analysis_args} : $analysis_args;</div>
<div class="line"></div>
<div class="line">    my @results = (</div>
<div class="line">        $p_key,</div>
<div class="line">        $return_hash,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? @results : \@results;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="aaaa6b6880f801f1530097e5ebd62e674"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_group_prop_metadata </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_group_prop_metadata' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_group_prop_metadata-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_group_prop_metadata-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_group_prop_metadata-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_group_prop_metadata: 13</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#aaaa6b6880f801f1530097e5ebd62e674">get_group_prop_metadata</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my %metadata = (</div>
<div class="line">        name =&gt; <span class="stringliteral">&#39;randomise_group_props_by&#39;</span>,</div>
<div class="line">        type =&gt; <span class="stringliteral">&#39;choice&#39;</span>,</div>
<div class="line">        choices =&gt; [qw /no_change by_set by_item/],</div>
<div class="line"><span class="preprocessor">        #default =&gt; 0,</span></div>
<div class="line"><span class="preprocessor"></span>        tooltip =&gt; $process_group_props_tooltip,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %metadata : \%metadata;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="af60b9997a005dd082432060b3e91651e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_metadata_export </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_metadata_export' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_metadata_export-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_metadata_export-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_metadata_export-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_metadata_export: 54</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#af60b9997a005dd082432060b3e91651e">get_metadata_export</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  need a list of export subs</span></div>
<div class="line"><span class="preprocessor"></span>    my %subs = $self-&gt;get_subs_with_prefix (prefix =&gt; <span class="stringliteral">&#39;export_&#39;</span>);</div>
<div class="line"></div>
<div class="line">    my @formats;</div>
<div class="line">    my %format_labels;  #  track sub names by format label</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  loop through subs and get their metadata</span></div>
<div class="line"><span class="preprocessor"></span>    my %params_per_sub;</div>
<div class="line"></div>
<div class="line">    LOOP_EXPORT_SUB:</div>
<div class="line">    <span class="keywordflow">foreach</span> my $sub (sort keys %subs) {</div>
<div class="line">        my %sub_args = $self-&gt;get_args (sub =&gt; $sub);</div>
<div class="line"></div>
<div class="line">        my $format = $sub_args{format};</div>
<div class="line"></div>
<div class="line">        croak <span class="stringliteral">&quot;Metadata item &#39;format&#39; missing\n&quot;</span></div>
<div class="line">            <span class="keywordflow">if</span> not defined $format;</div>
<div class="line"></div>
<div class="line">        $format_labels{$format} = $sub;</div>
<div class="line"></div>
<div class="line">        next LOOP_EXPORT_SUB</div>
<div class="line">            <span class="keywordflow">if</span> $sub_args{format} eq $EMPTY_STRING;</div>
<div class="line"></div>
<div class="line">        $params_per_sub{$format} = $sub_args{parameters};</div>
<div class="line"></div>
<div class="line">        my $params_array = $sub_args{parameters};</div>
<div class="line"></div>
<div class="line">        push @formats, $format;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    @formats = sort @formats;</div>
<div class="line">    $self-&gt;move_to_front_of_list (</div>
<div class="line">        list =&gt; \@formats,</div>
<div class="line">        item =&gt; <span class="stringliteral">&#39;Initial PRNG state&#39;</span></div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my %args = (</div>
<div class="line">        parameters     =&gt; \%params_per_sub,</div>
<div class="line">        format_choices =&gt; [{</div>
<div class="line">                name        =&gt; <span class="stringliteral">&#39;format&#39;</span>,</div>
<div class="line">                label_text  =&gt; <span class="stringliteral">&#39;Format to use&#39;</span>,</div>
<div class="line">                type        =&gt; <span class="stringliteral">&#39;choice&#39;</span>,</div>
<div class="line">                choices     =&gt; \@formats,</div>
<div class="line">                <span class="keywordflow">default</span>     =&gt; 0</div>
<div class="line">            },</div>
<div class="line">        ],</div>
<div class="line">        format_labels  =&gt; \%format_labels,</div>
<div class="line">    ); </div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a881cfa4541e1a447ac1a02d1802988be"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_metadata_export_prng_current_state </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_metadata_export_prng_current_state' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_metadata_export_prng_current_state-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_metadata_export_prng_current_state-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_metadata_export_prng_current_state-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_metadata_export_prng_current_state: 14</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a881cfa4541e1a447ac1a02d1802988be">get_metadata_export_prng_current_state</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my %args = (</div>
<div class="line">        format =&gt; <span class="stringliteral">&#39;Current PRNG state&#39;</span>,</div>
<div class="line">        parameters =&gt; [{</div>
<div class="line">                name       =&gt; <span class="stringliteral">&#39;file&#39;</span>,</div>
<div class="line">                type       =&gt; <span class="stringliteral">&#39;file&#39;</span></div>
<div class="line">            },</div>
<div class="line">        ],</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ac2375f48dafb8550d729109b342ac6f0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_metadata_export_prng_init_state </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_metadata_export_prng_init_state' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_metadata_export_prng_init_state-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_metadata_export_prng_init_state-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_metadata_export_prng_init_state-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_metadata_export_prng_init_state: 14</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#ac2375f48dafb8550d729109b342ac6f0">get_metadata_export_prng_init_state</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my %args = (</div>
<div class="line">        format =&gt; <span class="stringliteral">&#39;Initial PRNG state&#39;</span>,</div>
<div class="line">        parameters =&gt; [{</div>
<div class="line">                name       =&gt; <span class="stringliteral">&#39;file&#39;</span>,</div>
<div class="line">                type       =&gt; <span class="stringliteral">&#39;file&#39;</span></div>
<div class="line">            },</div>
<div class="line">        ],</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="aacb0920fdb0dad354975fe6115955dde"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_metadata_rand_csr_by_group </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_metadata_rand_csr_by_group' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_metadata_rand_csr_by_group-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_metadata_rand_csr_by_group-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_metadata_rand_csr_by_group-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_metadata_rand_csr_by_group: 17</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#aacb0920fdb0dad354975fe6115955dde">get_metadata_rand_csr_by_group</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $group_props_parameters  = $self-&gt;get_group_prop_metadata;</div>
<div class="line">    my $tree_shuffle_parameters = $self-&gt;get_tree_shuffle_metadata;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    my %args = (</div>
<div class="line">        Description =&gt; <span class="stringliteral">&#39;Complete spatial randomisation by group (currently ignores labels without a group)&#39;</span>,</div>
<div class="line">        parameters  =&gt; [</div>
<div class="line">            $group_props_parameters,</div>
<div class="line">            $tree_shuffle_parameters,</div>
<div class="line">        ],</div>
<div class="line">    ); </div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a73c76e4e45e27784da64871ee23cb12b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_metadata_rand_nochange </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_metadata_rand_nochange' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_metadata_rand_nochange-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_metadata_rand_nochange-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_metadata_rand_nochange-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_metadata_rand_nochange: 16</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a73c76e4e45e27784da64871ee23cb12b">get_metadata_rand_nochange</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    </div>
<div class="line">    my $group_props_parameters  = $self-&gt;get_group_prop_metadata;</div>
<div class="line">    my $tree_shuffle_parameters = $self-&gt;get_tree_shuffle_metadata;</div>
<div class="line"></div>
<div class="line">    my %args = (</div>
<div class="line">        Description =&gt; <span class="stringliteral">&#39;No change - just a cloned data set&#39;</span>,</div>
<div class="line">        parameters  =&gt; [</div>
<div class="line">            $group_props_parameters,</div>
<div class="line">            $tree_shuffle_parameters,</div>
<div class="line">        ],</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="abdda089ee61a5232e81c408872b0d479"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_metadata_rand_structured </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_metadata_rand_structured' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_metadata_rand_structured-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_metadata_rand_structured-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_metadata_rand_structured-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_metadata_rand_structured: 46</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#abdda089ee61a5232e81c408872b0d479">get_metadata_rand_structured</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $tooltip_mult =&lt;&lt;<span class="stringliteral">&#39;END_TOOLTIP_MULT&#39;</span></div>
<div class="line">The target richness of each group in the randomised</div>
<div class="line">basedata will be its original richness multiplied</div>
<div class="line">by <span class="keyword">this</span> value.</div>
<div class="line">END_TOOLTIP_MULT</div>
<div class="line">;</div>
<div class="line"></div>
<div class="line">    my $tooltip_addn =&lt;&lt;<span class="stringliteral">&#39;END_TOOLTIP_ADDN&#39;</span></div>
<div class="line">The target richness of each group in the randomised</div>
<div class="line">basedata will be its original richness plus <span class="keyword">this</span> value.</div>
<div class="line"></div>
<div class="line">This is applied after the multiplier parameter so you have:</div>
<div class="line">    target_richness = orig * multiplier + addition.</div>
<div class="line">END_TOOLTIP_ADDN</div>
<div class="line">;</div>
<div class="line"></div>
<div class="line">    my $group_props_parameters  = $self-&gt;get_group_prop_metadata;</div>
<div class="line">    my $tree_shuffle_parameters = $self-&gt;get_tree_shuffle_metadata;</div>
<div class="line"></div>
<div class="line">    my %args = (</div>
<div class="line">        parameters  =&gt; [ </div>
<div class="line">            {name       =&gt; <span class="stringliteral">&#39;richness_multiplier&#39;</span>,</div>
<div class="line">             type       =&gt; <span class="stringliteral">&#39;float&#39;</span>,</div>
<div class="line">             <span class="keywordflow">default</span>    =&gt; 1,</div>
<div class="line">             increment  =&gt; 1,</div>
<div class="line">             tooltip    =&gt; $tooltip_mult,</div>
<div class="line">             },</div>
<div class="line">            {name       =&gt; <span class="stringliteral">&#39;richness_addition&#39;</span>,</div>
<div class="line">             type       =&gt; <span class="stringliteral">&#39;float&#39;</span>,</div>
<div class="line">             <span class="keywordflow">default</span>    =&gt; 0,</div>
<div class="line">             increment  =&gt; 1,</div>
<div class="line">             tooltip    =&gt; $tooltip_addn,</div>
<div class="line">             },</div>
<div class="line">            $group_props_parameters,</div>
<div class="line">            $tree_shuffle_parameters,</div>
<div class="line">        ],</div>
<div class="line">        Description =&gt; <span class="stringliteral">&quot;Randomly allocate labels to groups,\n&quot;</span></div>
<div class="line">                       . <span class="stringliteral">&#39;but keep the richness the same or within &#39;</span></div>
<div class="line">                       . <span class="stringliteral">&#39;some multiplier factor.&#39;</span>,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %args : \%args;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a02da1528612ca98e2cb06eaa0bfaf707"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_randomisation_functions </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_randomisation_functions' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_randomisation_functions-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_randomisation_functions-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_randomisation_functions-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_randomisation_functions: 10</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a02da1528612ca98e2cb06eaa0bfaf707">get_randomisation_functions</a> {</div>
<div class="line">    my $self = shift || __PACKAGE__;</div>
<div class="line"></div>
<div class="line">    my %analyses = $self-&gt;get_subs_with_prefix (</div>
<div class="line">        prefix =&gt; <span class="stringliteral">&#39;rand_&#39;</span>,</div>
<div class="line">        <span class="keyword">class</span> =&gt; __PACKAGE__,</div>
<div class="line">    );</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %analyses : \%analyses;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a24b36bfb0d4bcb13ba1fe76292a882f6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::get_tree_shuffle_metadata </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_tree_shuffle_metadata' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-get_tree_shuffle_metadata-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_tree_shuffle_metadata-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_tree_shuffle_metadata-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in get_tree_shuffle_metadata: 19</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a24b36bfb0d4bcb13ba1fe76292a882f6">get_tree_shuffle_metadata</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    require <a class="code" href="classBiodiverse_1_1Tree.html">Biodiverse::Tree</a>;</div>
<div class="line">    my $tree = Biodiverse::Tree-&gt;<a class="code" href="classBiodiverse_1_1Tree.html#a7f0d728517492a2c984c5470f3a22c67">new</a>;</div>
<div class="line">    my @choices = sort keys %{$tree-&gt;get_subs_with_prefix (prefix =&gt; <span class="stringliteral">&#39;shuffle&#39;</span>)};</div>
<div class="line">    my $default = first_index {$_ =~ <span class="stringliteral">&#39;no_change$&#39;</span>} @choices;</div>
<div class="line">    @choices = map {(my $x = $_) =~ s/^shuffle_<span class="comment">//; $x} @choices;  #  strip the shuffle_ off the front</span></div>
<div class="line"></div>
<div class="line">    my %metadata = (</div>
<div class="line">        name =&gt; <span class="stringliteral">&#39;randomise_trees_by&#39;</span>,</div>
<div class="line">        type =&gt; <span class="stringliteral">&#39;choice&#39;</span>,</div>
<div class="line">        choices =&gt; \@choices,</div>
<div class="line">        <span class="keywordflow">default</span> =&gt; $default,</div>
<div class="line">        tooltip =&gt; $randomise_trees_tooltip,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> wantarray ? %metadata : \%metadata;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="addf6e4b1f317dcf41baf8e26271a52be"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::new </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-new' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-new-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-new-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-new-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in new: 27</span></div>
<div class="line"><span class="preprocessor"></span>sub <span class="keyword">new</span> {</div>
<div class="line">    my $class = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $self = bless {}, $class;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (defined $args{file}) {</div>
<div class="line">        my $file_loaded = $self-&gt;load_file (@_);</div>
<div class="line">        <span class="keywordflow">return</span> $file_loaded;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my %PARAMS = (  #  <span class="keywordflow">default</span> parameters to load.  These will be overwritten as needed.</div>
<div class="line">        OUTPFX              =&gt; <span class="stringliteral">&#39;BIODIVERSE_RANDOMISATION&#39;</span>,  #  not really used anymore</div>
<div class="line">        OUTSUFFIX           =&gt; <span class="stringliteral">&#39;brs&#39;</span>,</div>
<div class="line">        OUTSUFFIX_YAML      =&gt; <span class="stringliteral">&#39;bry&#39;</span>,</div>
<div class="line">        PARAM_CHANGE_WARN   =&gt; undef,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  load the defaults, with the rest of the args as params</span></div>
<div class="line"><span class="preprocessor"></span>    my %args_for = (%PARAMS, %args);</div>
<div class="line">    $self-&gt;set_params (%args_for);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  avoid memory leak probs with circular refs</span></div>
<div class="line"><span class="preprocessor"></span>    $self-&gt;weaken_basedata_ref;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $self;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a76a64be056c781a550df76914f81fbb6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::override_object_analysis_args </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-override_object_analysis_args' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-override_object_analysis_args-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-override_object_analysis_args-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-override_object_analysis_args-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in override_object_analysis_args: 44</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a76a64be056c781a550df76914f81fbb6">override_object_analysis_args</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $object = $args{<span class="keywordtype">object</span>};</div>
<div class="line">    my $cache  = $args{randomised_arg_object_cache};</div>
<div class="line">    my $iter   = $args{iteration};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  get a shallow clone</span></div>
<div class="line"><span class="preprocessor"></span>    my ($p_key, $new_analysis_args) = $self-&gt;get_analysis_args_from_object (</div>
<div class="line">        <span class="keywordtype">object</span> =&gt; $object,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $made_changes;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  The following process could be generalised to handle any of the object types</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    my $tree_shuffle_method = $args{randomise_trees_by} <span class="comment">// q{};</span></div>
<div class="line">    <span class="keywordflow">if</span> ($tree_shuffle_method &amp;&amp; $tree_shuffle_method !~ /^shuffle_/) {  #  add the shuffle prefix <span class="keywordflow">if</span> needed</div>
<div class="line">        $tree_shuffle_method = <span class="stringliteral">&#39;shuffle_&#39;</span> . $tree_shuffle_method;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $tree_ref_used = $new_analysis_args-&gt;{tree_ref};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($tree_ref_used &amp;&amp; $tree_shuffle_method &amp;&amp; $tree_shuffle_method !~ /no_change$/) {</div>
<div class="line">        my $shuffled_tree = $cache-&gt;{$tree_ref_used};</div>
<div class="line">        <span class="keywordflow">if</span> (!$shuffled_tree) {  # shuffle and cache <span class="keywordflow">if</span> we don<span class="stringliteral">&#39;t already have it</span></div>
<div class="line"><span class="stringliteral">            $shuffled_tree = $tree_ref_used-&gt;clone;</span></div>
<div class="line"><span class="stringliteral">            $shuffled_tree-&gt;$tree_shuffle_method (%args);</span></div>
<div class="line"><span class="stringliteral">            $shuffled_tree-&gt;rename (</span></div>
<div class="line"><span class="stringliteral">                new_name =&gt; $shuffled_tree-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;) . &#39;</span> <span class="stringliteral">&#39; . $iter,</span></div>
<div class="line"><span class="stringliteral">            );</span></div>
<div class="line"><span class="stringliteral">            $cache-&gt;{$tree_ref_used} = $shuffled_tree;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">        $new_analysis_args-&gt;{tree_ref} = $shuffled_tree;</span></div>
<div class="line"><span class="stringliteral">        $made_changes++;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    return 1 if ! $made_changes;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $object-&gt;set_param ($p_key =&gt; $new_analysis_args);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    return 1;</span></div>
<div class="line"><span class="stringliteral">}</span></div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a57ead009f007ec7747e8bd4dadcf7384"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::process_group_props </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-process_group_props' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-process_group_props-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-process_group_props-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-process_group_props-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in process_group_props: 21</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a57ead009f007ec7747e8bd4dadcf7384">process_group_props</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $orig_bd = $args{orig_bd};</div>
<div class="line">    my $rand_bd = $args{rand_bd};</div>
<div class="line"></div>
<div class="line">    my @keys = $orig_bd-&gt;get_groups_ref-&gt;get_element_property_keys;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keywordflow">if</span> !scalar @keys;</div>
<div class="line"></div>
<div class="line">    my $function = $args{<span class="keyword">function</span>};</div>
<div class="line">    <span class="keywordflow">if</span> (not $function =~ /^process_group_props_/) {</div>
<div class="line">        $function = <span class="stringliteral">&#39;process_group_props_&#39;</span> . $function;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    my $success = eval {$self-&gt;$function (%args)};</div>
<div class="line">    croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $success;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="af6a142d75d11b296a1b749b8dcb92357"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::process_group_props_by_item </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-process_group_props_by_item' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-process_group_props_by_item-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-process_group_props_by_item-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-process_group_props_by_item-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in process_group_props_by_item: 70</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#af6a142d75d11b296a1b749b8dcb92357">process_group_props_by_item</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $orig_bd = $args{orig_bd} || croak <span class="stringliteral">&quot;Missing orig_bd argument\n&quot;</span>;</div>
<div class="line">    my $rand_bd = $args{rand_bd} || croak <span class="stringliteral">&quot;Missing rand_bd argument\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my $rand  = $args{rand_object};</div>
<div class="line"></div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line"></div>
<div class="line">    my $elements_ref    = $orig_bd-&gt;get_groups_ref;</div>
<div class="line">    my $to_elements_ref = $rand_bd-&gt;get_groups_ref;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">foreach</span> my $to_element ($to_elements_ref-&gt;get_element_list) {</div>
<div class="line"><span class="preprocessor">        #  delete any existing lists - cleaner and safer than adding to them</span></div>
<div class="line"><span class="preprocessor"></span>        $to_elements_ref-&gt;delete_lists (</div>
<div class="line">            element =&gt; $to_element,</div>
<div class="line">            lists =&gt; [<span class="stringliteral">&#39;PROPERTIES&#39;</span>],</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $name        = $self-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>);</div>
<div class="line">    my $to_name     = $rand_bd-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>);</div>
<div class="line">    my $text        = <span class="stringliteral">&quot;Transferring group properties from $name to $to_name&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my $total_to_do = $elements_ref-&gt;get_element_count;</div>
<div class="line">    print <span class="stringliteral">&quot;[BASEDATA] Transferring group properties for $total_to_do\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my $count = 0;</div>
<div class="line">    my $i = -1;</div>
<div class="line"></div>
<div class="line">    my @to_element_list = sort $to_elements_ref-&gt;get_element_list;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> my $prop_key ($elements_ref-&gt;get_element_property_keys) {</div>
<div class="line"></div>
<div class="line">        my $shuffled_to_elements = $rand-&gt;shuffle ([@to_element_list]);  #  need a shuffled copy</div>
<div class="line"></div>
<div class="line">        BY_ELEMENT:</div>
<div class="line">        <span class="keywordflow">foreach</span> my $element ($elements_ref-&gt;get_element_list) {</div>
<div class="line">            $i++;</div>
<div class="line">            my $progress = $i / $total_to_do;</div>
<div class="line">            $progress_bar-&gt;update (</div>
<div class="line">                <span class="stringliteral">&quot;$text\n&quot;</span></div>
<div class="line">                . <span class="stringliteral">&quot;(label $i of $total_to_do)&quot;</span>,</div>
<div class="line">                $progress</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            my $to_element = shift @$shuffled_to_elements;</div>
<div class="line"></div>
<div class="line">            my $props = $elements_ref-&gt;get_list_values (</div>
<div class="line">                element =&gt; $element,</div>
<div class="line">                list =&gt; <span class="stringliteral">&#39;PROPERTIES&#39;</span></div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            next BY_ELEMENT <span class="keywordflow">if</span> ! defined $props;  #  none there</div>
<div class="line">            next BY_ELEMENT <span class="keywordflow">if</span> ! exists $props-&gt;{$prop_key};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  now add the value for this property</span></div>
<div class="line"><span class="preprocessor"></span>            $to_elements_ref-&gt;add_to_lists (</div>
<div class="line">                element    =&gt; $to_element,</div>
<div class="line">                PROPERTIES =&gt; {$prop_key =&gt; $props-&gt;{$prop_key}},</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            $count ++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $count; </div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a131ec1e86332fa6ba77cf921b39a09fa"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::process_group_props_by_set </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-process_group_props_by_set' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-process_group_props_by_set-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-process_group_props_by_set-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-process_group_props_by_set-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in process_group_props_by_set: 61</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a131ec1e86332fa6ba77cf921b39a09fa">process_group_props_by_set</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $orig_bd = $args{orig_bd} || croak <span class="stringliteral">&quot;Missing orig_bd argument\n&quot;</span>;</div>
<div class="line">    my $rand_bd = $args{rand_bd} || croak <span class="stringliteral">&quot;Missing rand_bd argument\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my $rand  = $args{rand_object};</div>
<div class="line"></div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line"></div>
<div class="line">    my $elements_ref    = $orig_bd-&gt;get_groups_ref;</div>
<div class="line">    my $to_elements_ref = $rand_bd-&gt;get_groups_ref;</div>
<div class="line"></div>
<div class="line">    my $name        = $self-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>);</div>
<div class="line">    my $to_name     = $rand_bd-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>);</div>
<div class="line">    my $text        = <span class="stringliteral">&quot;Transferring group properties from $name to $to_name&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my $total_to_do = $elements_ref-&gt;get_element_count;</div>
<div class="line">    print <span class="stringliteral">&quot;[BASEDATA] Transferring properties for $total_to_do groups\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my $count = 0;</div>
<div class="line">    my $i = -1;</div>
<div class="line"></div>
<div class="line">    my @to_element_list = sort $to_elements_ref-&gt;get_element_list;</div>
<div class="line">    my $shuffled_to_elements = $rand-&gt;shuffle (\@to_element_list);</div>
<div class="line"></div>
<div class="line">    BY_ELEMENT:</div>
<div class="line">    <span class="keywordflow">foreach</span> my $element (sort $elements_ref-&gt;get_element_list) {</div>
<div class="line">        $i++;</div>
<div class="line">        my $progress = $i / $total_to_do;</div>
<div class="line">        $progress_bar-&gt;update (</div>
<div class="line">            <span class="stringliteral">&quot;$text\n&quot;</span></div>
<div class="line">            . <span class="stringliteral">&quot;(label $i of $total_to_do)&quot;</span>,</div>
<div class="line">            $progress</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        my $to_element = shift @$shuffled_to_elements;</div>
<div class="line"></div>
<div class="line">        my $props = $elements_ref-&gt;get_list_values (</div>
<div class="line">            element =&gt; $element,</div>
<div class="line">            list =&gt; <span class="stringliteral">&#39;PROPERTIES&#39;</span></div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        next BY_ELEMENT <span class="keywordflow">if</span> ! defined $props;  #  none there</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  delete any existing lists - cleaner and safer than adding to them</span></div>
<div class="line"><span class="preprocessor"></span>        $to_elements_ref-&gt;delete_lists (</div>
<div class="line">            element =&gt; $to_element,</div>
<div class="line">            lists =&gt; [<span class="stringliteral">&#39;PROPERTIES&#39;</span>],</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        $to_elements_ref-&gt;add_to_lists (</div>
<div class="line">            element    =&gt; $to_element,</div>
<div class="line">            PROPERTIES =&gt; {%$props},  #  make sure it<span class="stringliteral">&#39;s a copy so bad things don&#39;</span>t happen</div>
<div class="line">        );</div>
<div class="line">        $count ++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $count; </div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="afa5c1939856878467a487632a9d5de7a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::process_group_props_no_change </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-process_group_props_no_change' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-process_group_props_no_change-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-process_group_props_no_change-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-process_group_props_no_change-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in process_group_props_no_change: 14</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#afa5c1939856878467a487632a9d5de7a">process_group_props_no_change</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $orig_bd = $args{orig_bd};</div>
<div class="line">    my $rand_bd = $args{rand_bd};</div>
<div class="line"></div>
<div class="line">    $orig_bd-&gt;transfer_group_properties (</div>
<div class="line">        %args,</div>
<div class="line">        receiver =&gt; $rand_bd,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a2a6d50214d9a22800bdc62c8af14a38b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::rand_csr_by_group </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-rand_csr_by_group' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-rand_csr_by_group-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-rand_csr_by_group-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-rand_csr_by_group-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in rand_csr_by_group: 55</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a2a6d50214d9a22800bdc62c8af14a38b">rand_csr_by_group</a> {  #  complete spatial randomness by group - just shuffles the subelement lists between elements</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_param (<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>) || $args{basedata_ref};</div>
<div class="line"></div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line"></div>
<div class="line">    my $rand = $args{rand_object};  #  can<span class="stringliteral">&#39;t store to all output formats and then recreate</span></div>
<div class="line"><span class="stringliteral">    delete $args{rand_object};</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $progress_text = &quot;rand_csr_by_group: complete spatial randomisation\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $new_bd = blessed($bd)-&gt;new ($bd-&gt;get_params_hash);</span></div>
<div class="line"><span class="stringliteral">    $new_bd-&gt;get_groups_ref-&gt;set_param ($bd-&gt;get_groups_ref-&gt;get_params_hash);</span></div>
<div class="line"><span class="stringliteral">    $new_bd-&gt;get_labels_ref-&gt;set_param ($bd-&gt;get_labels_ref-&gt;get_params_hash);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my @orig_groups = sort $bd-&gt;get_groups;</span></div>
<div class="line"><span class="stringliteral">    #  make sure shuffle does not work on the original data</span></div>
<div class="line"><span class="stringliteral">    my $randOrder = $rand-&gt;shuffle ([@orig_groups]);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    print &quot;[RANDOMISE] CSR Shuffling &quot;.(scalar @orig_groups).&quot; groups\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #print join (&quot;\n&quot;, @candidates) . &quot;\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $total_to_do = $#orig_groups;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    foreach my $i (0 .. $#orig_groups) {</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my $progress = $i / $total_to_do;</span></div>
<div class="line"><span class="stringliteral">        my $p_text</span></div>
<div class="line"><span class="stringliteral">            = &quot;$progress_text\n&quot;</span></div>
<div class="line"><span class="stringliteral">            . &quot;Shuffling labels from\n&quot;</span></div>
<div class="line"><span class="stringliteral">            . &quot;\t$orig_groups[$i]\nto\n\t$randOrder-&gt;[$i]\n&quot;</span></div>
<div class="line"><span class="stringliteral">            . &quot;(element $i of $total_to_do)&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $progress_bar-&gt;update (</span></div>
<div class="line"><span class="stringliteral">            $p_text,</span></div>
<div class="line"><span class="stringliteral">            $progress,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  create the group (this allows for empty groups with no labels)</span></div>
<div class="line"><span class="stringliteral">        $new_bd-&gt;add_element(group =&gt; $randOrder-&gt;[$i]);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  get the labels from the original group and assign them to the random group</span></div>
<div class="line"><span class="stringliteral">        my %tmp = $bd-&gt;get_labels_in_group_as_hash (group =&gt; $orig_groups[$i]);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        while (my ($label, $counts) = each %tmp) {</span></div>
<div class="line"><span class="stringliteral">            $new_bd-&gt;add_element(</span></div>
<div class="line"><span class="stringliteral">                label =&gt; $label,</span></div>
<div class="line"><span class="stringliteral">                group =&gt; $randOrder-&gt;[$i],</span></div>
<div class="line"><span class="stringliteral">                count =&gt; $counts,</span></div>
<div class="line"><span class="stringliteral">            );</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a208ce0305c83d6cb8ec57b9e0fd3d456"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::rand_nochange </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-rand_nochange' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-rand_nochange-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-rand_nochange-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-rand_nochange-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in rand_nochange: 13</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a208ce0305c83d6cb8ec57b9e0fd3d456">rand_nochange</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    print <span class="stringliteral">&quot;[RANDOMISE] Running &#39;no change&#39; randomisation\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_param (<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>) || $args{basedata_ref};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  create a clone with no outputs</span></div>
<div class="line"><span class="preprocessor"></span>    my $new_bd = $bd-&gt;clone (no_outputs =&gt; 1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $new_bd;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="ac77428aa58057432d385086d95f5f80f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::rand_structured </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-rand_structured' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-rand_structured-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-rand_structured-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-rand_structured-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in rand_structured: 249</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#ac77428aa58057432d385086d95f5f80f">rand_structured</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $start_time = [gettimeofday];</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_param (<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>)</div>
<div class="line">            || $args{basedata_ref};</div>
<div class="line"></div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line"></div>
<div class="line">    my $rand = $args{rand_object};  #  can<span class="stringliteral">&#39;t store to all output formats and then recreate</span></div>
<div class="line"><span class="stringliteral">    delete $args{rand_object};</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  need to get these from the ARGS param if available - should also croak if negative</span></div>
<div class="line"><span class="stringliteral">    my $multiplier = $args{richness_multiplier} || 1;</span></div>
<div class="line"><span class="stringliteral">    my $addition = $args{richness_addition} || 0;</span></div>
<div class="line"><span class="stringliteral">    my $name = $self-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $progress_text =&lt;&lt;&quot;END_PROGRESS_TEXT&quot;</span></div>
<div class="line"><span class="stringliteral">$name</span></div>
<div class="line"><span class="stringliteral">rand_structured:</span></div>
<div class="line"><span class="stringliteral">\trichness multiplier = $multiplier,</span></div>
<div class="line"><span class="stringliteral">\trichness addition = $addition</span></div>
<div class="line"><span class="stringliteral">END_PROGRESS_TEXT</span></div>
<div class="line"><span class="stringliteral">;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $new_bd = blessed($bd)-&gt;new ($bd-&gt;get_params_hash);</span></div>
<div class="line"><span class="stringliteral">    $new_bd-&gt;get_groups_ref-&gt;set_param ($bd-&gt;get_groups_ref-&gt;get_params_hash);</span></div>
<div class="line"><span class="stringliteral">    $new_bd-&gt;get_labels_ref-&gt;set_param ($bd-&gt;get_labels_ref-&gt;get_params_hash);</span></div>
<div class="line"><span class="stringliteral">    my $new_bd_name = $new_bd-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral">    $new_bd-&gt;rename (name =&gt; $new_bd_name . &quot;_&quot; . $name);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    print &quot;[RANDOMISE] Creating clone for destructive sampling\n&quot;;</span></div>
<div class="line"><span class="stringliteral">    $progress_bar-&gt;update (</span></div>
<div class="line"><span class="stringliteral">        &quot;$progress_text\n&quot;</span></div>
<div class="line"><span class="stringliteral">        . &quot;Creating clone for destructive sampling\n&quot;,</span></div>
<div class="line"><span class="stringliteral">        0.1,</span></div>
<div class="line"><span class="stringliteral">    );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  create a clone for destructive sampling</span></div>
<div class="line"><span class="stringliteral">    #  clear out the outputs - we seem to get a memory leak otherwise</span></div>
<div class="line"><span class="stringliteral">    my $cloned_bd = $bd-&gt;clone (no_outputs =&gt; 1);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $progress_bar-&gt;reset;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  make sure we randomly select from the same set of groups each time</span></div>
<div class="line"><span class="stringliteral">    my @sorted_groups = sort $bd-&gt;get_groups;</span></div>
<div class="line"><span class="stringliteral">    #  make sure shuffle does not work on the original data</span></div>
<div class="line"><span class="stringliteral">    my $rand_gp_order = $rand-&gt;shuffle ([@sorted_groups]);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my @sorted_labels = sort $bd-&gt;get_labels;</span></div>
<div class="line"><span class="stringliteral">    #  make sure shuffle does not work on the original data</span></div>
<div class="line"><span class="stringliteral">    my $rand_label_order = $rand-&gt;shuffle ([@sorted_labels]);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    printf &quot;[RANDOMISE] Richness Shuffling %s labels from %s groups\n&quot;,</span></div>
<div class="line"><span class="stringliteral">       scalar @sorted_labels, scalar @sorted_groups;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  generate a hash with the target richness values</span></div>
<div class="line"><span class="stringliteral">    my %target_richness;</span></div>
<div class="line"><span class="stringliteral">    my $i = 0;</span></div>
<div class="line"><span class="stringliteral">    my $total_to_do = scalar @sorted_groups;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    foreach my $group (@sorted_groups) {</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my $progress = $i / $total_to_do;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $progress_bar-&gt;update (</span></div>
<div class="line"><span class="stringliteral">            &quot;$progress_text\n&quot;</span></div>
<div class="line"><span class="stringliteral">            . &quot;Assigning richness targets\n&quot;</span></div>
<div class="line"><span class="stringliteral">            . int (100 * $i / $total_to_do)</span></div>
<div class="line"><span class="stringliteral">            . &#39;</span>%<span class="stringliteral">&#39;,</span></div>
<div class="line"><span class="stringliteral">              $progress,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  round down - could make this an option</span></div>
<div class="line"><span class="stringliteral">        $target_richness{$group} = floor (</span></div>
<div class="line"><span class="stringliteral">            $bd-&gt;get_richness (</span></div>
<div class="line"><span class="stringliteral">                element =&gt; $group</span></div>
<div class="line"><span class="stringliteral">            )</span></div>
<div class="line"><span class="stringliteral">              $multiplier</span></div>
<div class="line"><span class="stringliteral">            + $addition</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral">        $i++;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    $progress_bar-&gt;reset;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  algorithm:</span></div>
<div class="line"><span class="stringliteral">    #  pick a label at random and then scatter its occurrences across</span></div>
<div class="line"><span class="stringliteral">    #  other groups that don&#39;</span>t already contain it</div>
<div class="line"><span class="preprocessor">    #  and that does not exceed the richness threshold factor</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  (multiplied by the original richness)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    my @target_groups = $bd-&gt;get_groups;</div>
<div class="line">    my %all_target_groups</div>
<div class="line">        = $bd-&gt;array_to_hash_keys (list =&gt; \@target_groups);</div>
<div class="line">    my %filled_groups;</div>
<div class="line">    my %unfilled_groups = %target_richness;</div>
<div class="line">    my $last_filled = $EMPTY_STRING;</div>
<div class="line">    $i = 0;</div>
<div class="line">    $total_to_do = scalar @$rand_label_order;</div>
<div class="line">    print <span class="stringliteral">&quot;[RANDOMISE] Target is $total_to_do.  Running.\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    BY_LABEL:</div>
<div class="line">    <span class="keywordflow">foreach</span> my $label (@$rand_label_order) {</div>
<div class="line"></div>
<div class="line">        my $progress = $i / $total_to_do;</div>
<div class="line">        $progress_bar-&gt;update (</div>
<div class="line">            <span class="stringliteral">&quot;Allocating labels to groups\n&quot;</span></div>
<div class="line">            . <span class="stringliteral">&quot;$progress_text\n&quot;</span></div>
<div class="line">            . <span class="stringliteral">&quot;($i / $total_to_do)&quot;</span>,</div>
<div class="line">            $progress,</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        $i++;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        ###  get the new groups not containing this label</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        ###  - no point aiming for those that have it already</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        ###  call will croak if label does not exist, so default to a blank hash</span></div>
<div class="line"><span class="preprocessor"></span>        my $new_bd_has_label</div>
<div class="line">            = eval {$new_bd-&gt;get_groups_with_label_as_hash (label =&gt; $label)}</div>
<div class="line">            || {};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  cannot use $cloned_bd here, as it may not have the full set of groups yet</span></div>
<div class="line"><span class="preprocessor"></span>        my %target_groups = %all_target_groups;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  don&#39;t consider groups that are full or that already have this label</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (scalar keys %$new_bd_has_label) {</div>
<div class="line">            <span class="keyword">delete</span> @target_groups{keys %$new_bd_has_label} ;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        my $check = scalar keys %target_groups;</div>
<div class="line">        my $check2 = $check;</div>
<div class="line">        <span class="keywordflow">if</span> (scalar keys %filled_groups) {</div>
<div class="line">            <span class="keyword">delete</span> @target_groups{keys %filled_groups};</div>
<div class="line">            $check = scalar keys %target_groups;</div>
<div class="line">        }</div>
<div class="line">        @target_groups = sort keys %target_groups;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        ###  get the remaining original groups containing the original label.  Make sure it&#39;s a copy</span></div>
<div class="line"><span class="preprocessor"></span>        my %tmp</div>
<div class="line">            = $cloned_bd-&gt;get_groups_with_label_as_hash (label =&gt; $label);</div>
<div class="line">        my $tmp_rand_order = $rand-&gt;shuffle ([keys %tmp]);</div>
<div class="line"></div>
<div class="line">        BY_GROUP:</div>
<div class="line">        <span class="keywordflow">foreach</span> my $from_group (@$tmp_rand_order) {</div>
<div class="line">            my $count = $tmp{$from_group};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  select a group at random to assign to</span></div>
<div class="line"><span class="preprocessor"></span>            my $j = int ($rand-&gt;rand (scalar @target_groups));</div>
<div class="line">            my $to_group = $target_groups[$j];</div>
<div class="line"><span class="preprocessor">            #  make sure we don&#39;t select this group again</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">            #  for this label this time round</span></div>
<div class="line"><span class="preprocessor"></span>            splice (@target_groups, $j, 1);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  drop out criterion, occurs when $richness_multiplier &lt; 1</span></div>
<div class="line"><span class="preprocessor"></span>            last BY_GROUP <span class="keywordflow">if</span> not defined $to_group;  </div>
<div class="line"></div>
<div class="line">            warn <span class="stringliteral">&quot;SELECTING GROUP THAT IS ALREADY FULL $to_group,&quot;</span></div>
<div class="line">                 . <span class="stringliteral">&quot;$filled_groups{$to_group}, $target_richness{$to_group}, &quot;</span></div>
<div class="line">                 . <span class="stringliteral">&quot;$check $check2 :: $i\n&quot;</span></div>
<div class="line">                    <span class="keywordflow">if</span> defined $to_group and exists $filled_groups{$to_group};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            # assign this label to its new group</span></div>
<div class="line"><span class="preprocessor"></span>            $new_bd-&gt;add_element (</div>
<div class="line">                label =&gt; $label,</div>
<div class="line">                group =&gt; $to_group,</div>
<div class="line">                count =&gt; $count,</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  now delete it from the list of candidates</span></div>
<div class="line"><span class="preprocessor"></span>            $cloned_bd-&gt;delete_sub_element (</div>
<div class="line">                label =&gt; $label,</div>
<div class="line">                group =&gt; $from_group,</div>
<div class="line">            );</div>
<div class="line">            <span class="keyword">delete</span> $tmp{$from_group};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  check if we&#39;ve filled this group.</span></div>
<div class="line"><span class="preprocessor"></span>            my $richness = $new_bd-&gt;get_richness (element =&gt; $to_group);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> ($richness &gt;= $target_richness{$to_group}) {</div>
<div class="line"></div>
<div class="line">                warn <span class="stringliteral">&quot;ISSUES $to_group $richness &gt; $target_richness{$to_group}\n&quot;</span></div>
<div class="line">                    <span class="keywordflow">if</span> ($richness &gt; $target_richness{$to_group});</div>
<div class="line"></div>
<div class="line">                $filled_groups{$to_group} = $richness;</div>
<div class="line">                <span class="keyword">delete</span> $unfilled_groups{$to_group};</div>
<div class="line">                $last_filled = $to_group;</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            last BY_GROUP <span class="keywordflow">if</span> scalar @target_groups == 0;  #  no more targets <span class="keywordflow">for</span> <span class="keyword">this</span> label, move to next label</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    my $target_label_count = $cloned_bd-&gt;get_label_count;</div>
<div class="line">    my $target_group_count = $cloned_bd-&gt;get_group_count;</div>
<div class="line"></div>
<div class="line">    my $format</div>
<div class="line">        = <span class="stringliteral">&quot;[RANDOMISE] \n&quot;</span></div>
<div class="line">          . <span class="stringliteral">&quot;New: gps filled, gps unfilled. Old: labels to assign, gps not emptied\n&quot;</span></div>
<div class="line">          .<span class="stringliteral">&quot;\t%d\t\t%d\t\t%d\t\t%d\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">    printf $format,</div>
<div class="line">           (scalar keys %filled_groups),</div>
<div class="line">           (scalar keys %unfilled_groups),</div>
<div class="line">           $target_label_count,</div>
<div class="line">           $target_group_count;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  need to fill in the missing groups with empties</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> ($bd-&gt;get_group_count != $new_bd-&gt;get_group_count) {</div>
<div class="line">        my %target_gps;</div>
<div class="line">        @target_gps{$bd-&gt;get_groups} = ((undef) x $bd-&gt;get_group_count);</div>
<div class="line">        <span class="keyword">delete</span> @target_gps{$new_bd-&gt;get_groups};</div>
<div class="line"></div>
<div class="line">        my $count = scalar keys %target_gps;</div>
<div class="line">        print <span class="stringliteral">&#39;[Randomise structured] &#39;</span></div>
<div class="line">              . <span class="stringliteral">&quot;Creating $count empty groups in new basedata\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">foreach</span> my $gp (keys %target_gps) {</div>
<div class="line">            $new_bd-&gt;add_element (group =&gt; $gp);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    $self-&gt;swap_to_reach_targets (</div>
<div class="line">        basedata_ref    =&gt; $bd,</div>
<div class="line">        cloned_bd       =&gt; $cloned_bd,</div>
<div class="line">        new_bd          =&gt; $new_bd,</div>
<div class="line">        filled_groups   =&gt; \%filled_groups,</div>
<div class="line">        unfilled_groups =&gt; \%unfilled_groups,</div>
<div class="line">        rand_object     =&gt; $rand,</div>
<div class="line">        target_richness =&gt; \%target_richness,</div>
<div class="line">        progress_text   =&gt; $progress_text,</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    $bd-&gt;transfer_label_properties (</div>
<div class="line">        %args,</div>
<div class="line">        receiver =&gt; $new_bd</div>
<div class="line">    );</div>
<div class="line"></div>
<div class="line">    my $time_taken = sprintf <span class="stringliteral">&quot;%d&quot;</span>, tv_interval ($start_time);</div>
<div class="line">    print <span class="stringliteral">&quot;[RANDOMISE] Time taken for rand_structured: $time_taken seconds\n&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  we used to have a memory leak somewhere, but this doesn&#39;t hurt anyway.    </span></div>
<div class="line"><span class="preprocessor"></span>    $cloned_bd = undef;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $new_bd;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a31fea1bba658013ac36b8fc3d3baa3e4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::run_analysis </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_analysis' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_analysis-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_analysis-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_analysis-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_analysis: 8</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a31fea1bba658013ac36b8fc3d3baa3e4">run_analysis</a> {  #  flick them straight through</div>
<div class="line">    my $self = shift;</div>
<div class="line"></div>
<div class="line">    my $success = eval {$self-&gt;run_randomisation  (@_)};</div>
<div class="line">    croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> $success;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a6770c3735a99a10b4aaf7ca1e6348e3e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::run_randomisation </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-run_randomisation' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-run_randomisation-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-run_randomisation-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-run_randomisation-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in run_randomisation: 266</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a6770c3735a99a10b4aaf7ca1e6348e3e">run_randomisation</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_param (<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>) || $args{basedata_ref};</div>
<div class="line"></div>
<div class="line">    my $function = $self-&gt;get_param (<span class="stringliteral">&#39;FUNCTION&#39;</span>)</div>
<div class="line">                   <span class="comment">// $args{function}</span></div>
<div class="line">                   <span class="comment">// croak &quot;Randomisation function not specified\n&quot;;</span></div>
<div class="line">    $self-&gt;check_rand_function_is_valid (<span class="keyword">function</span> =&gt; $function);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">delete</span> $args{<span class="keyword">function</span>};  #  don<span class="stringliteral">&#39;t want to pass unnecessary args on to the function</span></div>
<div class="line"><span class="stringliteral">    $self-&gt;set_param (FUNCTION =&gt; $function);  #  store it</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $iterations = $args{iterations} || 1;</span></div>
<div class="line"><span class="stringliteral">    delete $args{iterations};</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $max_iters = $args{max_iters};</span></div>
<div class="line"><span class="stringliteral">    delete $args{max_iters};</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #print &quot;\n\n\nMAXITERS IS $max_iters\n\n\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  load any predefined args - overriding user specified ones</span></div>
<div class="line"><span class="stringliteral">    my $ref = $self-&gt;get_param (&#39;</span>ARGS<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral">    if (defined $ref) {</span></div>
<div class="line"><span class="stringliteral">        %args = %$ref;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral">    else {</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;set_param (ARGS =&gt; \%args);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $rand_object = $self-&gt;initialise_rand (%args);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  get a list of refs for objects that are to be compared</span></div>
<div class="line"><span class="stringliteral">    #  get the lot by default</span></div>
<div class="line"><span class="stringliteral">    my @targets = defined $args{targets}</span></div>
<div class="line"><span class="stringliteral">                ? @{$args{targets}}</span></div>
<div class="line"><span class="stringliteral">                : ($bd-&gt;get_cluster_output_refs,</span></div>
<div class="line"><span class="stringliteral">                   $bd-&gt;get_spatial_output_refs,</span></div>
<div class="line"><span class="stringliteral">                   );</span></div>
<div class="line"><span class="stringliteral">    delete $args{targets};</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  loop through and get all the key/value pairs that are not refs.</span></div>
<div class="line"><span class="stringliteral">    #  Assume these are arguments to the randomisation</span></div>
<div class="line"><span class="stringliteral">    my $scalar_args = $EMPTY_STRING;</span></div>
<div class="line"><span class="stringliteral">    foreach my $key (sort keys %args) {</span></div>
<div class="line"><span class="stringliteral">        my $val = $args{$key};</span></div>
<div class="line"><span class="stringliteral">        $val = &#39;</span>undef<span class="stringliteral">&#39; if not defined $val;</span></div>
<div class="line"><span class="stringliteral">        if (not ref ($val)) {</span></div>
<div class="line"><span class="stringliteral">            $scalar_args .= &quot;$key=&gt;$val,&quot;;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral">    $scalar_args =~ s/,$//;  #  remove any trailing comma</span></div>
<div class="line"><span class="stringliteral">    #say &quot;\n\n++++++++++++++++++++++++&quot;;</span></div>
<div class="line"><span class="stringliteral">    #say &#39;</span>[RANDOMISE] Scalar arguments are <span class="stringliteral">&#39; . $scalar_args;</span></div>
<div class="line"><span class="stringliteral">    #say &quot;++++++++++++++++++++++++\n\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $results_list_name</span></div>
<div class="line"><span class="stringliteral">        = $self-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;)</span></div>
<div class="line"><span class="stringliteral">        || $args{results_list_name}</span></div>
<div class="line"><span class="stringliteral">        || uc (</span></div>
<div class="line"><span class="stringliteral">            $function   #  add the args to the list name</span></div>
<div class="line"><span class="stringliteral">            . (length $scalar_args</span></div>
<div class="line"><span class="stringliteral">                ? &quot;_$scalar_args&quot;</span></div>
<div class="line"><span class="stringliteral">                : $EMPTY_STRING)</span></div>
<div class="line"><span class="stringliteral">            );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  need to stop these being overridden by later calls</span></div>
<div class="line"><span class="stringliteral">    my $randomise_group_props_by = $args{randomise_group_props_by} // &#39;</span>no_change<span class="stringliteral">&#39;;</span></div>
<div class="line"><span class="stringliteral">    my $randomise_trees_by       = $args{randomise_trees_by} // &#39;</span>no_change<span class="stringliteral">&#39;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  counts are stored on the outputs, as they can be different if</span></div>
<div class="line"><span class="stringliteral">    #    an output is created after some randomisations have been run</span></div>
<div class="line"><span class="stringliteral">    my $rand_iter_param_name = &quot;RAND_ITER_$results_list_name&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $total_iterations = $self-&gt;get_param_as_ref (&#39;</span>TOTAL_ITERATIONS<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral">    if (! defined $total_iterations) {</span></div>
<div class="line"><span class="stringliteral">        $self-&gt;set_param (TOTAL_ITERATIONS =&gt; 0);</span></div>
<div class="line"><span class="stringliteral">        $total_iterations = $self-&gt;get_param_as_ref (&#39;</span>TOTAL_ITERATIONS<span class="stringliteral">&#39;);</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    my $return_success_code = 1;</span></div>
<div class="line"><span class="stringliteral">    my @rand_bd_array;  #  populated if return_rand_bd_array is true</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    #  do stuff here</span></div>
<div class="line"><span class="stringliteral">    ITERATION:</span></div>
<div class="line"><span class="stringliteral">    foreach my $i (1 .. $iterations) {</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        if ($max_iters &amp;&amp; $$total_iterations &gt;= $max_iters) {</span></div>
<div class="line"><span class="stringliteral">            print &quot;[RANDOMISE] Maximum iteration count reached: $max_iters\n&quot;;</span></div>
<div class="line"><span class="stringliteral">            $return_success_code = 2;</span></div>
<div class="line"><span class="stringliteral">            last ITERATION;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $$total_iterations++;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        print &quot;[RANDOMISE] $results_list_name iteration $$total_iterations &quot;</span></div>
<div class="line"><span class="stringliteral">            . &quot;($i of $iterations this run)\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my $rand_bd = eval {</span></div>
<div class="line"><span class="stringliteral">            $self-&gt;$function (</span></div>
<div class="line"><span class="stringliteral">                %args,</span></div>
<div class="line"><span class="stringliteral">                rand_object =&gt; $rand_object,</span></div>
<div class="line"><span class="stringliteral">                rand_iter   =&gt; $$total_iterations,</span></div>
<div class="line"><span class="stringliteral">            );</span></div>
<div class="line"><span class="stringliteral">        };</span></div>
<div class="line"><span class="stringliteral">        croak $EVAL_ERROR if $EVAL_ERROR || ! defined $rand_bd;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $rand_bd-&gt;rename (</span></div>
<div class="line"><span class="stringliteral">            name =&gt; $bd-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;) . &#39;</span>_<span class="stringliteral">&#39; . $function . &#39;</span>_<span class="stringliteral">&#39; . $$total_iterations,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        $self-&gt;process_group_props (</span></div>
<div class="line"><span class="stringliteral">            orig_bd  =&gt; $bd,</span></div>
<div class="line"><span class="stringliteral">            rand_bd  =&gt; $rand_bd,</span></div>
<div class="line"><span class="stringliteral">            function =&gt; $randomise_group_props_by,</span></div>
<div class="line"><span class="stringliteral">            rand_object =&gt; $rand_object,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        my %randomised_arg_object_cache;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        TARGET:</span></div>
<div class="line"><span class="stringliteral">        foreach my $target (@targets) {</span></div>
<div class="line"><span class="stringliteral">            my $rand_analysis;</span></div>
<div class="line"><span class="stringliteral">            print &quot;target: &quot;, $target-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;) || $target, &quot;\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            next TARGET if ! defined $target;</span></div>
<div class="line"><span class="stringliteral">            if (! $target-&gt;can(&#39;</span><a class="code" href="classBiodiverse_1_1Randomise.html#a31fea1bba658013ac36b8fc3d3baa3e4">run_analysis</a><span class="stringliteral">&#39;)) {</span></div>
<div class="line"><span class="stringliteral">                #if (! $args{retain_outputs}) {</span></div>
<div class="line"><span class="stringliteral">                #    $rand_bd-&gt;delete_output (output =&gt; $rand_analysis);</span></div>
<div class="line"><span class="stringliteral">                #}</span></div>
<div class="line"><span class="stringliteral">                next TARGET;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">            #  allow for older versions that did not flag this</span></div>
<div class="line"><span class="stringliteral">            my $completed = $target-&gt;get_param (&#39;</span>COMPLETED<span class="stringliteral">&#39;) // 1;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            next TARGET if not $completed;  # skip this one, no analyses that worked</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            my $rand_count</span></div>
<div class="line"><span class="stringliteral">                = $i + ($target-&gt;get_param($rand_iter_param_name) || 0);</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            my $name</span></div>
<div class="line"><span class="stringliteral">                = $target-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;) . &quot; Randomise $$total_iterations&quot;;</span></div>
<div class="line"><span class="stringliteral">            my $progress_text</span></div>
<div class="line"><span class="stringliteral">                = $target-&gt;get_param (&#39;</span>NAME<span class="stringliteral">&#39;) . &quot;\nRandomise $$total_iterations&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            #  create a new object of the same class</span></div>
<div class="line"><span class="stringliteral">            my %params = $target-&gt;get_params_hash;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            #  create the object and add it</span></div>
<div class="line"><span class="stringliteral">            $rand_analysis = ref ($target)-&gt;new (</span></div>
<div class="line"><span class="stringliteral">                %params,</span></div>
<div class="line"><span class="stringliteral">                NAME =&gt; $name,</span></div>
<div class="line"><span class="stringliteral">            );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            my $check = $rand_bd-&gt;add_output (</span></div>
<div class="line"><span class="stringliteral">                #%params,</span></div>
<div class="line"><span class="stringliteral">                name    =&gt; $name,</span></div>
<div class="line"><span class="stringliteral">                object  =&gt; $rand_analysis,</span></div>
<div class="line"><span class="stringliteral">            );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            #  ensure we use the same PRNG sequence and recreate cluster matrices</span></div>
<div class="line"><span class="stringliteral">            #  HACK...</span></div>
<div class="line"><span class="stringliteral">            my $rand_state = $target-&gt;get_param(&#39;</span>RAND_INIT_STATE<span class="stringliteral">&#39;) || [];</span></div>
<div class="line"><span class="stringliteral">            $rand_analysis-&gt;set_param(RAND_LAST_STATE =&gt; [@$rand_state]);</span></div>
<div class="line"><span class="stringliteral">            my $is_tree_object = eval {$rand_analysis-&gt;is_tree_object};</span></div>
<div class="line"><span class="stringliteral">            if ($is_tree_object) {</span></div>
<div class="line"><span class="stringliteral">                $rand_analysis-&gt;delete_params (qw /ORIGINAL_MATRICES ORIGINAL_SHADOW_MATRIX/);</span></div>
<div class="line"><span class="stringliteral">                eval {$rand_analysis-&gt;override_cached_spatial_calculations_arg};  #  override cluster calcs per node</span></div>
<div class="line"><span class="stringliteral">                $rand_analysis-&gt;set_param(NO_ADD_MATRICES_TO_BASEDATA =&gt; 1);  #  Avoid adding cluster matrices</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            eval {</span></div>
<div class="line"><span class="stringliteral">                $self-&gt;override_object_analysis_args (</span></div>
<div class="line"><span class="stringliteral">                    %args,</span></div>
<div class="line"><span class="stringliteral">                    randomised_arg_object_cache =&gt; \%randomised_arg_object_cache,</span></div>
<div class="line"><span class="stringliteral">                    object      =&gt; $rand_analysis,</span></div>
<div class="line"><span class="stringliteral">                    rand_object =&gt; $rand_object,</span></div>
<div class="line"><span class="stringliteral">                    iteration   =&gt; $$total_iterations,</span></div>
<div class="line"><span class="stringliteral">                );</span></div>
<div class="line"><span class="stringliteral">            };</span></div>
<div class="line"><span class="stringliteral">            croak $EVAL_ERROR if $EVAL_ERROR;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            eval {</span></div>
<div class="line"><span class="stringliteral">                $rand_analysis-&gt;run_analysis (</span></div>
<div class="line"><span class="stringliteral">                    progress_text   =&gt; $progress_text,</span></div>
<div class="line"><span class="stringliteral">                    use_nbrs_from   =&gt; $target,</span></div>
<div class="line"><span class="stringliteral">                );</span></div>
<div class="line"><span class="stringliteral">            };</span></div>
<div class="line"><span class="stringliteral">            croak $EVAL_ERROR if $EVAL_ERROR;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            eval {</span></div>
<div class="line"><span class="stringliteral">                $target-&gt;compare (</span></div>
<div class="line"><span class="stringliteral">                    comparison       =&gt; $rand_analysis,</span></div>
<div class="line"><span class="stringliteral">                    result_list_name =&gt; $results_list_name,</span></div>
<div class="line"><span class="stringliteral">                )</span></div>
<div class="line"><span class="stringliteral">            };</span></div>
<div class="line"><span class="stringliteral">            croak $EVAL_ERROR if $EVAL_ERROR;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            #  Does nothing if not a cluster type analysis</span></div>
<div class="line"><span class="stringliteral">            eval {</span></div>
<div class="line"><span class="stringliteral">                $self-&gt;compare_cluster_calcs_per_node (</span></div>
<div class="line"><span class="stringliteral">                    orig_analysis  =&gt; $target,</span></div>
<div class="line"><span class="stringliteral">                    rand_bd        =&gt; $rand_bd,</span></div>
<div class="line"><span class="stringliteral">                    rand_iter      =&gt; $$total_iterations,</span></div>
<div class="line"><span class="stringliteral">                    retain_outputs =&gt; $args{retain_outputs},</span></div>
<div class="line"><span class="stringliteral">                    result_list_name =&gt; $results_list_name,</span></div>
<div class="line"><span class="stringliteral">                );</span></div>
<div class="line"><span class="stringliteral">            };</span></div>
<div class="line"><span class="stringliteral">            croak $EVAL_ERROR if $EVAL_ERROR;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            #  and now remove this output to save a bit of memory</span></div>
<div class="line"><span class="stringliteral">            #  unless we&#39;</span>ve been told to keep it</div>
<div class="line"><span class="preprocessor">            #  (this has not been exposed to the GUI yet)</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">if</span> (! $args{retain_outputs}) {</div>
<div class="line"><span class="preprocessor">                #$rand_bd-&gt;delete_output (output =&gt; $rand_analysis);</span></div>
<div class="line"><span class="preprocessor"></span>                $rand_bd-&gt;delete_all_outputs();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  this argument is not yet exposed to the GUI</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> ($args{save_rand_bd}) {</div>
<div class="line">            print <span class="stringliteral">&quot;[Randomise] Saving randomised basedata\n&quot;</span>;</div>
<div class="line">            $rand_bd-&gt;save;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> ($args{return_rand_bd_array}) {</div>
<div class="line">            push @rand_bd_array, $rand_bd;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  save incremental basedata file</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (   defined $args{save_checkpoint}</div>
<div class="line">            &amp;&amp; $$total_iterations =~ /$args{save_checkpoint}$/</div>
<div class="line">            ) {</div>
<div class="line"></div>
<div class="line">            print <span class="stringliteral">&quot;[Randomise] Saving incremental basedata\n&quot;</span>;</div>
<div class="line">            my $file_name = $bd-&gt;get_param (<span class="stringliteral">&#39;NAME&#39;</span>);</div>
<div class="line">            $file_name .= <span class="charliteral">&#39;_&#39;</span> . $function . <span class="stringliteral">&#39;_iter_&#39;</span> . $$total_iterations;</div>
<div class="line">            eval {</div>
<div class="line">                $bd-&gt;save (filename =&gt; $file_name);</div>
<div class="line">            };</div>
<div class="line">            croak $EVAL_ERROR <span class="keywordflow">if</span> $EVAL_ERROR;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  now we&#39;re done, increment the randomisation counts</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $target (@targets) {</div>
<div class="line">        my $count = $target-&gt;get_param ($rand_iter_param_name) || 0;</div>
<div class="line">        $count += $iterations;</div>
<div class="line">        $target-&gt;set_param ($rand_iter_param_name =&gt; $count);</div>
<div class="line"><span class="preprocessor">        #eval {$target-&gt;clear_lists_across_elements_cache};</span></div>
<div class="line"><span class="preprocessor"></span>    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  and keep a track of the randomisation state,</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  even though we are storing the object</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  this is just in case YAML will not work with MT::Auto</span></div>
<div class="line"><span class="preprocessor"></span>    $self-&gt;store_rand_state (rand_object =&gt; $rand_object);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  return the rand_bd&#39;s if told to</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> wantarray ? @rand_bd_array : \@rand_bd_array</div>
<div class="line">      <span class="keywordflow">if</span> $args{return_rand_bd_array};</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    #  return 1 if successful and ran some iterations</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  return 2 if successful but did not need to run anything</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> $return_success_code;</div>
<div class="line">}</div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<a class="anchor" id="a68da97c0e6983b484443cd9bd27987c5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Biodiverse::Randomise::swap_to_reach_targets </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method  
<div id='codesection-swap_to_reach_targets' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
    <img id='codesection-swap_to_reach_targets-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-swap_to_reach_targets-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-swap_to_reach_targets-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in swap_to_reach_targets: 271</span></div>
<div class="line"><span class="preprocessor"></span>sub <a class="code" href="classBiodiverse_1_1Randomise.html#a68da97c0e6983b484443cd9bd27987c5">swap_to_reach_targets</a> {</div>
<div class="line">    my $self = shift;</div>
<div class="line">    my %args = @_;</div>
<div class="line"></div>
<div class="line">    my $cloned_bd       = $args{cloned_bd};</div>
<div class="line">    my $new_bd          = $args{new_bd};</div>
<div class="line">    my %filled_groups   = %{$args{filled_groups}};</div>
<div class="line">    my %unfilled_groups = %{$args{unfilled_groups}};</div>
<div class="line">    my %target_richness = %{$args{target_richness}};</div>
<div class="line">    my $rand            = $args{rand_object};</div>
<div class="line">    my $progress_text   = $args{progress_text};</div>
<div class="line"></div>
<div class="line">    my $bd = $self-&gt;get_param (<span class="stringliteral">&#39;BASEDATA_REF&#39;</span>)</div>
<div class="line">             || $args{basedata_ref};</div>
<div class="line">    my $progress_bar = <a class="code" href="classBiodiverse_1_1Progress.html">Biodiverse::Progress</a>-&gt;<a class="code" href="classBiodiverse_1_1Progress.html#a88f4cef6f66986952a850fb70a2b62d8">new</a>();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  and now we do some amazing cell swapping work to</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #  shunt labels in and out of groups until we&#39;re happy</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">    #  algorithm:</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #   Select an unassigned label.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #   Find a group that does not contain it.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #   Swap this label with one of the labels in the group if it is full.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #   Repeat until we have no more to assign or all groups are full</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    my $total_to_do =   (scalar keys %filled_groups)</div>
<div class="line">                      + (scalar keys %unfilled_groups);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ($total_to_do) {</div>
<div class="line">        print <span class="stringliteral">&quot;[RANDOMISE] Swapping labels to reach richness targets\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    my $swap_count = 0;</div>
<div class="line">    my $last_filled = $EMPTY_STRING;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #  keep going until we&#39;ve reached the fill threshold for each group</span></div>
<div class="line"><span class="preprocessor"></span>    BY_UNFILLED_GP:</div>
<div class="line">    <span class="keywordflow">while</span> (scalar keys %unfilled_groups) {</div>
<div class="line"></div>
<div class="line">        my $target_label_count = $cloned_bd-&gt;get_label_count;</div>
<div class="line">        my $target_group_count = $cloned_bd-&gt;get_group_count; </div>
<div class="line"></div>
<div class="line">        my $precision = <span class="stringliteral">&#39;%8d&#39;</span>;</div>
<div class="line">        my $fmt = <span class="stringliteral">&quot;Total gps:\t\t\t$precision\n&quot;</span></div>
<div class="line">                    . <span class="stringliteral">&quot;Unfilled groups:\t\t$precision\n&quot;</span></div>
<div class="line">                    . <span class="stringliteral">&quot;Filled groups:\t\t$precision\n&quot;</span></div>
<div class="line">                    . <span class="stringliteral">&quot;Labels to assign:\t\t$precision\n&quot;</span></div>
<div class="line">                    . <span class="stringliteral">&quot;Old gps to empty:\t$precision\n&quot;</span></div>
<div class="line">                    . <span class="stringliteral">&quot;Swap count:\t\t\t$precision\n&quot;</span></div>
<div class="line">                    . <span class="stringliteral">&quot;Last group filled: %s\n&quot;</span>;</div>
<div class="line">        my $check_text</div>
<div class="line">            = sprintf $fmt,</div>
<div class="line">                $total_to_do,</div>
<div class="line">                (scalar keys %unfilled_groups),</div>
<div class="line">                (scalar keys %filled_groups),</div>
<div class="line">                $target_label_count,</div>
<div class="line">                $target_group_count,</div>
<div class="line">                $swap_count,</div>
<div class="line">                $last_filled;</div>
<div class="line"></div>
<div class="line">        my $progress_i = scalar keys %filled_groups;</div>
<div class="line">        my $progress = $progress_i / $total_to_do;</div>
<div class="line">        $progress_bar-&gt;update (</div>
<div class="line">            <span class="stringliteral">&quot;Swapping labels to reach richness targets\n&quot;</span></div>
<div class="line">            . <span class="stringliteral">&quot;$progress_text\n&quot;</span></div>
<div class="line">            . $check_text,</div>
<div class="line">            $progress,</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ($target_label_count == 0) {</div>
<div class="line"><span class="preprocessor">            #  we ran out of labels before richness criterion is met,</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">            #  eg if multiplier is &gt;1.</span></div>
<div class="line"><span class="preprocessor"></span>            print <span class="stringliteral">&quot;[Randomise structured] No more Labels to assign\n&quot;</span>;</div>
<div class="line">            last BY_UNFILLED_GP;  </div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  select an unassigned label and group pair</span></div>
<div class="line"><span class="preprocessor"></span>        my @labels = sort $cloned_bd-&gt;get_labels;</div>
<div class="line">        my $i = <span class="keywordtype">int</span> $rand-&gt;rand (scalar @labels);</div>
<div class="line">        my $add_label = $labels[$i];</div>
<div class="line">        my %from_groups_hash = $cloned_bd-&gt;get_groups_with_label_as_hash (</div>
<div class="line">            label =&gt; $add_label,</div>
<div class="line">        );</div>
<div class="line">        my @from_groups_array = sort keys %from_groups_hash;</div>
<div class="line"></div>
<div class="line">        $i = int ($rand-&gt;rand (scalar @from_groups_array));</div>
<div class="line"></div>
<div class="line">        my $from_group = $from_groups_array[$i];</div>
<div class="line">        my $add_count  = $from_groups_hash{$from_group};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  clear the pair out of cloned_self</span></div>
<div class="line"><span class="preprocessor"></span>        $cloned_bd-&gt;delete_sub_element (</div>
<div class="line">            group =&gt; $from_group,</div>
<div class="line">            label =&gt; $add_label,</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  Now add this label to a group that does not already contain it.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  Ideally we want to find a group that has not yet</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  hit its richness target, but that is unlikely wo we don&#39;t look anymore.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  Instead we select one at random.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  This also avoids the overhead of sorting and</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  shuffling lists many times.</span></div>
<div class="line"><span class="preprocessor"></span>        my @target_groups</div>
<div class="line">            = sort $new_bd-&gt;get_groups_without_label (label =&gt; $add_label);</div>
<div class="line">        $i = <span class="keywordtype">int</span> $rand-&gt;rand(scalar @target_groups);</div>
<div class="line">        my $target_group = $target_groups[$i];</div>
<div class="line">        my $target_gp_richness</div>
<div class="line">            = $new_bd-&gt;get_richness (element =&gt; $target_group);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #  If the target group is at its richness threshold then</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  we must first remove one label.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  Get a list of labels in this group and select one to remove.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  Preferably remove one that can be put into the unfilled groups.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #  (Should move this to its own sub).</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> ($target_gp_richness &gt;= $target_richness{$target_group})  {</div>
<div class="line"><span class="preprocessor">            #  candidates to swap out are ideally</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">            #  those not in the unfilled groups</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">            #  (Do we want this?)</span></div>
<div class="line"><span class="preprocessor"></span>            my %labels_in_unfilled;</div>
<div class="line">            <span class="keywordflow">foreach</span> my $gp (keys %unfilled_groups) {</div>
<div class="line">                my @list = $new_bd-&gt;get_labels_in_group (group =&gt; $gp);</div>
<div class="line">                @labels_in_unfilled{@list} = undef;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  we will remove one of these labels</span></div>
<div class="line"><span class="preprocessor"></span>            my %loser_labels = $new_bd-&gt;get_labels_in_group_as_hash (</div>
<div class="line">                group =&gt; $target_group,</div>
<div class="line">            );</div>
<div class="line">            my %loser_labels2 = %loser_labels;  #  keep a copy</div>
<div class="line"><span class="preprocessor">            #  get those not in the unfilled groups</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keyword">delete</span> @loser_labels{keys %labels_in_unfilled};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  use the lot if all labels are in the unfilled groups</span></div>
<div class="line"><span class="preprocessor"></span>            my $loser_labels_hash_to_use = ! scalar keys %loser_labels</div>
<div class="line">                                            ? \%loser_labels2</div>
<div class="line">                                            : \%loser_labels;</div>
<div class="line"></div>
<div class="line">            my $loser_labels_array</div>
<div class="line">                = $rand-&gt;shuffle ([sort keys %$loser_labels_hash_to_use]);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  now we loop over the labels and choose the first one that</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">            #  can be placed in an unfilled group,</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">            #  otherwise just take the first one</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">            #  set some defaults</span></div>
<div class="line"><span class="preprocessor"></span>            my $remove_label  = $loser_labels_array-&gt;[0];</div>
<div class="line">            my $removed_count = $loser_labels_hash_to_use-&gt;{$remove_label};</div>
<div class="line">            my $swap_to_unfilled = undef;</div>
<div class="line"></div>
<div class="line">            BY_LOSER_LABEL:</div>
<div class="line">            <span class="keywordflow">foreach</span> my $label (@$loser_labels_array) {</div>
<div class="line"><span class="preprocessor">                #  find those unfilled groups without this label</span></div>
<div class="line"><span class="preprocessor"></span>                my %check_hash = $new_bd-&gt;get_groups_without_label_as_hash (</div>
<div class="line">                    label =&gt; $label,</div>
<div class="line">                );</div>
<div class="line"></div>
<div class="line">                <span class="keyword">delete</span> @check_hash{keys %filled_groups};</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (scalar keys %check_hash) {</div>
<div class="line">                    $remove_label  = $label;</div>
<div class="line">                    $removed_count = $loser_labels_hash_to_use-&gt;{$remove_label};</div>
<div class="line">                    $swap_to_unfilled = $label;</div>
<div class="line">                    last BY_LOSER_LABEL;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">            #  Remove it from new_bd and add it to an unfilled group</span></div>
<div class="line"><span class="preprocessor"></span>            $new_bd-&gt;delete_sub_element (</div>
<div class="line">                label =&gt; $remove_label,</div>
<div class="line">                group =&gt; $target_group,</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (! $swap_to_unfilled) {</div>
<div class="line"><span class="preprocessor">                #  We can&#39;t swap it, so put it back into the</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">                #  unallocated lists.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">                #  Use one of its old locations.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">                #  (Just use the first one).</span></div>
<div class="line"><span class="preprocessor"></span>                my %old_groups</div>
<div class="line">                    = $bd-&gt;get_groups_with_label_as_hash (</div>
<div class="line">                        label =&gt; $remove_label,</div>
<div class="line">                    );</div>
<div class="line"></div>
<div class="line">                my @cloned_self_gps_with_label</div>
<div class="line">                    = $cloned_bd-&gt;get_groups_with_label_as_hash (</div>
<div class="line">                        label =&gt; $remove_label,</div>
<div class="line">                    );</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">                #  make sure it does not add to an existing case</span></div>
<div class="line"><span class="preprocessor"></span>                <span class="keyword">delete</span> @old_groups{@cloned_self_gps_with_label}; </div>
<div class="line">                my @old_gps = sort keys %old_groups;</div>
<div class="line">                my $old_gp = shift @old_gps;</div>
<div class="line">                $cloned_bd-&gt;add_element   (</div>
<div class="line">                    label =&gt; $remove_label,</div>
<div class="line">                    group =&gt; $old_gp,</div>
<div class="line">                    count =&gt; $removed_count,</div>
<div class="line">                );</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">                #  get a list of unfilled candidates to move it to</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">                #  do this by removing those that have the label</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">                #  from the list of unfilled groups</span></div>
<div class="line"><span class="preprocessor"></span>                my $gps_with_label = $new_bd-&gt;get_groups_with_label (</div>
<div class="line">                    label =&gt; $remove_label,</div>
<div class="line">                )</div>
<div class="line">                || [];</div>
<div class="line"></div>
<div class="line">                my %unfilled_tmp = %unfilled_groups;</div>
<div class="line">                <span class="keyword">delete</span> @unfilled_tmp{@$gps_with_label};</div>
<div class="line"></div>
<div class="line">                croak <span class="stringliteral">&quot;ISSUES WITH RETURN GROUPS\n&quot;</span></div>
<div class="line">                    <span class="keywordflow">if</span> (scalar keys %unfilled_tmp == 0);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">                #  and get one of them at random</span></div>
<div class="line"><span class="preprocessor"></span>                $i = <span class="keywordtype">int</span> $rand-&gt;rand (scalar keys %unfilled_tmp);</div>
<div class="line">                my @tmp = sort keys %unfilled_tmp;</div>
<div class="line">                my $return_gp = $tmp[$i];</div>
<div class="line"></div>
<div class="line">                $new_bd-&gt;add_element   (</div>
<div class="line">                    label =&gt; $remove_label,</div>
<div class="line">                    group =&gt; $return_gp,</div>
<div class="line">                    count =&gt; $removed_count</div>
<div class="line">                );</div>
<div class="line"></div>
<div class="line">                my $new_richness = $new_bd-&gt;get_richness (</div>
<div class="line">                    element =&gt; $return_gp,</div>
<div class="line">                );</div>
<div class="line"></div>
<div class="line">                warn <span class="stringliteral">&quot;ISSUES WITH RETURN $return_gp\n&quot;</span></div>
<div class="line">                    <span class="keywordflow">if</span> $new_richness &gt; $target_richness{$return_gp};</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> ($new_richness &gt;= $target_richness{$return_gp}) {</div>
<div class="line">                    $filled_groups{$return_gp} = $new_richness;</div>
<div class="line">                    <span class="keyword">delete</span> $unfilled_groups{$return_gp};  #  no effect <span class="keywordflow">if</span> it<span class="stringliteral">&#39;s not in the list</span></div>
<div class="line"><span class="stringliteral">                    $last_filled = $return_gp;</span></div>
<div class="line"><span class="stringliteral">                }</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            $swap_count ++;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">            if (($swap_count % 500) == 0) {</span></div>
<div class="line"><span class="stringliteral">                print &quot;Swap count $swap_count\n&quot;;</span></div>
<div class="line"><span class="stringliteral">            }</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  add the new label to new_bd</span></div>
<div class="line"><span class="stringliteral">        #print &quot;A: $add_label, $target_group, $add_count\n&quot;;</span></div>
<div class="line"><span class="stringliteral">        $new_bd-&gt;add_element (</span></div>
<div class="line"><span class="stringliteral">            label =&gt; $add_label,</span></div>
<div class="line"><span class="stringliteral">            group =&gt; $target_group,</span></div>
<div class="line"><span class="stringliteral">            count =&gt; $add_count,</span></div>
<div class="line"><span class="stringliteral">        );</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">        #  check if we&#39;</span>ve filled <span class="keyword">this</span> group, <span class="keywordflow">if</span> nothing was swapped out</div>
<div class="line">        my $new_richness = $new_bd-&gt;get_richness (element =&gt; $target_group);</div>
<div class="line"></div>
<div class="line">        warn <span class="stringliteral">&quot;ISSUES WITH TARGET $target_group\n&quot;</span></div>
<div class="line">            <span class="keywordflow">if</span> $new_richness &gt; $target_richness{$target_group};</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ($target_gp_richness != $new_richness</div>
<div class="line">            and $new_richness &gt;= $target_richness{$target_group}) {</div>
<div class="line">            $filled_groups{$target_group} = $new_richness;</div>
<div class="line">            <span class="keyword">delete</span> $unfilled_groups{$target_group};  #  no effect <span class="keywordflow">if</span> it<span class="stringliteral">&#39;s not in the list</span></div>
<div class="line"><span class="stringliteral">            $last_filled = $target_group;</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    print &quot;[Randomise structured] Final swap count is $swap_count\n&quot;;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    return;</span></div>
<div class="line"><span class="stringliteral">}</span></div>
</div><!-- fragment --> 
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>lib/Biodiverse/<a class="el" href="Randomise_8pm_source.html">Randomise.pm</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>Biodiverse</b></li><li class="navelem"><a class="el" href="classBiodiverse_1_1Randomise.html">Randomise</a></li>
    <li class="footer">Generated on Tue Nov 5 2013 19:07:26 for Biodiverse by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
