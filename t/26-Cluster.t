#!/usr/bin/perl -w
#
#  tests for both normal and lowmem matrices, where they overlap in methods

require 5.010;
use strict;
use warnings;

use FindBin qw/$Bin/;
use rlib;

use Test::More;

use English qw / -no_match_vars /;
local $| = 1;

use Data::Section::Simple qw(get_data_section);

use Test::More; # tests => 2;
use Test::Exception;

use Biodiverse::TestHelpers qw /:basedata/;
use Biodiverse::Cluster;

my $default_prng_seed = 2345;

#  do we get a stable cluster result?
{
    my $bd = get_basedata_object_from_site_data(CELL_SIZES => [100000, 100000]);
    my $cl1 = $bd->add_cluster_output (name => 'cl1');
    $cl1->run_analysis (
        prng_seed => $default_prng_seed,
    );

    my $nwk = $cl1->to_newick;
    my $comp_nwk = get_site_data_newick_tree();
    
    is ($nwk, $comp_nwk, 'Generated correct cluster tree');
    
}


#  make sure we get the same result with the same prng across two runs
{
    my $data = get_cluster_mini_data();
    my $bd = get_basedata_object (data => $data, CELL_SIZES => [1,1]);
    
    check_order_is_same_given_same_prng (basedata_ref => $bd);
    
    my $site_bd = get_basedata_object_from_site_data(CELL_SIZES => [100000, 100000]);
    check_order_is_same_given_same_prng (basedata_ref => $site_bd);
    
}


sub check_order_is_same_given_same_prng {
    my %args = @_;
    my $bd = $args{basedata_ref};
    
    my $prng_seed = $args{prng_seed} || $default_prng_seed;
    
    my $cl1 = $bd->add_cluster_output (name => 'cl1');
    my $cl2 = $bd->add_cluster_output (name => 'cl2');
    my $cl3 = $bd->add_cluster_output (name => 'cl3');
    
    $cl1->run_analysis (
        prng_seed => $prng_seed,
    );
    $cl2->run_analysis (
        prng_seed => $prng_seed,
    );
    $cl3->run_analysis (
        prng_seed => $prng_seed + 1,  #  different prng
    );
    
    my $newick1 = $cl1->to_newick;
    my $newick2 = $cl2->to_newick;
    my $newick3 = $cl3->to_newick;
    
    is   ($newick1, $newick2, 'trees are the same');
    isnt ($newick1, $newick3, 'trees are not the same');
}


done_testing();


######################################

sub get_cluster_mini_data {
    my $data = get_data_section('CLUSTER_MINI_DATA');
    $data =~ s/(?<!\w)\n+\z//m;  #  clear trailing newlines
    return $data;
}

sub get_cluster_mini_data_newick {
    return q{((('2.5:1.5':0,'3.5:1.5':0,'3.5:2.5':0)'3___':0.2,('1.5:1.5':0,'1.5:2.5':0,'2.5:2.5':0)'2___':0.2)'4___':0)'5___':0}
}

sub get_site_data_newick_tree {
    my $data = get_data_section('SITE_DATA_NEWICK_TREE');
    $data =~ s/\n+\z//m;  #  clear all trailing newlines
    return $data;
}



1;

__DATA__

@@ CLUSTER_MINI_DATA
label,x,y,samples
a,1,1,1
b,1,1,1
c,1,1,1
a,1,2,1
b,1,2,1
c,1,2,1
a,2,1,1
b,2,1,1
a,2,2,1
b,2,2,1
c,2,2,1
a,3,1,1
b,3,1,1
a,3,2,1
b,3,2,1


@@ SITE_DATA_NEWICK_TREE
((((((('3250000:950000':0.333333333333333,'3350000:950000':0.333333333333333)'75___':0.083333333333334,'3350000:850000':0.416666666666667)'93___':0.203703703703703,'3250000:750000':0.62037037037037)'109___':0.168342013736751,(((((('3350000:1150000':0,'3450000:1350000':0,'3550000:1550000':0,'3350000:1050000':0,'3350000:1250000':0,'3450000:1550000':0,'3350000:1350000':0,'3450000:1450000':0)'38___':0.333333333333333,'3550000:1450000':0.333333333333333)'84___':0.018518518518519,('3450000:1250000':0,'3550000:1250000':0)'4___':0.351851851851852)'85___':0.101178451178451,('3650000:1650000':0.2,'3650000:1750000':0.2)'60___':0.253030303030303)'97___':0.090559440559441,'3550000:1950000':0.543589743589744)'105___':0.025367172510029,((('3650000:1450000':0,'3650000:1550000':0)'31___':0.2,'3450000:1050000':0.2)'61___':0.22989417989418,('3650000:1350000':0.2,'3750000:1450000':0.2)'58___':0.22989417989418)'95___':0.139062736205593)'107___':0.219755468007348)'118___':0.139519699240052,((((('3350000:2050000':0,'3450000:2150000':0,'3250000:2850000':0,'3550000:2150000':0)'23___':0.333333333333333,'3750000:1750000':0.333333333333333)'74___':0.116666666666667,(('3550000:2050000':0.142857142857143,'3550000:2250000':0.142857142857143)'50___':0.123809523809524,('3350000:2150000':0,'3450000:2050000':0)'35___':0.266666666666667)'67___':0.183333333333333)'96___':0.24389770723104,(((('3650000:1950000':0.111111111111111,'3650000:2050000':0.111111111111111)'43___':0.044444444444445,'3750000:2050000':0.155555555555556)'52___':0.222222222222222,'3750000:1950000':0.377777777777778)'88___':0.026984126984127,'3650000:1850000':0.404761904761905)'91___':0.289135802469135)'113___':0.056669186192996,(('3150000:2950000':0,'3250000:2150000':0)'11___':0.333333333333333,'3250000:2950000':0.333333333333333)'73___':0.417233560090703)'116___':0.177665189923137)'124___':0.0349067652113,(((((((((('3550000:950000':0.25,'3650000:1150000':0.25)'65___':0.179292929292929,(('3450000:950000':0.125,'3550000:1050000':0.125)'46___':0.075,'3550000:1150000':0.2)'56___':0.229292929292929)'94___':0.088638028638029,('3450000:1150000':0.25,'3450000:850000':0.25)'66___':0.267930957930958)'103___':0.11516095016095,('3750000:1350000':0.333333333333333,'3850000:1650000':0.333333333333333)'77___':0.299758574758575)'110___':0.026499734833068,'3750000:1550000':0.659591642924976)'112___':0.0511392899791321,((((('3350000:750000':0.333333333333333,'3450000:750000':0.333333333333333)'76___':0.067969816131581,((('2950000:650000':0.0909090909090909,'3050000:650000':0.0909090909090909)'42___':0.107808857808858,'3050000:750000':0.198717948717949)'54___':0.06996891996892,('3150000:650000':0,'2850000:750000':0,'2950000:750000':0)'41___':0.268686868686869)'69___':0.132616280778045)'90___':0.09259184443008,'2750000:750000':0.493894993894994)'101___':0.018452781786115,(((((('3050000:150000':0,'2850000:650000':0,'3150000:50000':0,'3050000:350000':0,'3250000:150000':0)'27___':0.142857142857143,'3150000:350000':0.142857142857143)'49___':0.079365079365079,('3050000:50000':0,'3250000:450000':0)'12___':0.222222222222222)'62___':0.01765873015873,(('3150000:150000':0,'3150000:250000':0)'16___':0.142857142857143,'3250000:250000':0.142857142857143)'47___':0.097023809523809)'63___':0.087391774891775,'3250000:350000':0.327272727272727)'72___':0.051034151034151,(('2750000:650000':0,'3050000:550000':0)'32___':0.2,'2650000:650000':0.2)'57___':0.178306878306878)'89___':0.134040897374231)'102___':0.066874027647837,((('3250000:650000':0.142857142857143,'3350000:650000':0.142857142857143)'51___':0.123809523809524,'3450000:650000':0.266666666666667)'68___':0.211111111111111,('2950000:50000':0,'3150000:550000':0,'2550000:1050000':0,'2950000:350000':0)'33___':0.477777777777778)'98___':0.101444025551168)'108___':0.131509129575162)'115___':0.041036540814585,('2550000:750000':0,'2650000:750000':0)'34___':0.751767473718693)'117___':0.11152147677956,((('3050000:850000':0.2,'3250000:850000':0.2)'59___':0.208333333333333,('3150000:750000':0.2,'3150000:850000':0.2)'55___':0.208333333333333)'92___':0.3,('2950000:250000':0,'3050000:250000':0)'14___':0.708333333333333)'114___':0.15495561716492)'121___':0.028471207333334,(((((((('2450000:1050000':0.142857142857143,'2550000:950000':0.142857142857143)'48___':0.053571428571428,'2450000:1150000':0.196428571428571)'53___':0.048280423280424,(('2350000:950000':0,'2450000:950000':0)'1___':0.111111111111111,'2250000:950000':0.111111111111111)'45___':0.133597883597884)'64___':0.082275132275132,('2550000:850000':0,'2650000:950000':0,'2450000:1250000':0,'2150000:1150000':0,'2650000:850000':0)'40___':0.326984126984127)'71___':0.03015873015873,'2750000:850000':0.357142857142857)'86___':0.129563492063492,(('2250000:1050000':0,'2350000:1250000':0,'2750000:950000':0)'37___':0.333333333333333,'2350000:1050000':0.333333333333333)'79___':0.153373015873016)'100___':0.149305555555556,(('2150000:1050000':0,'2350000:1150000':0)'36___':0.333333333333333,'2250000:1250000':0.333333333333333)'81___':0.302678571428572)'111___':0.161080827067669,(('1950000:1450000':0,'1950000:1350000':0,'2050000:1350000':0)'39___':0.333333333333333,('2050000:1250000':0,'2150000:1250000':0)'7___':0.333333333333333)'78___':0.463759398496241)'119___':0.0946674260020131)'122___':0.033730189503183,((((((('3750000:1850000':0,'3850000:1350000':0,'3950000:1750000':0)'13___':0.333333333333333,'3650000:1250000':0.333333333333333)'82___':0.041666666666667,'3750000:1250000':0.375)'87___':0.105,('3850000:1850000':0.333333333333333,'3850000:1950000':0.333333333333333)'80___':0.146666666666667)'99___':0.05265306122449,'3750000:1650000':0.53265306122449)'104___':0.034840325018896,(('3850000:1450000':0.111111111111111,'3850000:1750000':0.111111111111111)'44___':0.180555555555556,'3850000:1550000':0.291666666666667)'70___':0.275826719576719)'106___':0.235392616642617,(('3250000:3050000':0,'3650000:2350000':0)'2___':0.333333333333333,'3750000:2150000':0.333333333333333)'83___':0.46955266955267)'120___':0.122604344448767)'123___':0.037648501223703)'125___':0)'126___':0
